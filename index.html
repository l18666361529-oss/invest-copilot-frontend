<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æŠ•èµ„å‰¯é©¾é©¶ v1ï¼ˆä¸“ä¸šç‰ˆï¼‰</title>
  <style>
    :root{--bg:#0b1220;--card:#0f1a33;--line:#1f2a44;--txt:#e6edf7;--mut:#9fb0d0;--ok:#30d158;--bad:#ff453a;--btn:#2f6bff;}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
    header{padding:14px 16px;background:#061027;border-bottom:1px solid var(--line);font-weight:700}
    .wrap{padding:14px;max-width:1100px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
    h3{margin:0 0 10px;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,textarea{background:#07122b;color:var(--txt);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:15px;flex:1;min-width:140px}
    textarea{min-height:110px}
    button{background:var(--btn);border:none;color:#fff;border-radius:10px;padding:10px 12px;font-weight:700;font-size:14px;cursor:pointer}
    button.secondary{background:#13224a;border:1px solid var(--line);color:var(--txt)}
    button.danger{background:#3a1020;border:1px solid #6a2233}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:center;vertical-align:top}
    .mut{color:var(--mut)}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--mut);font-size:12px}
    .small{font-size:12px;line-height:1.25}
    .split{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:300px}
    .newsItem{padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:8px;background:#0a1430}
    .newsItem a{color:#bcd1ff;text-decoration:none}
    .newsItem a:hover{text-decoration:underline}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:880px){ .grid2{grid-template-columns:1fr;} }
    .kv{display:flex;gap:10px;flex-wrap:wrap}
    .k{padding:10px;border:1px solid var(--line);border-radius:12px;background:#0a1430;flex:1;min-width:210px}
    .k .v{font-size:20px;font-weight:800;margin-top:6px}
    .list{margin-top:10px}
    .li{padding:10px;border:1px solid var(--line);border-radius:12px;background:#0a1430;margin-top:8px}
    .tag{display:inline-block;margin-left:8px;font-size:12px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--mut)}
    .warn{color:#ffd60a}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* Modal */
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:99}
    .modal{width:min(820px,100%);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .modal h4{margin:0 0 10px}
    .modal .row{margin-top:10px}
    .modal .footer{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
  </style>
</head>
<body>
<header>ğŸ“ˆ æŠ•èµ„å‰¯é©¾é©¶ v1ï¼ˆä¸“ä¸šç‰ˆï¼‰</header>
<div class="wrap">

  <div class="card">
    <h3>â‘  åç«¯åœ°å€ï¼ˆå·²é»˜è®¤å¡«å¥½ï¼‰</h3>
    <div class="row">
      <input id="backend" placeholder="ä¾‹å¦‚ï¼šhttps://xxx.onrender.com" />
      <button class="secondary" onclick="saveBackend()">ä¿å­˜</button>
      <button class="secondary" onclick="ping()">æµ‹è¯•</button>
    </div>
    <div class="mut" id="pingResult" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <h3>â‘¡ æ·»åŠ æŒä»“</h3>
    <div class="row">
      <select id="type">
        <option value="CN_FUND">å›½å†…åŸºé‡‘ï¼ˆ6ä½ï¼‰</option>
        <option value="US_TICKER">æµ·å¤–æ ‡çš„ï¼ˆTickerï¼‰</option>
      </select>
      <input id="code" placeholder="åŸºé‡‘ä»£ç /Tickerï¼š025167 / SPY" />
      <input id="amount" type="number" placeholder="æŒæœ‰é‡‘é¢ï¼ˆå…ƒæˆ–ç¾å…ƒï¼‰" />
      <input id="cost" type="number" placeholder="æˆæœ¬å‡€å€¼/æˆæœ¬ä»·ï¼ˆå¯é€‰ï¼‰" />
      <button onclick="add()">æ·»åŠ </button>
    </div>

    <div class="row" style="margin-top:10px;">
      <button onclick="refreshAll()">ğŸ”„ åˆ·æ–°çœŸå®ä»·æ ¼å¹¶è®¡ç®—ç›ˆäº</button>
      <button class="secondary" onclick="clearAll()">æ¸…ç©º</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ç±»å‹</th><th>ä»£ç </th><th>åç§°</th><th>ç°ä»·</th><th>å¸‚å€¼</th><th>ç›ˆäº</th><th>ç›ˆäºç‡</th><th>ä»“ä½</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>

    <div class="mut" id="sum" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3>â‘¢ æ–°é—»ä¸æ”¿ç­–ï¼ˆè‡ªåŠ¨éšæŒä»“å˜åŒ–ï¼‰</h3>

    <div class="split">
      <div class="col">
        <div class="row">
          <button class="secondary" onclick="buildNewsPlan()">ğŸ§  è‡ªåŠ¨ç”Ÿæˆå…³é”®è¯</button>
          <button onclick="fetchNews()">ğŸ— æŠ“å–æ–°é—»</button>
        </div>
        <div class="mut small" style="margin-top:8px;">
          å…³é”®è¯æ¥è‡ªä¸‰å±‚ï¼šA å®è§‚å›ºå®š + B è¡Œä¸šä¸»é¢˜ï¼ˆè‡ªåŠ¨ï¼‰ + C æ ‡çš„å¼ºç›¸å…³ï¼ˆè‡ªåŠ¨ï¼‰ã€‚ä½ æ¢ä»“åå†æ¬¡ç‚¹â€œè‡ªåŠ¨ç”Ÿæˆå…³é”®è¯â€å³å¯æ›´æ–°ã€‚
        </div>

        <div style="margin-top:10px;">
          <div class="mut">å½“å‰ä¸»é¢˜ï¼ˆè‡ªåŠ¨ï¼‰ï¼š</div>
          <div id="themes" class="small"></div>
        </div>

        <div style="margin-top:10px;">
          <div class="mut">å…³é”®è¯æ± ï¼ˆå¯æ‰‹åŠ¨å¢åˆ ï¼Œç”¨é€—å·åˆ†éš”ï¼‰ï¼š</div>
          <input id="newsKeywords" placeholder="ä¾‹å¦‚ï¼šç¾è”å‚¨,é™æ¯,AI,åŠå¯¼ä½“,åŒ»è¯,åŒ»ä¿,æ¸¯è‚¡ç§‘æŠ€..." />
          <div class="row" style="margin-top:8px;">
            <button class="secondary" onclick="saveNewsKeywords()">ä¿å­˜å…³é”®è¯</button>
            <button class="secondary" onclick="resetNewsKeywords()">é‡ç½®ä¸ºè‡ªåŠ¨å…³é”®è¯</button>
          </div>
          <div class="mut small" style="margin-top:8px;">
            æé†’ï¼šæ–°é—»ä¸éœ€è¦ AI Keyã€‚AI Key ä»…ç”¨äºâ€œAI å†³ç­–â€æŒ‰é’®ã€‚
          </div>
        </div>
      </div>

      <div class="col">
        <div class="mut">æ–°é—»åˆ—è¡¨ï¼ˆæœ€è¿‘ï¼‰ï¼š</div>
        <div id="newsList"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>â‘£ AI å†³ç­–ï¼ˆOpenAI-compatible æ–¹å¼ï¼‰</h3>
    <div class="row">
      <input id="aiBase" placeholder="AI BaseUrlï¼Œä¾‹å¦‚ï¼šhttps://api.openai.com/v1 æˆ–ä½ çš„ç½‘å…³ï¼ˆxAI: https://api.x.ai/v1ï¼‰" />
      <input id="aiKey" placeholder="API Keyï¼ˆä»…ä¿å­˜åœ¨æœ¬æœºï¼‰" />
      <input id="aiModel" placeholder="æ¨¡å‹åï¼Œä¾‹å¦‚ï¼šgrok-4-1-fast-reasoning / grok-3 / gemini-xxx" />
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="secondary" onclick="saveAI()">ä¿å­˜AIé…ç½®</button>
      <button onclick="runAI()">ğŸ¤– ä»Šæ—¥åŠ¨ä½œ + 3-6ä¸ªæœˆæ¿å—æ¨èï¼ˆå«é£æ§/æŠ€æœ¯/æ–°é—»ï¼‰</button>
    </div>
    <textarea id="aiOut" placeholder="AI è¾“å‡ºä¼šåœ¨è¿™é‡Œ..."></textarea>
    <div class="mut small">æç¤ºï¼šAI Key ä¸å†™è¿›ä»£ç ï¼›åªå­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ã€‚</div>
  </div>

  <div class="card">
    <h3>â‘¤ é£æ§æ£€æŸ¥ï¼ˆç»„åˆçº¢é»„ç¯ï¼‰</h3>
    <div class="row">
      <button onclick="refreshRisk()">ğŸ›¡ åˆ·æ–°é£æ§æ£€æŸ¥</button>
      <button class="secondary" onclick="refreshRisk(true)">ğŸ›¡ åˆ·æ–°å¹¶å±•å¼€è¯¦æƒ…</button>
    </div>

    <div class="kv" style="margin-top:10px;">
      <div class="k">
        <div class="mut">é£é™©ç­‰çº§</div>
        <div id="riskLevel" class="v">-</div>
      </div>
      <div class="k">
        <div class="mut">å»ºè®®æ€»ä»“ä½</div>
        <div id="riskPos" class="v">-</div>
      </div>
      <div class="k">
        <div class="mut">ä¸»é¢˜é›†ä¸­åº¦ Top1</div>
        <div id="riskTheme" class="v">-</div>
      </div>
    </div>

    <div id="riskList" class="list"></div>
  </div>

  <div class="card">
    <h3>â‘¥ æŠ€æœ¯æŒ‡æ ‡ / è¶‹åŠ¿ï¼ˆæ¯åªæŒä»“ï¼‰</h3>
    <div class="row">
      <button onclick="refreshTA()">ğŸ“Š åˆ·æ–°æŠ€æœ¯æŒ‡æ ‡</button>
      <button class="secondary" onclick="clearTA()">æ¸…ç©ºæŠ€æœ¯ç¼“å­˜</button>
    </div>
    <div class="mut small" style="margin-top:8px;">
      å›½å†…åŸºé‡‘ï¼šä½¿ç”¨ä¸œè´¢å‡€å€¼åºåˆ—è®¡ç®—ï¼ˆæ›´å¹³æ»‘ï¼‰ï¼›æµ·å¤–Tickerï¼šä½¿ç”¨ stooq æ—¥çº¿æ”¶ç›˜è®¡ç®—ã€‚
    </div>
    <div id="taList" class="list"></div>
  </div>

  <div class="card">
    <h3>â‘¦ æ¿å—é›·è¾¾ï¼ˆæå‰å‘ç°ä¸Šå‡è‹—å¤´ï¼‰</h3>
    <div class="row">
      <button onclick="refreshRadar()">ğŸ§­ åˆ·æ–°æ¿å—é›·è¾¾</button>
    </div>
    <div class="mut small" style="margin-top:8px;">
      è¿™æ˜¯â€œå€™é€‰æ¿å—æ± â€è‡ªåŠ¨æ‰“åˆ†çš„ Top3ï¼ˆè¶‹åŠ¿ + åŠ¨é‡ + RSIï¼‰ï¼Œç”¨äºè¾…åŠ©ä½ å‘ç°æœ€è¿‘æœ‰æŠ¬å¤´è¿¹è±¡çš„æ–¹å‘ã€‚
    </div>
    <div id="radarList" class="list"></div>
  </div>

</div>

<!-- Modalï¼šç¼–è¾‘æŒä»“ -->
<div id="mask" class="modalMask" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h4>ç¼–è¾‘æŒä»“</h4>
    <div class="row">
      <select id="mType">
        <option value="CN_FUND">å›½å†…åŸºé‡‘ï¼ˆ6ä½ï¼‰</option>
        <option value="US_TICKER">æµ·å¤–æ ‡çš„ï¼ˆTickerï¼‰</option>
      </select>
      <input id="mCode" placeholder="ä»£ç " />
    </div>
    <div class="row">
      <input id="mAmount" type="number" placeholder="æŒæœ‰é‡‘é¢" />
      <input id="mCost" type="number" placeholder="æˆæœ¬å‡€å€¼/æˆæœ¬ä»·ï¼ˆå¯é€‰ï¼‰" />
    </div>
    <div class="mut small" id="mHint" style="margin-top:8px;"></div>
    <div class="footer">
      <button class="secondary" onclick="closeModal()">å–æ¶ˆ</button>
      <button onclick="saveModal()">ä¿å­˜ä¿®æ”¹</button>
    </div>
  </div>
</div>

<script>
  const LS = {
    backend:"ic_backend",
    pos:"ic_positions",
    ai:"ic_ai",
    newsKeywords:"ic_news_keywords",
    newsPlan:"ic_news_plan",
    newsCache:"ic_news_cache",
    taCache:"ic_ta_cache"
  };
  const $ = (id)=>document.getElementById(id);
  let editingIndex = -1;

  function apiBase() {
    const base = (localStorage.getItem(LS.backend) || $("backend").value || "").trim();
    return base.replace(/\/+$/,"");
  }

  function load() {
    const defaultBackend = "https://invest-copilot-backend.onrender.com";
    const b = localStorage.getItem(LS.backend) || defaultBackend;
    $("backend").value = b;
    localStorage.setItem(LS.backend, b);

    window.positions = JSON.parse(localStorage.getItem(LS.pos) || "[]");

    const ai = JSON.parse(localStorage.getItem(LS.ai) || "{}");
    $("aiBase").value = ai.baseUrl || "";
    $("aiKey").value  = ai.apiKey || "";
    $("aiModel").value= ai.model || "";

    const kw = localStorage.getItem(LS.newsKeywords) || "";
    if (kw) $("newsKeywords").value = kw;

    const plan = JSON.parse(localStorage.getItem(LS.newsPlan) || "null");
    if (plan) renderThemes(plan.themes || []);
    const cache = JSON.parse(localStorage.getItem(LS.newsCache) || "null");
    if (cache) renderNews(cache.items || []);

    render();
    refreshRisk();     // è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡é£æ§
    renderTAFromCache();
    refreshRadar();    // è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡é›·è¾¾
  }

  function persist(){ localStorage.setItem(LS.pos, JSON.stringify(window.positions)); }

  function saveBackend(){
    localStorage.setItem(LS.backend, $("backend").value.trim());
    $("pingResult").textContent = "å·²ä¿å­˜ã€‚";
  }

  async function ping(){
    const base = apiBase();
    if(!base) return alert("å…ˆå¡«å†™åç«¯åœ°å€");
    try{
      const r = await fetch(base + "/health");
      const j = await r.json();
      $("pingResult").textContent = j.ok ? "âœ… åç«¯æœåŠ¡æ­£å¸¸" : "âš ï¸ åç«¯å¼‚å¸¸";
    }catch(e){
      $("pingResult").textContent = "âŒ è¿æ¥å¤±è´¥ï¼š" + e.message;
    }
  }

  function add(){
    const type = $("type").value;
    const code = $("code").value.trim();
    const amount = Number($("amount").value);
    const cost = $("cost").value ? Number($("cost").value) : null;
    if(!code || !amount) return alert("è¯·å¡«ä»£ç  + é‡‘é¢");

    window.positions.push({
      type, code, amount, cost,
      name:"",
      price:null, mv:null, pnl:null, pnlPct:null,
      _nav:null, _navDate:null, _estNav:null, _estPct:null, _time:null,
      theme:null
    });
    persist(); render();
  }

  function clearAll(){
    if(!confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æŒä»“ï¼Ÿ")) return;
    window.positions = [];
    persist(); render();
    clearTA();
    $("riskList").innerHTML = "";
    $("riskLevel").textContent = "-";
    $("riskPos").textContent = "-";
    $("riskTheme").textContent = "-";
  }

  function openEdit(i){
    editingIndex = i;
    const p = window.positions[i];
    $("mType").value = p.type;
    $("mCode").value = p.code;
    $("mAmount").value = p.amount ?? "";
    $("mCost").value = p.cost ?? "";
    $("mHint").textContent = `å½“å‰åç§°ï¼š${p.name || "æœªæ‹‰å–"}ï½œå½“å‰ç°ä»·ï¼š${p.price ?? "æœªæ‹‰å–"}ï½œç›ˆäºç‡ï¼š${p.pnlPct!=null ? p.pnlPct.toFixed(2)+"%" : "æœªè®¡ç®—"}`;
    $("mask").style.display = "flex";
  }

  function closeModal(e){
    if (e && e.target && e.target.id !== "mask") return;
    $("mask").style.display = "none";
    editingIndex = -1;
  }

  function saveModal(){
    if (editingIndex < 0) return;
    const p = window.positions[editingIndex];

    const type = $("mType").value;
    const code = $("mCode").value.trim();
    const amount = Number($("mAmount").value);
    const cost = $("mCost").value ? Number($("mCost").value) : null;

    if(!code || !amount) return alert("è¯·å¡«ä»£ç  + é‡‘é¢");

    p.type = type;
    p.code = code;
    p.amount = amount;
    p.cost = cost;

    // æ¸…æ‰æ—§çš„å®æ—¶å­—æ®µ
    p.name = "";
    p.price = p.mv = p.pnl = p.pnlPct = null;
    p._nav = p._navDate = p._estNav = p._estPct = p._time = null;
    p.theme = null;

    persist(); render();
    closeModal();
  }

  function deleteOne(i){
    const p = window.positions[i];
    if(!confirm(`ç¡®å®šåˆ é™¤ï¼š${p.code} ${p.name || ""} ?`)) return;
    window.positions.splice(i,1);
    persist(); render();
  }

  function render(){
    const tb = $("tb"); tb.innerHTML = "";
    const totalAmount = window.positions.reduce((s,p)=>s + (p.amount||0), 0);
    const totalMV = window.positions.reduce((s,p)=>s + (p.mv||0), 0);
    const totalPNL = window.positions.reduce((s,p)=>s + (p.pnl||0), 0);

    window.positions.forEach((p,i)=>{
      const tr = document.createElement("tr");
      const pnlCls = (p.pnlPct ?? 0) >= 0 ? "ok" : "bad";
      const w = totalMV ? (p.mv||0)/totalMV*100 : 0;

      const priceCell = (p.type === "CN_FUND")
        ? `
          ${p.price ?? "-"}
          <div class="mut small" style="margin-top:2px;">
            å‡€å€¼: ${(typeof p._nav === "number" ? p._nav : "-")}ï¼ˆ${p._navDate || "-"}ï¼‰
            <br/>
            ä¼°å€¼: ${(typeof p._estNav === "number" ? p._estNav : "-")}ï¼ˆ${(typeof p._estPct === "number" ? p._estPct : "-")}%ï¼‰${p._time ? " " + p._time : ""}
          </div>
        `
        : `${p.price ?? "-"}`;

      tr.innerHTML = `
        <td><span class="pill">${p.type}</span></td>
        <td>${p.code}</td>
        <td class="mut">${p.name || "-"}</td>
        <td>${priceCell}</td>
        <td>${p.mv!=null ? p.mv.toFixed(2) : "-"}</td>
        <td class="${pnlCls}">${p.pnl!=null ? p.pnl.toFixed(2) : "-"}</td>
        <td class="${pnlCls}">${p.pnlPct!=null ? p.pnlPct.toFixed(2)+"%" : "-"}</td>
        <td>${(w||0).toFixed(1)}%</td>
        <td>
          <button class="secondary" onclick="openEdit(${i})">ç¼–è¾‘</button>
          <button class="danger" onclick="deleteOne(${i})">åˆ é™¤</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    $("sum").textContent =
      `æŠ•å…¥åˆè®¡ï¼š${totalAmount.toFixed(2)} ï½œ å¸‚å€¼åˆè®¡ï¼š${totalMV.toFixed(2)} ï½œ æ€»ç›ˆäºï¼š${totalPNL.toFixed(2)}`;
  }

  async function refreshAll(){
    const api = apiBase();
    if(!api) return alert("å…ˆå¡«åç«¯åœ°å€");

    // å›½å†…åŸºé‡‘
    for (const p of window.positions){
      if (p.type === "CN_FUND"){
        try{
          const r = await fetch(`${api}/api/cn/fund/${encodeURIComponent(p.code)}`);
          const j = await r.json();
          p.name = j.name || p.name;
          p.price = (typeof j.nav === "number" && j.nav > 0) ? j.nav : j.estNav;
          p._nav = (typeof j.nav === "number") ? j.nav : null;
          p._navDate = j.navDate || null;
          p._estNav = (typeof j.estNav === "number") ? j.estNav : null;
          p._estPct = (typeof j.estPct === "number") ? j.estPct : null;
          p._time = j.time || null;
        }catch(e){
          console.warn("cn fund fetch failed", p.code, e);
        }
      }
    }

    // æµ·å¤–æ‰¹é‡
    const gl = window.positions.filter(p=>p.type==="US_TICKER");
    if (gl.length){
      const symbols = gl.map(p=>p.code).join(",");
      try{
        const r = await fetch(`${api}/api/gl/quote?symbols=${encodeURIComponent(symbols)}`);
        const j = await r.json();
        const map = new Map((j.quotes||[]).map(q=>[q.symbol, q]));
        for (const p of gl){
          const q = map.get(p.code.toUpperCase());
          if(q){
            p.name = q.name || p.name;
            p.price = q.price;
          }
        }
      }catch(e){
        console.warn("gl quote fetch failed", e);
      }
    }

    // è®¡ç®—å¸‚å€¼/ç›ˆäºï¼ˆé‡‘é¢ä¼°ç®—ä»½é¢ï¼‰
    for (const p of window.positions){
      if (typeof p.price === "number" && p.price > 0){
        const baseCost = (typeof p.cost === "number" && p.cost > 0) ? p.cost : p.price;
        const shares = p.amount / baseCost;
        p.mv = shares * p.price;
        p.pnl = p.mv - p.amount;
        p.pnlPct = (p.pnl / p.amount) * 100;
      } else {
        p.mv = p.pnl = p.pnlPct = null;
      }
    }

    persist(); render();
    await refreshRisk();   // åˆ·å®Œä»·æ ¼ååˆ·æ–°é£æ§
  }

  // ---------- NEWS ----------
  function renderThemes(themes){
    $("themes").textContent = themes && themes.length ? themes.join(" / ") : "ï¼ˆå°šæœªç”Ÿæˆï¼‰";
  }

  async function buildNewsPlan(){
    const api = apiBase();
    if(!api) return alert("å…ˆå¡«åç«¯åœ°å€");

    const payload = window.positions.map(p=>({
      type:p.type, code:p.code, name:p.name, amount:p.amount, mv:p.mv
    }));

    const r = await fetch(`${api}/api/news/plan`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ positions: payload })
    });
    const j = await r.json();
    if (!j.ok) return alert("ç”Ÿæˆå…³é”®è¯å¤±è´¥ï¼š" + (j.error || ""));

    localStorage.setItem(LS.newsPlan, JSON.stringify(j));
    renderThemes(j.themes || []);

    const kw = (j.keywords || []).join(",");
    $("newsKeywords").value = kw;
    localStorage.setItem(LS.newsKeywords, kw);
    alert("âœ… å·²ç”Ÿæˆè‡ªåŠ¨å…³é”®è¯ï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹åå†æŠ“æ–°é—»ï¼‰");
  }

  function saveNewsKeywords(){
    const kw = $("newsKeywords").value.trim();
    localStorage.setItem(LS.newsKeywords, kw);
    alert("âœ… å…³é”®è¯å·²ä¿å­˜");
  }

  function resetNewsKeywords(){
    const plan = JSON.parse(localStorage.getItem(LS.newsPlan) || "null");
    if (!plan) return alert("å…ˆç‚¹â€œè‡ªåŠ¨ç”Ÿæˆå…³é”®è¯â€");
    const kw = (plan.keywords || []).join(",");
    $("newsKeywords").value = kw;
    localStorage.setItem(LS.newsKeywords, kw);
  }

  function renderNews(items){
    const box = $("newsList");
    box.innerHTML = "";
    if (!items || !items.length) {
      box.innerHTML = `<div class="mut small">æš‚æ— æ–°é—»ã€‚å…ˆç”Ÿæˆå…³é”®è¯ï¼Œå†æŠ“å–æ–°é—»ã€‚</div>`;
      return;
    }
    for (const it of items) {
      const s = (it.sentiment || "neutral");
      const tag = s==="bullish" ? `<span class="tag ok">åˆ©å¥½</span>` : s==="bearish" ? `<span class="tag bad">åˆ©ç©º</span>` : `<span class="tag">ä¸­æ€§</span>`;
      const th = (it.themes && it.themes.length) ? `<span class="tag">${it.themes.join("/")}</span>` : "";
      const score = (typeof it.score==="number") ? `<span class="tag mono">score:${it.score}</span>` : "";
      const div = document.createElement("div");
      div.className = "newsItem";
      div.innerHTML = `
        <div class="small">
          <span class="pill">${it.keyword || "-"}</span>
          <span class="mut"> ${it.pubDate || ""}</span>
          ${tag} ${th} ${score}
        </div>
        <div style="margin-top:6px;"><a href="${it.link}" target="_blank" rel="noreferrer">${it.title}</a></div>
        <div class="mut small" style="margin-top:6px;">${(it.description || "").slice(0, 180)}</div>
      `;
      box.appendChild(div);
    }
  }

  async function fetchNews(){
    const api = apiBase();
    if(!api) return alert("å…ˆå¡«åç«¯åœ°å€");

    const kw = (localStorage.getItem(LS.newsKeywords) || $("newsKeywords").value || "").trim();
    if (!kw) return alert("å…ˆç”Ÿæˆæˆ–å¡«å†™å…³é”®è¯");

    $("newsList").innerHTML = `<div class="mut small">æŠ“å–ä¸­â€¦ï¼ˆç¬¬ä¸€æ¬¡å¯èƒ½æ…¢ä¸€ç‚¹ï¼‰</div>`;

    const plan = JSON.parse(localStorage.getItem(LS.newsPlan) || "null");
    const weights = plan && plan.weights ? encodeURIComponent(JSON.stringify(plan.weights)) : "";

    const url = `${api}/api/news/rss?keywords=${encodeURIComponent(kw)}&limit=12&minScore=2${weights?`&weights=${weights}`:""}`;
    const r = await fetch(url);
    const j = await r.json();
    if (!j.ok) return alert("æŠ“å–æ–°é—»å¤±è´¥ï¼š" + (j.error || ""));

    localStorage.setItem(LS.newsCache, JSON.stringify(j));
    renderNews(j.items || []);
  }

  // ---------- AI ----------
  function saveAI(){
    const cfg = { baseUrl:$("aiBase").value.trim(), apiKey:$("aiKey").value.trim(), model:$("aiModel").value.trim() };
    localStorage.setItem(LS.ai, JSON.stringify(cfg));
    $("aiOut").value = "âœ… AI é…ç½®å·²ä¿å­˜ï¼ˆä»…æœ¬æœºï¼‰ã€‚";
  }

  async function runAI(){
    const api = apiBase();
    if(!api) return alert("å…ˆå¡«åç«¯åœ°å€");

    const cfg = JSON.parse(localStorage.getItem(LS.ai) || "{}");
    if(!cfg.baseUrl || !cfg.apiKey || !cfg.model) return alert("å…ˆå¡«å†™ AI BaseUrl / Key / Model å¹¶ä¿å­˜");

    const holdings = window.positions.map(p=>({
      type:p.type, code:p.code, name:p.name, amount:p.amount, cost:p.cost,
      price:p.price, mv:p.mv, pnl:p.pnl, pnlPct:p.pnlPct,
      nav:p._nav, navDate:p._navDate, estNav:p._estNav, estPct:p._estPct, time:p._time,
      theme:p.theme
    }));

    const newsCache = JSON.parse(localStorage.getItem(LS.newsCache) || "null");
    const newsItems = (newsCache && newsCache.items) ? newsCache.items : [];

    // å–é£æ§
    let risk = null;
    try{
      const rr = await fetch(`${api}/api/risk/check`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ positions: holdings })
      });
      risk = await rr.json();
    }catch{}

    // å–é›·è¾¾
    let radar = null;
    try{
      const xr = await fetch(`${api}/api/radar/sectors?top=3`);
      radar = await xr.json();
    }catch{}

    // æŠ€æœ¯æŒ‡æ ‡ï¼ˆä»ç¼“å­˜é‡Œå–å³å¯ï¼›ç¼“å­˜æ²¡æœ‰å°±ç©ºï¼‰
    const taCache = JSON.parse(localStorage.getItem(LS.taCache) || "{}");

    const messages = [
      { role:"system", content:
`ä½ æ˜¯ä¸¥æ ¼çš„ç»„åˆé£æ§ä¸æ“ä½œå»ºè®®åŠ©æ‰‹ã€‚ä¸è¦ç¼–é€ æ•°æ®ã€‚
å¿…é¡»è¾“å‡ºäº”éƒ¨åˆ†ï¼š
1) ç»„åˆé£é™©ç­‰çº§ï¼ˆä½/ä¸­/é«˜ï¼‰+ æ€»ä»“ä½å»ºè®®ï¼ˆä¾‹å¦‚75%ï¼‰ï¼Œå¹¶è¯´æ˜è§¦å‘é£æ§åŸå› 
2) æ¯åªæŒä»“ï¼šä»Šæ—¥åŠ¨ä½œï¼ˆä¹°/å–/ä¸åŠ¨ï¼‰+ä¸€å¥ç†ç”±ï¼ˆç»“åˆç›ˆäºã€è¶‹åŠ¿ã€æ–°é—»ï¼‰
3) æŠ€æœ¯ä¸è¶‹åŠ¿ï¼šç”¨RSI/MACD/å‡çº¿/20&60æ—¥æ”¶ç›Šå¯¹â€œåå¼º/åå¼±â€åšåˆ¤æ–­ï¼ˆå¦‚æ•°æ®ç¼ºå¤±è¦è¯´æ˜ï¼‰
4) æ–°é—»/æ”¿ç­–å½±å“ï¼šä»æä¾›çš„æ–°é—»ä¸­æç‚¼3-5æ¡è¦ç‚¹ï¼Œå¹¶æŒ‡å‡ºå¯¹æ¯ä¸ªä¸»é¢˜/æŒä»“çš„æ½œåœ¨å½±å“ï¼ˆåˆ©å¥½/åˆ©ç©º/ä¸ç¡®å®šï¼‰
5) æœªæ¥3-6ä¸ªæœˆï¼šæœ€çœ‹å¥½æ¿å—Top1 + æ¨èæ ‡çš„ä»£ç ï¼ˆETF/åŸºé‡‘ï¼‰+ åŸå› ï¼ˆç»“åˆé›·è¾¾+å®è§‚+æ–°é—»ï¼‰
è¾“å‡ºè¦æ¸…æ™°åˆ†æ®µï¼Œå°½é‡ç»™å‡ºå¯æ‰§è¡Œçš„â€œåŠ ä»“/å‡ä»“å¹…åº¦â€ï¼ˆä¾‹å¦‚+3% / -5%ï¼‰ã€‚`
      },
      { role:"user", content:
`æˆ‘çš„æŒä»“ï¼ˆJSONï¼‰ï¼š\n${JSON.stringify(holdings, null, 2)}\n\næŠ€æœ¯æŒ‡æ ‡ç¼“å­˜ï¼ˆJSONï¼Œå¯èƒ½ä¸ºç©ºï¼‰ï¼š\n${JSON.stringify(taCache, null, 2)}\n\né£æ§æ£€æŸ¥ï¼ˆJSONï¼‰ï¼š\n${JSON.stringify(risk, null, 2)}\n\næ¿å—é›·è¾¾ï¼ˆJSONï¼‰ï¼š\n${JSON.stringify(radar, null, 2)}\n\næ–°é—»ä¸æ”¿ç­–ï¼ˆæœ€å¤š12æ¡ï¼‰ï¼š\n${JSON.stringify(newsItems, null, 2)}\n\nè¯·æŒ‰è¦æ±‚è¾“å‡ºï¼Œæ ¼å¼æ¸…æ™°ã€‚`
      }
    ];

    $("aiOut").value = "ç”Ÿæˆä¸­â€¦";

    const r = await fetch(`${api}/api/ai/chat`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ baseUrl: cfg.baseUrl, apiKey: cfg.apiKey, model: cfg.model, messages })
    });

    const text = await r.text();
    try{
      const j = JSON.parse(text);
      $("aiOut").value = j?.choices?.[0]?.message?.content || text;
    }catch{
      $("aiOut").value = text;
    }
  }

  // ---------- é£æ§ ----------
  function riskColor(level){
    if(level==="é«˜") return "bad";
    if(level==="ä¸­") return "warn";
    return "ok";
  }

  async function refreshRisk(expand=false){
    const api = apiBase();
    if(!api) return;

    const holdings = window.positions.map(p=>({
      type:p.type, code:p.code, name:p.name, amount:p.amount, mv:p.mv, pnlPct:p.pnlPct, theme:p.theme
    }));

    try{
      const r = await fetch(`${api}/api/risk/check`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ positions: holdings })
      });
      const j = await r.json();
      if(!j.ok){ $("riskLevel").textContent = "-"; return; }

      $("riskLevel").innerHTML = `<span class="${riskColor(j.level)}">${j.level}</span>`;
      const posPct = (typeof j.suggestedTotalPosition==="number") ? (j.suggestedTotalPosition*100).toFixed(0)+"%" : "-";
      $("riskPos").textContent = posPct;

      // ä¸»é¢˜top1
      let topTheme = "-";
      if (j.themeConcentration) {
        const pairs = Object.entries(j.themeConcentration).sort((a,b)=>b[1]-a[1]);
        if (pairs.length) topTheme = `${pairs[0][0]} ${(pairs[0][1]*100).toFixed(0)}%`;
      }
      $("riskTheme").textContent = topTheme;

      const box = $("riskList");
      box.innerHTML = "";

      const addLine = (lvl, msg) => {
        const div = document.createElement("div");
        div.className = "li";
        div.innerHTML = `<div><b>é£æ§</b> <span class="tag ${lvl==="é«˜"?"bad":lvl==="ä¸­"?"warn":"ok"}">${lvl}</span></div><div class="mut small" style="margin-top:6px;">${msg}</div>`;
        box.appendChild(div);
      };

      const checks = Array.isArray(j.checks)?j.checks:[];
      const perPos = Array.isArray(j.perPos)?j.perPos:[];

      if (!checks.length && !perPos.length) {
        box.innerHTML = `<div class="mut small">æš‚æ— é£æ§å‘Šè­¦ã€‚</div>`;
        return;
      }

      if (expand){
        checks.forEach(c=>addLine(c.level, c.msg));
        perPos.forEach(c=>addLine(c.level, `${c.code}ï¼š${c.msg}`));
      } else {
        // é»˜è®¤åªæ˜¾ç¤ºæœ€ä¸¥é‡çš„3æ¡
        const combined = [
          ...checks.map(x=>({level:x.level,msg:x.msg})),
          ...perPos.map(x=>({level:x.level,msg:`${x.code}ï¼š${x.msg}`}))
        ];
        const rank = (l)=> l==="é«˜"?2 : l==="ä¸­"?1 : 0;
        combined.sort((a,b)=>rank(b.level)-rank(a.level));
        combined.slice(0,3).forEach(c=>addLine(c.level, c.msg));
      }

    }catch(e){
      console.warn("risk check failed", e);
    }
  }

  // ---------- æŠ€æœ¯æŒ‡æ ‡ ----------
  function taKey(p){ return `${p.type}:${String(p.code||"").toUpperCase()}`; }

  function renderTAFromCache(){
    const cache = JSON.parse(localStorage.getItem(LS.taCache) || "{}");
    const box = $("taList");
    box.innerHTML = "";
    if (!window.positions.length){
      box.innerHTML = `<div class="mut small">æš‚æ— æŒä»“ã€‚</div>`;
      return;
    }
    if (!cache || Object.keys(cache).length===0){
      box.innerHTML = `<div class="mut small">æš‚æ— æŠ€æœ¯æŒ‡æ ‡ç¼“å­˜ã€‚ç‚¹â€œåˆ·æ–°æŠ€æœ¯æŒ‡æ ‡â€ã€‚</div>`;
      return;
    }

    for (const p of window.positions){
      const k = taKey(p);
      const d = cache[k];
      const div = document.createElement("div");
      div.className = "li";

      if (!d || !d.ok){
        div.innerHTML = `<div><b>${p.code}</b> <span class="pill">${p.type}</span></div>
          <div class="mut small" style="margin-top:6px;">æš‚æ— æ•°æ®ï¼ˆå¯èƒ½æ˜¯ä¸Šæ¸¸ä¸ç¨³å®šæˆ–æ•°æ®ç‚¹ä¸è¶³ï¼‰ã€‚</div>`;
        box.appendChild(div);
        continue;
      }

      const macd = d.macd ? `MACD:${num(d.macd.macd)} ä¿¡å·:${num(d.macd.signal)} æŸ±:${num(d.macd.hist)}` : "MACD:-";
      const boll = d.boll ? `å¸ƒæ—: ä¸Š${num(d.boll.upper)} ä¸­${num(d.boll.mid)} ä¸‹${num(d.boll.lower)}` : "å¸ƒæ—:-";
      const pos = (typeof d.bollPos==="number") ? `å¸ƒæ—ä½ç½®:${Math.round(d.bollPos*100)}%` : "";

      div.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div><b>${p.code}</b> <span class="pill">${p.type}</span> <span class="tag">${d.trend||"æœªçŸ¥"}</span> <span class="mut small">${d.lastDate||""}</span></div>
          <div class="mut small">æºï¼š${d.source||"-"} ç‚¹æ•°:${d.points||"-"}</div>
        </div>
        <div class="sep"></div>
        <div class="grid2 small">
          <div>
            <div>RSI(14)ï¼š<b>${num(d.rsi14)}</b></div>
            <div>MA20ï¼š${num(d.ma20)} ï½œ MA60ï¼š${num(d.ma60)}</div>
            <div>20æ—¥æ”¶ç›Šï¼š${num(d.ret20)}% ï½œ 60æ—¥æ”¶ç›Šï¼š${num(d.ret60)}%</div>
          </div>
          <div>
            <div>${macd}</div>
            <div>${boll}</div>
            <div>${pos}</div>
          </div>
        </div>
      `;
      box.appendChild(div);
    }
  }

  function num(x){
    if (typeof x !== "number" || !isFinite(x)) return "-";
    return (Math.abs(x) >= 1000) ? x.toFixed(0) : x.toFixed(2);
  }

  function clearTA(){
    localStorage.removeItem(LS.taCache);
    renderTAFromCache();
  }

  async function runPool(tasks, limit=4){
    const results = [];
    let idx = 0;
    async function worker(){
      while (idx < tasks.length){
        const i = idx++;
        try{ results[i] = await tasks[i](); }
        catch(e){ results[i] = { ok:false, error:String(e) }; }
      }
    }
    const workers = Array.from({length: Math.min(limit, tasks.length)}, ()=>worker());
    await Promise.all(workers);
    return results;
  }

  async function refreshTA(){
    const api = apiBase();
    if(!api) return alert("å…ˆå¡«åç«¯åœ°å€");
    if(!window.positions.length) return alert("å…ˆæ·»åŠ æŒä»“");

    $("taList").innerHTML = `<div class="mut small">åˆ·æ–°æŠ€æœ¯æŒ‡æ ‡ä¸­â€¦</div>`;

    const tasks = window.positions.map(p => async ()=>{
      const url = `${api}/api/ta/one?type=${encodeURIComponent(p.type)}&code=${encodeURIComponent(p.code)}`;
      const r = await fetch(url);
      const j = await r.json();
      // åŒæ—¶æŠŠ theme å†™å›æŒä»“ï¼ˆç”¨äºé£æ§/AIï¼‰
      if (j && j.ok){
        p.theme = (p.theme || null);
      }
      return { key: taKey(p), data: j };
    });

    const results = await runPool(tasks, 4);
    const cache = JSON.parse(localStorage.getItem(LS.taCache) || "{}");
    for (const it of results){
      if (!it || !it.key) continue;
      cache[it.key] = it.data;
    }
    localStorage.setItem(LS.taCache, JSON.stringify(cache));

    persist();
    renderTAFromCache();
  }

  // ---------- æ¿å—é›·è¾¾ ----------
  async function refreshRadar(){
    const api = apiBase();
    if(!api) return;

    $("radarList").innerHTML = `<div class="mut small">åˆ·æ–°ä¸­â€¦</div>`;
    try{
      const r = await fetch(`${api}/api/radar/sectors?top=3`);
      const j = await r.json();
      const box = $("radarList");
      box.innerHTML = "";
      if(!j.ok || !j.top || !j.top.length){
        box.innerHTML = `<div class="mut small">æš‚æ— é›·è¾¾ç»“æœï¼ˆå¯èƒ½ä¸Šæ¸¸ä¸ç¨³å®šï¼‰ã€‚</div>`;
        return;
      }
      j.top.forEach((x, i)=>{
        const div = document.createElement("div");
        div.className = "li";
        div.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div><b>Top${i+1}ï¼š${x.sector}</b> <span class="tag mono">${x.symbol}</span> <span class="tag">è¶‹åŠ¿ï¼š${x.trend}</span></div>
            <div class="mut small">åˆ†æ•°ï¼š<b>${x.score}</b></div>
          </div>
          <div class="sep"></div>
          <div class="small">
            <div>è¿‘20æ—¥ï¼š${num(x.ret20)}% ï½œ è¿‘60æ—¥ï¼š${num(x.ret60)}% ï½œ RSIï¼š${num(x.rsi14)}</div>
            <div class="mut" style="margin-top:6px;">åŸå› ï¼š${(x.reasons||[]).join("ï¼›")}</div>
          </div>
        `;
        box.appendChild(div);
      });
    }catch(e){
      $("radarList").innerHTML = `<div class="mut small">é›·è¾¾è¯·æ±‚å¤±è´¥ï¼š${e.message}</div>`;
    }
  }

  // ---------- åˆå§‹åŒ– ----------
  load();
</script>
</body>
</html>
