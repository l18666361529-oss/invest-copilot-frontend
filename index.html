<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEON QUANT // NightCity Terminal</title>
  <style>
    :root{
      --bg0:#07070a;
      --bg1:#0b0b12;
      --card:#0f1020;
      --card2:#12142a;
      --fg:#e8e8ff;
      --muted:#a7a7d6;
      --muted2:#7f80b3;
      --line:#23244a;
      --cyan:#38f6ff;
      --pink:#ff3cf0;
      --lime:#8dff6a;
      --amber:#ffd25e;
      --danger:#ff4d6d;
      --shadow: 0 10px 30px rgba(0,0,0,.55);
      --radius:16px;
      --radius2:22px;
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; background: radial-gradient(1200px 800px at 20% 0%, rgba(255,60,240,.12), transparent 55%),
                                      radial-gradient(900px 700px at 80% 10%, rgba(56,246,255,.12), transparent 55%),
                                      radial-gradient(900px 700px at 60% 90%, rgba(141,255,106,.08), transparent 55%),
                                      linear-gradient(180deg, var(--bg0), var(--bg1));
               color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
    }
    a{ color:var(--cyan); text-decoration:none; }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px 14px 110px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 14px; border:1px solid var(--line); background:linear-gradient(180deg, rgba(18,20,42,.85), rgba(15,16,32,.78));
      border-radius: var(--radius2); box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: conic-gradient(from 220deg, var(--cyan), var(--pink), var(--lime), var(--cyan));
      box-shadow: 0 0 0 1px rgba(56,246,255,.25), 0 0 26px rgba(255,60,240,.18);
    }
    .title{ line-height:1.1; min-width:0;}
    .title h1{ margin:0; font-size:14px; letter-spacing:.12em; text-transform:uppercase; color:var(--fg); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .title .sub{ font-size:12px; color:var(--muted); margin-top:4px; }
    .statuspill{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; color:var(--muted); font-size:12px; }
    .pill{ padding:6px 10px; border:1px solid var(--line); border-radius:999px; background: rgba(10,10,18,.6); }
    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; margin-top:14px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 1.1fr .9fr; } }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(18,20,42,.85), rgba(15,16,32,.8));
      box-shadow: var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .card h2{
      margin:0 0 10px; font-size:13px; letter-spacing:.08em; text-transform:uppercase; color:var(--fg);
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .muted{ color:var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select, textarea, button{ font: inherit; color: var(--fg); }
    input, select, textarea{
      background: rgba(7,7,10,.6);
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 10px;
      outline:none;
      width:100%;
    }
    textarea{ min-height:92px; resize:vertical; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border-radius: 999px;
      padding:10px 12px;
      border:1px solid rgba(56,246,255,.35);
      background: linear-gradient(180deg, rgba(56,246,255,.14), rgba(255,60,240,.08));
      box-shadow: 0 0 0 1px rgba(56,246,255,.08), 0 10px 22px rgba(0,0,0,.35);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn.secondary{ border:1px solid var(--line); background: rgba(7,7,10,.55); }
    .btn.danger{ border:1px solid rgba(255,77,109,.35); background: linear-gradient(180deg, rgba(255,77,109,.18), rgba(255,60,240,.08)); }
    .btn.small{ padding:7px 10px; font-size:12px; }
    .two{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width: 720px){ .two{ grid-template-columns:1fr 1fr; } }
    .tbl{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(7,7,10,.45);
    }
    .tbl th, .tbl td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(35,36,74,.65);
      font-size:12px;
      vertical-align:top;
    }
    .tbl th{ color:var(--muted); font-weight:600; background: rgba(15,16,32,.35); }
    .tbl tr:last-child td{ border-bottom:none; }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; border:1px solid var(--line);
      background: rgba(15,16,32,.5);
      color:var(--muted);
      font-size:12px;
    }
    .tag.good{ border-color: rgba(141,255,106,.35); color: #d7ffd0; }
    .tag.warn{ border-color: rgba(255,210,94,.35); color: #fff0c6; }
    .tag.bad{ border-color: rgba(255,77,109,.35); color: #ffd0da; }
    .tag.info{ border-color: rgba(56,246,255,.35); color: #d7fbff; }
    .tag.sent_neu{ border-color: rgba(167,167,214,.35); color:#e8e8ff; }
    .tag.sent_pos{ border-color: rgba(141,255,106,.35); color:#d7ffd0; }
    .tag.sent_neg{ border-color: rgba(255,77,109,.35); color:#ffd0da; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .floating{ position: fixed; right: 14px; bottom: 14px; display:flex; flex-direction:column; gap:10px; z-index: 50; }
    .fab{
      width:52px; height:52px; border-radius:18px;
      border:1px solid rgba(56,246,255,.35);
      background: linear-gradient(180deg, rgba(56,246,255,.18), rgba(255,60,240,.10));
      box-shadow: var(--shadow);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none;
    }
    .fab span{ font-size:18px; }
    .modal-backdrop{ position: fixed; inset:0; background: rgba(0,0,0,.66); display:none; align-items:center; justify-content:center; padding:16px; z-index: 60; }
    .modal{
      width:min(980px, 100%);
      max-height: 86vh;
      overflow:auto;
      border-radius: 22px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,20,42,.95), rgba(12,12,20,.92));
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal header{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding-bottom:10px; border-bottom:1px solid rgba(35,36,74,.7); margin-bottom:12px; }
    .modal header h3{ margin:0; font-size:13px; letter-spacing:.08em; text-transform:uppercase;}
    .modal header p{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    .xbtn{
      width:38px; height:38px; border-radius:14px;
      border:1px solid var(--line); background: rgba(7,7,10,.5);
      display:flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .kbd{ padding:2px 6px; border:1px solid var(--line); border-radius:8px; background:rgba(7,7,10,.5); font-size:12px;}
    .hr{ height:1px; background: rgba(35,36,74,.7); margin:12px 0; }
    .small{ font-size:12px; color:var(--muted); }
    .okdot{ display:inline-block; width:8px; height:8px; border-radius:50%; background: var(--lime); box-shadow:0 0 12px rgba(141,255,106,.35);}
    .baddot{ display:inline-block; width:8px; height:8px; border-radius:50%; background: var(--danger); box-shadow:0 0 12px rgba(255,77,109,.35);}
    .grid2{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:720px){ .grid2{ grid-template-columns:1fr 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>NEON QUANT // NightCity Terminal</h1>
          <div class="sub">èµ›åšæŠ•ç ”èˆ± Â· æŒä»“å…¨æ™¯ï¼ˆå«æŠ€æœ¯æŒ‡æ ‡ï¼‰Â· åŒè¯­æ–°é—»é›·è¾¾ Â· ä¸€é”®ä¸Šå¸è§†è§’</div>
        </div>
      </div>
      <div class="statuspill">
        <div class="pill"><span id="healthDot" class="baddot"></span> <span id="healthText">åç«¯æœªæ£€æµ‹</span></div>
        <div class="pill">Backend: <span class="mono" id="backendText"></span></div>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <h2>è¿æ¥ä¸æ–°é—»ï¼ˆåŒè½¨ï¼‰</h2>

        <div class="two">
          <div>
            <div class="small">åç«¯åŸŸåï¼ˆRenderï¼‰</div>
            <input id="apiBase" placeholder="https://xxx.onrender.com" />
            <div class="row" style="margin-top:10px;">
              <button class="btn small" id="btnHealth">æµ‹è¯•åç«¯</button>
              <button class="btn small secondary" id="btnClearLocal">æ¸…ç†æœ¬åœ°ç¼“å­˜</button>
            </div>
            <div class="small" style="margin-top:8px;">æç¤ºï¼šæ›´æ–°åè‹¥æ˜¾ç¤ºæ—§ç•Œé¢ï¼Œè¯·ç”¨ <span class="kbd">Ctrl+F5</span> å¼ºåˆ·æˆ–æ— ç—•çª—å£æ‰“å¼€ã€‚</div>
          </div>

          <div>
            <div class="small">æ–°é—»æ‘˜è¦ï¼ˆè‡ªåŠ¨å–‚ç»™AIï¼Œå¯ç”±ä¸‹æ–¹â€œæ–°é—»æ¡ç›®â€ç”Ÿæˆï¼‰</div>
            <textarea id="newsBox" placeholder="ä½ ä¹Ÿå¯ä»¥ç›´æ¥æŠŠæ–°é—»æ‘˜è¦ç²˜è´´åœ¨è¿™é‡Œï¼ˆä¸­è‹±éƒ½è¡Œï¼‰ã€‚"></textarea>
            <div class="row" style="margin-top:10px;">
              <button class="btn small secondary" id="btnSaveNews">ä¿å­˜æ‘˜è¦</button>
              <button class="btn small danger" id="btnClearNews">æ¸…ç©º</button>
            </div>
          </div>
        </div>

        <details style="margin-top:12px;">
          <summary class="small">æ–°é—»æ¡ç›®ï¼ˆå¸¦æƒ…ç»ªå°æ ‡ç­¾ï¼šä¸­æ€§/åˆ©å¥½/åˆ©ç©ºï¼‰</summary>
          <div class="hr"></div>

          <div class="grid2">
            <div>
              <div class="small">è¯­è¨€</div>
              <select id="newsLang">
                <option value="ZH">ä¸­æ–‡ï¼ˆæŠ“æ”¿ç­–ç»†èŠ‚/å®˜æ–¹è¡¨è¿°ï¼‰</option>
                <option value="EN">è‹±æ–‡ï¼ˆæŠ“å¤–åª’è§£è¯»/å¸‚åœºååº”ï¼‰</option>
              </select>
            </div>
            <div>
              <div class="small">æƒ…ç»ªæ ‡ç­¾</div>
              <select id="newsSent">
                <option value="ä¸­æ€§">ä¸­æ€§</option>
                <option value="åˆ©å¥½">åˆ©å¥½</option>
                <option value="åˆ©ç©º">åˆ©ç©º</option>
              </select>
            </div>
          </div>

          <div class="two" style="margin-top:10px;">
            <div>
              <div class="small">æ ‡é¢˜/è¦ç‚¹ï¼ˆå¿…å¡«ï¼‰</div>
              <input id="newsTitle" placeholder="ä¾‹å¦‚ï¼šPBOC RRR cut boosts China growth expectations" />
            </div>
            <div>
              <div class="small">æ¥æºï¼ˆå¯ç©ºï¼šReuters/FT/æ–°åç¤¾ç­‰ï¼‰</div>
              <input id="newsSource" placeholder="ä¾‹å¦‚ï¼šReuters" />
            </div>
          </div>

          <div class="two" style="margin-top:10px;">
            <div>
              <div class="small">æ—¥æœŸï¼ˆå¯ç©ºï¼‰</div>
              <input id="newsDate" placeholder="YYYY-MM-DDï¼ˆå¯ç©ºï¼‰" />
            </div>
            <div>
              <div class="small">é“¾æ¥ï¼ˆå¯ç©ºï¼‰</div>
              <input id="newsLink" placeholder="https://..." />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn small" id="btnAddNews">æ·»åŠ æ¡ç›®</button>
            <button class="btn small secondary" id="btnBuildDigest">ç”Ÿæˆæ‘˜è¦åˆ°ä¸Šæ–¹</button>
            <button class="btn small secondary" id="btnExportNews">å¯¼å‡º</button>
            <label class="btn small secondary" style="cursor:pointer;">
              å¯¼å…¥<input type="file" id="newsImportFile" accept="application/json" style="display:none;">
            </label>
            <button class="btn small danger" id="btnClearNewsItems">æ¸…ç©ºæ¡ç›®</button>
          </div>

          <div style="margin-top:12px; overflow:auto;">
            <table class="tbl" id="newsTable">
              <thead>
                <tr>
                  <th style="width:12%;">è¯­è¨€</th>
                  <th style="width:12%;">æƒ…ç»ª</th>
                  <th>æ ‡é¢˜/è¦ç‚¹</th>
                  <th style="width:16%;">æ¥æº</th>
                  <th style="width:14%;">æ—¥æœŸ</th>
                  <th style="width:10%;">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="small" style="margin-top:8px;">
            âœ… æ–°é—»æ‘˜è¦ä¼š<strong>è‡ªåŠ¨å–‚ç»™AI</strong>ã€‚å…³é”®è¯åº“ï¼ˆä¸­è‹±åŒè½¨ï¼‰åœ¨å³ä¸‹è§’ã€ŒğŸ”ã€é‡Œç®¡ç†ã€‚
          </div>
        </details>

        <div class="hr"></div>

        <h2>æ¿å—åŠ¨å‘ï¼ˆProxy ETF / æ…¢æ‰«ï¼‰</h2>
        <div class="row">
          <button class="btn" id="btnScan">åˆ·æ–°æ¿å—åŠ¨å‘ï¼ˆæ…¢æ‰«ï¼‰</button>
          <button class="btn secondary" id="btnStopScan">åœæ­¢</button>
          <button class="btn secondary" id="btnForceScan">å¼ºåˆ¶é‡æ‰«å¤±è´¥é¡¹</button>
        </div>
        <div class="small" id="scanStatus" style="margin-top:10px;">å°šæœªå¼€å§‹æ‰«æã€‚</div>

        <div style="margin-top:12px; overflow:auto;">
          <table class="tbl" id="sectorTable">
            <thead>
              <tr>
                <th style="width:26%;">æ¿å—</th>
                <th style="width:10%;">å¸‚åœº</th>
                <th style="width:12%;">Proxy</th>
                <th style="width:12%;">è¶‹åŠ¿</th>
                <th style="width:12%;">åŠ¨é‡(20d)</th>
                <th style="width:12%;">RSI</th>
                <th style="width:16%;">çŠ¶æ€</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <details style="margin-top:12px;">
          <summary class="small">ç®¡ç†æ¿å—ï¼ˆæ·»åŠ /åˆ é™¤/éšè—é»˜è®¤/é‡ç½®ï¼‰</summary>
          <div class="hr"></div>
          <div class="two">
            <div>
              <div class="small">æ·»åŠ  Proxy æ¿å—</div>
              <div class="two">
                <div>
                  <select id="sectorMarket">
                    <option value="US">ç¾è‚¡/æµ·å¤–</option>
                    <option value="CN_FUND">å›½å†…ETF/åŸºé‡‘ï¼ˆ6ä½ï¼‰</option>
                  </select>
                </div>
                <div>
                  <input id="sectorTheme" placeholder="æ¿å—å/ä¸»é¢˜ï¼ˆå¦‚ï¼šè´µé‡‘å±/å†›å·¥/AI/æœºå™¨äººï¼‰" />
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><input id="sectorSymbol" placeholder="Proxyä»£ç ï¼šUSå¡«SPY/SMHï¼›å›½å†…å¡«512xxx/159xxx" /></div>
                <div><input id="sectorName" placeholder="æ˜¾ç¤ºåï¼ˆå¯ç©ºï¼‰" /></div>
              </div>
              <div class="row" style="margin-top:10px;">
                <button class="btn small" id="btnAddSector">æ·»åŠ </button>
                <button class="btn small secondary" id="btnExportSectors">å¯¼å‡º</button>
                <label class="btn small secondary" style="cursor:pointer;">
                  å¯¼å…¥<input type="file" id="sectorImportFile" accept="application/json" style="display:none;">
                </label>
                <button class="btn small danger" id="btnResetSectors">é‡ç½®é»˜è®¤</button>
              </div>
              <div class="small" style="margin-top:8px;">å›½å†…æ¿å—ç”¨â€œä»£è¡¨ETF/åŸºé‡‘(6ä½)â€ä½œä¸º Proxyã€‚</div>
            </div>

            <div>
              <div class="small">å½“å‰æ¿å—åˆ—è¡¨</div>
              <div style="max-height:220px; overflow:auto; margin-top:10px; border:1px solid var(--line); border-radius:14px; background: rgba(7,7,10,.35);">
                <table class="tbl" id="sectorManageTable" style="border:none; border-radius:0;">
                  <thead>
                    <tr><th>æ¿å—</th><th>å¸‚åœº</th><th>Proxy</th><th>æ“ä½œ</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="small" style="margin-top:8px;">é»˜è®¤æ¿å—å¯â€œéšè—â€ï¼›è‡ªå®šä¹‰æ¿å—å¯â€œåˆ é™¤â€ã€‚</div>
            </div>
          </div>
        </details>
      </div>

      <!-- Right -->
      <div class="card">
        <h2>æŒä»“å…¨æ™¯ï¼ˆå«æŠ€æœ¯æŒ‡æ ‡ï¼‰ <span class="tag info">è‡ªåŠ¨æŠ“åç§°/å‡€å€¼</span></h2>

        <div class="small">æ·»åŠ æŒä»“ï¼šåªå¡«ä»£ç ä¹Ÿå¯ä»¥ï¼ˆåç§°/å‡€å€¼è‡ªåŠ¨æŠ“ï¼‰ã€‚æˆæœ¬ä¿¡æ¯å»ºè®®å¡«å†™ï¼Œæ‰èƒ½è®¡ç®—ç›ˆäºã€‚</div>

        <div class="two" style="margin-top:10px;">
          <div>
            <div class="small">ç±»å‹</div>
            <select id="posType">
              <option value="CN_FUND">å›½å†…åŸºé‡‘/ETFï¼ˆ6ä½ï¼‰</option>
              <option value="US_TICKER">ç¾è‚¡Tickerï¼ˆå¦‚SPY/QQQï¼‰</option>
            </select>
          </div>
          <div>
            <div class="small">ä»£ç </div>
            <input id="posCode" placeholder="å¦‚ï¼š019449 æˆ– 008764 æˆ– SPY" />
          </div>
        </div>

        <div class="two" style="margin-top:10px;">
          <div>
            <div class="small">æˆæœ¬é‡‘é¢ï¼ˆå…ƒ/ç¾å…ƒï¼Œå¿…å¡«æ‰å¯ç®—ç›ˆäºï¼‰</div>
            <input id="posCostAmt" placeholder="ä¾‹å¦‚ï¼š5000" />
          </div>
          <div>
            <div class="small">æˆæœ¬å•ä½å‡€å€¼ï¼ˆå¯ç©ºï¼‰</div>
            <input id="posCostNav" placeholder="ä¾‹å¦‚ï¼š1.2345ï¼ˆå¯ç©ºï¼‰" />
          </div>
        </div>

        <div class="two" style="margin-top:10px;">
          <div>
            <div class="small">æŒæœ‰ä»½é¢ï¼ˆå¯ç©ºï¼šä¼šè‡ªåŠ¨ç”¨ æˆæœ¬é‡‘é¢/æˆæœ¬å‡€å€¼ æ¨ç®—ï¼‰</div>
            <input id="posShares" placeholder="ä¾‹å¦‚ï¼š4056.78ï¼ˆå¯ç©ºï¼‰" />
          </div>
          <div>
            <div class="small">åç§°ï¼ˆå¯ç©ºï¼šä¼šè‡ªåŠ¨æŠ“å–ï¼‰</div>
            <input id="posName" placeholder="å¯ä¸å¡«" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn small" id="btnAddPos">æ·»åŠ æŒä»“</button>
          <button class="btn small secondary" id="btnRefreshHoldings">åˆ·æ–°å‡€å€¼/æŠ€æœ¯æŒ‡æ ‡</button>
          <button class="btn small secondary" id="btnExportPos">å¯¼å‡º</button>
          <label class="btn small secondary" style="cursor:pointer;">å¯¼å…¥<input type="file" id="posImportFile" accept="application/json" style="display:none;"></label>
          <button class="btn small danger" id="btnClearPos">æ¸…ç©º</button>
        </div>

        <div class="small" id="holdStatus" style="margin-top:10px;">æœªåˆ·æ–°</div>

        <div style="margin-top:12px; overflow:auto;">
          <table class="tbl" id="posTable">
            <thead>
              <tr>
                <th>ä»£ç </th>
                <th>åç§°</th>
                <th>å‡€å€¼/ä»·</th>
                <th>æˆæœ¬</th>
                <th>å¸‚å€¼</th>
                <th>æµ®åŠ¨</th>
                <th>è¶‹åŠ¿</th>
                <th>åŠ¨é‡</th>
                <th>RSI</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <h2>AI ä¸€é”®å…¨å±€åˆ†æ <span class="tag good">ä¸Šå¸ä¹‹çœ¼</span></h2>
        <div class="small">ä¸€æ¬¡ç‚¹å‡»ï¼šåŒæ—¶è¾“å‡ºã€Œé£é™©ã€ã€ŒæŒä»“å»ºè®®ã€ã€Œæœºä¼šæ¿å—ã€ã€‚ä½ åªè¦æŠŠå¤åˆ¶çš„å†…å®¹ç²˜è´´ç»™ ChatGPT å³å¯ã€‚</div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnComposeGod">ç”ŸæˆAIè¾“å…¥ï¼ˆå¤åˆ¶ï¼‰</button>
          <button class="btn secondary" id="btnShowPayload">æŸ¥çœ‹å–‚ç»™AIçš„æ•°æ®</button>
        </div>

        <div class="hr"></div>

        <h2>é£æ§æ ¡éªŒï¼ˆå¯å–‚/å¯å…³ï¼‰</h2>
        <div class="row">
          <label class="tag"><input type="checkbox" id="feedRisk" checked style="margin-right:8px;">å–‚ç»™AIï¼ˆä»…ä½œæ ¡éªŒï¼‰</label>
          <label class="tag"><input type="checkbox" id="feedSectors" checked style="margin-right:8px;">å–‚æ¿å—åŠ¨å‘</label>
          <label class="tag"><input type="checkbox" id="feedHoldings" checked style="margin-right:8px;">å–‚æŒä»“å…¨æ™¯</label>
          <label class="tag"><input type="checkbox" id="feedNews" checked style="margin-right:8px;">å–‚æ–°é—»æ‘˜è¦</label>
        </div>
      </div>
    </div>
  </div>

  <div class="floating">
    <div class="fab" id="fabGuide" title="æŒ‡å—"><span>?</span></div>
    <div class="fab" id="fabPrompt" title="Prompt"><span>âš™ï¸</span></div>
    <div class="fab" id="fabKeywords" title="å…³é”®è¯"><span>ğŸ”</span></div>
  </div>

  <!-- Guide modal -->
  <div class="modal-backdrop" id="modalGuide">
    <div class="modal">
      <header>
        <div>
          <h3>æŒ‡å— // æ ‡ç­¾è§£é‡Šï¼ˆæ‰‹æœºå‹å¥½ï¼‰</h3>
          <p>è¿™äº›æ ‡ç­¾ä¸æ˜¯ä¹°å–æŒ‡ä»¤ï¼Œè€Œæ˜¯â€œçŠ¶æ€æç¤ºâ€ã€‚ç¨³å¥ç”¨æ³•ï¼šç”¨å®ƒå†³å®šè¿½ä¸è¿½ã€åˆ†ä¸åˆ†æ‰¹ã€å…ˆè§‚æœ›ã€‚</p>
        </div>
        <div class="xbtn" data-close="modalGuide">âœ•</div>
      </header>

      <div class="tag info">è¶‹åŠ¿ï¼ˆä¸Šè¡Œ/ä¸‹è¡Œ/éœ‡è¡ï¼‰</div>
      <p class="muted">åŸºäº SMA20 ä¸ SMA60ï¼šSMA20 > SMA60 åå¼ºï¼›åä¹‹åå¼±ã€‚</p>

      <div class="tag info">åŠ¨é‡ï¼ˆ20dæ¶¨è·Œå¹…ï¼‰</div>
      <p class="muted">è¿‘çº¦ä¸€ä¸ªæœˆæ¶¨è·Œå¹…ã€‚åŠ¨é‡é«˜æ—¶è¿½é«˜é£é™©æ›´å¤§ï¼›åŠ¨é‡ä¸ºè´Ÿè¯´æ˜è¿‘æœŸèµ°å¼±ã€‚</p>

      <div class="tag info">RSIï¼ˆåçƒ­/ä¸­æ€§/åå†·ï¼‰</div>
      <p class="muted">RSI æ˜¯â€œæ¶¨å¾—æ˜¯ä¸æ˜¯å¤ªå¿«â€çš„æ¸©åº¦è®¡ï¼šé€šå¸¸ >70 åçƒ­ï¼Œ<30 åå†·ã€‚</p>

      <div class="hr"></div>
      <div class="tag warn">æ–°é—»åŒè½¨ï¼ˆä¸­è‹±ï¼‰</div>
      <p class="muted">ä¸­æ–‡å…³é”®è¯æ›´å®¹æ˜“æŠ“åˆ°æ”¿ç­–åŸæ–‡/å®˜æ–¹è¡¨è¿°ï¼›è‹±æ–‡å…³é”®è¯æ›´å®¹æ˜“æŠ“åˆ°å¤–åª’å¿«é€Ÿè§£è¯»ä¸å¸‚åœºååº”ã€‚</p>
    </div>
  </div>

  <!-- Prompt modal -->
  <div class="modal-backdrop" id="modalPrompt">
    <div class="modal">
      <header>
        <div>
          <h3>Prompt ç®¡ç† // ä¸‰å±‚æç¤ºè¯</h3>
          <p>System å°½é‡å°‘æ”¹ï¼›Analysis å¯æŒ‰ä½ å£å‘³è°ƒï¼›Task é»˜è®¤æ˜¯â€œä¸€é”®å…¨å±€â€ã€‚</p>
        </div>
        <div class="xbtn" data-close="modalPrompt">âœ•</div>
      </header>

      <div class="row">
        <button class="btn small" id="btnPromptSave">ä¿å­˜</button>
        <button class="btn small secondary" id="btnPromptExport">å¯¼å‡º</button>
        <label class="btn small secondary" style="cursor:pointer;">å¯¼å…¥<input type="file" id="promptImportFile" accept="application/json" style="display:none;"></label>
        <button class="btn small danger" id="btnPromptReset">æ¢å¤é»˜è®¤</button>
      </div>

      <div class="hr"></div>
      <div class="small">System Prompt</div>
      <textarea id="promptSystem"></textarea>

      <div class="small" style="margin-top:12px;">Analysis Prompt</div>
      <textarea id="promptAnalysis"></textarea>

      <div class="small" style="margin-top:12px;">Task Promptï¼ˆé»˜è®¤ä¸€é”®å…¨å±€ï¼Œå¯æ”¹ï¼‰</div>
      <textarea id="promptTask"></textarea>
    </div>
  </div>

  <!-- Keywords modal -->
  <div class="modal-backdrop" id="modalKeywords">
    <div class="modal">
      <header>
        <div>
          <h3>å…³é”®è¯åº“ // åŒè½¨åˆ¶ï¼ˆä¸­è‹±ï¼‰</h3>
          <p>ä¸­æ–‡æŠ“æ”¿ç­–ç»†èŠ‚/å®˜æ–¹è¡¨è¿°ï¼›è‹±æ–‡æŠ“å¤–åª’è§£è¯»/å¸‚åœºååº”ã€‚å¯è‡ªå®šä¹‰ï¼Œä¸”ä¸ä¼šè¢«è¦†ç›–ã€‚</p>
        </div>
        <div class="xbtn" data-close="modalKeywords">âœ•</div>
      </header>

      <div class="row">
        <button class="btn small" id="btnKwSave">ä¿å­˜</button>
        <button class="btn small secondary" id="btnKwExport">å¯¼å‡º</button>
        <label class="btn small secondary" style="cursor:pointer;">å¯¼å…¥<input type="file" id="kwImportFile" accept="application/json" style="display:none;"></label>
        <button class="btn small danger" id="btnKwReset">æ¢å¤é»˜è®¤</button>
      </div>

      <div class="hr"></div>
      <div class="two">
        <div>
          <div class="small">å¤–åª’ä¼˜å…ˆç«™ç‚¹ï¼ˆé€—å·åˆ†éš”ï¼Œå¯ç©ºï¼‰</div>
          <input id="kwSites" placeholder="reuters.com, ft.com, wsj.com, bloomberg.com" />
        </div>
        <div>
          <div class="small">å¤åˆ¶å¯ç”¨æœç´¢è¯­å¥</div>
          <button class="btn small secondary" id="btnKwBuildQueries">ç”Ÿæˆ</button>
        </div>
      </div>

      <textarea id="kwQueries" class="mono" style="margin-top:10px; min-height:160px;" placeholder="ç‚¹å‡»ç”Ÿæˆ..."></textarea>

      <div class="hr"></div>
      <div class="two">
        <div>
          <div class="small">é»˜è®¤å…³é”®è¯ç»„</div>
          <div id="kwDefault"></div>
        </div>
        <div>
          <div class="small">è‡ªå®šä¹‰å…³é”®è¯ç»„</div>
          <div class="row" style="margin-bottom:10px;"><button class="btn small" id="btnKwAddCustom">æ–°å¢è‡ªå®šä¹‰ç»„</button></div>
          <div id="kwCustom"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Payload modal -->
  <div class="modal-backdrop" id="modalPayload">
    <div class="modal">
      <header>
        <div>
          <h3>å–‚ç»™ AI çš„æ•°æ®ï¼ˆè°ƒè¯•ï¼‰</h3>
          <p>è¿™é‡Œæ˜¯æœ€ç»ˆ payload é¢„è§ˆï¼ˆJSONï¼‰ã€‚</p>
        </div>
        <div class="xbtn" data-close="modalPayload">âœ•</div>
      </header>
      <div class="row"><button class="btn small secondary" id="btnCopyPayload">å¤åˆ¶JSON</button></div>
      <textarea id="payloadBox" class="mono" style="margin-top:10px; min-height:340px;"></textarea>
    </div>
  </div>

<script>
/* =========================
   Storage keys
========================= */
const LS = {
  apiBase: "nq_api_base",
  newsDigest: "nq_news_digest_v2",
  newsItems: "nq_news_items_v2",

  positions: "nq_positions_v2",
  holdingCache: "nq_holding_cache_v2",
  techCache: "nq_tech_cache_v2",

  sectorsCustom: "nq_sectors_custom_v1",
  sectorsHidden: "nq_sectors_hidden_v1",
  sectorResults: "nq_sector_results_v1",
  sectorFail: "nq_sector_fail_v1",

  prompt: "nq_prompts_v2",
  keywords: "nq_keywords_v2"
};

const DEFAULT_API_BASE = "https://invest-copilot-backend.onrender.com";

/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);
function nowMs(){ return Date.now(); }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

function loadJson(key, fallback){
  try{ const s = localStorage.getItem(key); return s ? JSON.parse(s) : fallback; }catch{ return fallback; }
}
function saveJson(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

function fmtNum(x, d=2){
  const n = Number(x);
  if(!Number.isFinite(n)) return "â€”";
  return n.toFixed(d);
}
function fmtMoney(x, d=2){
  const n = Number(x);
  if(!Number.isFinite(n)) return "â€”";
  return n.toFixed(d);
}
function pct(x, d=1){
  const n = Number(x);
  if(!Number.isFinite(n)) return "â€”";
  return (n>=0?"+":"") + n.toFixed(d) + "%";
}
function trendFrom(sma20, sma60){
  const a = Number(sma20), b = Number(sma60);
  if(!Number.isFinite(a) || !Number.isFinite(b)) return "â€”";
  if(a > b * 1.002) return "ä¸Šè¡Œ";
  if(a < b * 0.998) return "ä¸‹è¡Œ";
  return "éœ‡è¡";
}
function labelTrend(t){
  if(t==="ä¸Šè¡Œ") return `<span class="tag good">ä¸Šè¡Œ</span>`;
  if(t==="ä¸‹è¡Œ") return `<span class="tag bad">ä¸‹è¡Œ</span>`;
  if(t==="éœ‡è¡") return `<span class="tag warn">éœ‡è¡</span>`;
  return "â€”";
}
function rsiTag(rsi){
  const n = Number(rsi);
  if(!Number.isFinite(n)) return "â€”";
  if(n >= 70) return "åçƒ­";
  if(n <= 30) return "åå†·";
  return "ä¸­æ€§";
}
function labelRsi(v){
  const n = Number(v);
  if(!Number.isFinite(n)) return "â€”";
  const tag = rsiTag(n);
  if(tag==="åçƒ­") return `<span class="tag warn">${fmtNum(n,0)} åçƒ­</span>`;
  if(tag==="åå†·") return `<span class="tag warn">${fmtNum(n,0)} åå†·</span>`;
  return `<span class="tag info">${fmtNum(n,0)} ä¸­æ€§</span>`;
}
function labelRet(v){
  const n = Number(v);
  if(!Number.isFinite(n)) return "â€”";
  if(n>=6) return `<span class="tag good">${pct(n)}</span>`;
  if(n>=2) return `<span class="tag info">${pct(n)}</span>`;
  if(n<=-4) return `<span class="tag bad">${pct(n)}</span>`;
  return `<span class="tag warn">${pct(n)}</span>`;
}
function marketTag(mkt){
  if(mkt === "CN_FUND") return "å›½å†…";
  return "US";
}
function tagSent(sent){
  if(sent==="åˆ©å¥½") return `<span class="tag sent_pos">åˆ©å¥½</span>`;
  if(sent==="åˆ©ç©º") return `<span class="tag sent_neg">åˆ©ç©º</span>`;
  return `<span class="tag sent_neu">ä¸­æ€§</span>`;
}
function tagLang(lang){
  return lang==="EN" ? `<span class="tag info">EN</span>` : `<span class="tag warn">ZH</span>`;
}
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); return true; }catch{
    const ta = document.createElement("textarea");
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy"); ta.remove(); return true;
  }
}

/* =========================
   API base + health
========================= */
let API_BASE = DEFAULT_API_BASE;

function initApiBase(){
  const saved = (localStorage.getItem(LS.apiBase) || DEFAULT_API_BASE).trim().replace(/\/+$/,"");
  API_BASE = saved || DEFAULT_API_BASE;
  $("apiBase").value = API_BASE;
  $("backendText").textContent = API_BASE;
}
$("apiBase").addEventListener("change", ()=>{
  API_BASE = $("apiBase").value.trim().replace(/\/+$/,"");
  localStorage.setItem(LS.apiBase, API_BASE);
  $("backendText").textContent = API_BASE || "(æœªè®¾ç½®)";
});

async function checkHealth(){
  try{
    const r = await fetch(API_BASE + "/health", { cache:"no-store" });
    const j = await r.json();
    if(j?.ok){
      $("healthText").textContent = "OK " + (j.build || "");
      $("healthDot").className = "okdot";
    }else{
      $("healthText").textContent = "å¼‚å¸¸";
      $("healthDot").className = "baddot";
    }
  }catch{
    $("healthText").textContent = "æ— æ³•è¿æ¥";
    $("healthDot").className = "baddot";
  }
}

/* =========================
   Clear local cache
========================= */
$("btnClearLocal").addEventListener("click", ()=>{
  const keys = Object.values(LS);
  for(const k of keys) localStorage.removeItem(k);
  location.reload();
});
$("btnHealth").addEventListener("click", checkHealth);

/* =========================
   News digest + items
========================= */
function initNews(){
  $("newsBox").value = localStorage.getItem(LS.newsDigest) || "";
  renderNewsItems();
}
$("btnSaveNews").addEventListener("click", ()=>{
  localStorage.setItem(LS.newsDigest, $("newsBox").value || "");
  alert("å·²ä¿å­˜æ‘˜è¦");
});
$("btnClearNews").addEventListener("click", ()=>{
  $("newsBox").value="";
  localStorage.removeItem(LS.newsDigest);
});

function loadNewsItems(){ return loadJson(LS.newsItems, []); }
function saveNewsItems(items){ saveJson(LS.newsItems, items); }

function renderNewsItems(){
  const items = loadNewsItems();
  const body = $("newsTable").querySelector("tbody");
  body.innerHTML = "";
  for(const it of items){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${tagLang(it.lang)}</td>
      <td>${tagSent(it.sent)}</td>
      <td>${escapeHtml(it.title)} ${it.link ? `<div class="small"><a href="${escapeAttr(it.link)}" target="_blank" rel="noreferrer">link</a></div>` : ""}</td>
      <td>${escapeHtml(it.source || "")}</td>
      <td>${escapeHtml(it.date || "")}</td>
      <td><button class="btn small danger" data-delnews="${escapeAttr(it.id)}">åˆ é™¤</button></td>
    `;
    body.appendChild(tr);
  }
  body.querySelectorAll("[data-delnews]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-delnews");
      saveNewsItems(loadNewsItems().filter(x=>String(x.id)!==String(id)));
      renderNewsItems();
    });
  });
}

function uid(prefix){ return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

$("btnAddNews").addEventListener("click", ()=>{
  const title = $("newsTitle").value.trim();
  if(!title){ alert("è¯·å¡«å†™æ ‡é¢˜/è¦ç‚¹"); return; }
  const it = {
    id: uid("n"),
    lang: $("newsLang").value,
    sent: $("newsSent").value,
    title,
    source: $("newsSource").value.trim() || null,
    date: $("newsDate").value.trim() || null,
    link: $("newsLink").value.trim() || null
  };
  const items = loadNewsItems();
  items.unshift(it); // newest first
  saveNewsItems(items);
  $("newsTitle").value=""; $("newsSource").value=""; $("newsDate").value=""; $("newsLink").value="";
  renderNewsItems();
});

$("btnClearNewsItems").addEventListener("click", ()=>{
  if(!confirm("æ¸…ç©ºæ‰€æœ‰æ–°é—»æ¡ç›®ï¼Ÿ")) return;
  saveNewsItems([]);
  renderNewsItems();
});

$("btnBuildDigest").addEventListener("click", ()=>{
  const items = loadNewsItems();
  if(!items.length){ alert("æ²¡æœ‰æ–°é—»æ¡ç›®"); return; }
  const lines = items.map(it=>{
    const date = it.date ? `(${it.date}) ` : "";
    const src = it.source ? `${it.source}: ` : "";
    const link = it.link ? ` ${it.link}` : "";
    return `- [${it.sent}][${it.lang}] ${date}${src}${it.title}${link}`.trim();
  });
  const digest = lines.join("\n");
  $("newsBox").value = digest;
  localStorage.setItem(LS.newsDigest, digest);
  alert("å·²ç”Ÿæˆæ‘˜è¦å¹¶ä¿å­˜ï¼ˆä¼šè‡ªåŠ¨å–‚ç»™AIï¼‰");
});

$("btnExportNews").addEventListener("click", ()=>{
  const items = loadNewsItems();
  const blob = new Blob([JSON.stringify(items, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "neon_news_items.json";
  a.click();
});

$("newsImportFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const j = JSON.parse(txt);
    if(!Array.isArray(j)) throw new Error("æ ¼å¼å¿…é¡»æ˜¯æ•°ç»„");
    saveNewsItems(j);
    renderNewsItems();
    alert("å¯¼å…¥æˆåŠŸ");
  }catch(err){
    alert("å¯¼å…¥å¤±è´¥ï¼š" + String(err));
  }finally{ e.target.value=""; }
});

/* =========================
   Positions + holding data
========================= */
function normFundCode(code){
  const s = String(code||"").trim();
  if(!s) return "";
  if(/^\d{1,6}$/.test(s)) return s.padStart(6,"0");
  return s;
}
function loadPositions(){ return loadJson(LS.positions, []); }
function savePositions(ps){ saveJson(LS.positions, ps); }

function loadHoldingCache(){ return loadJson(LS.holdingCache, { ts:0, map:{} }); }
function saveHoldingCache(x){ saveJson(LS.holdingCache, x); }

function loadTechCache(){ return loadJson(LS.techCache, { ts:0, map:{} }); }
function saveTechCache(x){ saveJson(LS.techCache, x); }

async function fetchJson(url, {timeoutMs=25000}={}){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const r = await fetch(url, { cache:"no-store", signal: ctrl.signal });
    const j = await r.json();
    return j;
  }finally{ clearTimeout(t); }
}
async function postJson(url, body, {timeoutMs=40000, signal=null}={}){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  const merged = mergeSignals(signal, ctrl.signal);
  try{
    const r = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body), signal: merged });
    return await r.json();
  }finally{ clearTimeout(t); }
}
function mergeSignals(a,b){
  if(!a) return b;
  if(!b) return a;
  const ctrl = new AbortController();
  const onAbort = ()=>ctrl.abort();
  a.addEventListener("abort", onAbort, {once:true});
  b.addEventListener("abort", onAbort, {once:true});
  return ctrl.signal;
}

function holdingKey(p){ return `${p.type}:${p.code}`; }

async function fetchHoldingMeta(p){
  if(p.type === "CN_FUND"){
    const code = normFundCode(p.code);
    const j = await fetchJson(API_BASE + "/api/cn/fund/" + encodeURIComponent(code));
    // expected fields: name, navDate, nav, estNav, estPct, time
    const nav = Number(j?.estNav ?? j?.nav);
    const navDate = j?.navDate || j?.time || null;
    return { ok: true, code, name: j?.name || p.name || code, nav, navDate, raw: j };
  }else{
    const sym = String(p.code).trim().toUpperCase();
    const j = await fetchJson(API_BASE + "/api/tech/stooq/" + encodeURIComponent(sym));
    const series = Array.isArray(j?.series) ? j.series : [];
    const last = series.length ? Number(series[series.length-1]?.close) : null;
    const date = series.length ? series[series.length-1]?.date : null;
    return { ok: true, code: sym, name: p.name || sym, nav: last, navDate: date, raw: j };
  }
}

function deriveShares(costAmt, costNav, shares){
  const a = Number(costAmt);
  const c = Number(costNav);
  const s = Number(shares);
  if(Number.isFinite(s) && s>0) return s;
  if(Number.isFinite(a) && Number.isFinite(c) && c>0) return a / c;
  return null;
}
function deriveCostNav(costAmt, shares, costNav){
  const a = Number(costAmt);
  const s = Number(shares);
  const c = Number(costNav);
  if(Number.isFinite(c) && c>0) return c;
  if(Number.isFinite(a) && Number.isFinite(s) && s>0) return a / s;
  return null;
}

function renderPositions(){
  const ps = loadPositions();
  const hold = loadHoldingCache().map || {};
  const tech = loadTechCache().map || {};

  const body = $("posTable").querySelector("tbody");
  body.innerHTML = "";

  // compute weights by market value if available else by cost
  let totalValue = 0;
  const rows = ps.map(p=>{
    const k = holdingKey(p);
    const h = hold[k];
    const t = tech[k];
    const nav = Number(h?.nav);
    const shares = deriveShares(p.costAmt, p.costNav, p.shares);
    const mv = (Number.isFinite(nav) && Number.isFinite(shares)) ? nav*shares : null;
    const basis = Number(p.costAmt);
    const useV = Number.isFinite(mv) ? mv : (Number.isFinite(basis) ? basis : 0);
    totalValue += useV;
    return { p, k, h, t, nav, shares, mv, basis, useV };
  });

  for(const r of rows){
    const p = r.p;
    const h = r.h || {};
    const t = r.t || {};
    const nav = r.nav;
    const shares = r.shares;
    const mv = r.mv;
    const basis = r.basis;

    const pnl = (Number.isFinite(mv) && Number.isFinite(basis)) ? (mv - basis) : null;
    const pnlPct = (Number.isFinite(pnl) && Number.isFinite(basis) && basis>0) ? (pnl/basis*100) : null;

    const trend = t?.ok ? trendFrom(t.sma20, t.sma60) : "â€”";

    const codeCell = `<div class="mono">${escapeHtml(p.code)}</div><div class="small">${p.type==="CN_FUND" ? "CN_FUND" : "US"}</div>`;
    const nameCell = `<div>${escapeHtml(h?.name || p.name || "")}</div><div class="small muted">${escapeHtml(h?.navDate || "")}</div>`;
    const navCell = Number.isFinite(nav) ? `<div>${fmtNum(nav,4)}</div>${h?.estPct!=null ? `<div class="small muted">${pct(h.estPct,2)} ä¼°</div>`:""}` : "â€”";
    const costCell = Number.isFinite(basis) ? `<div>${fmtMoney(basis,2)}</div><div class="small muted">${Number.isFinite(p.costNav) ? "æˆæœ¬å‡€å€¼ " + fmtNum(p.costNav,4) : (Number.isFinite(shares) ? "ä»½é¢ " + fmtNum(shares,2) : "")}</div>` : "â€”";
    const mvCell = Number.isFinite(mv) ? `<div>${fmtMoney(mv,2)}</div><div class="small muted">${Number.isFinite(shares) ? "ä»½é¢ "+fmtNum(shares,2) : ""}</div>` : "â€”";

    const pnlCell = Number.isFinite(pnl) ? `<div>${(pnl>=0?"+":"")}${fmtMoney(pnl,2)}</div><div class="small muted">${pct(pnlPct,2)}</div>` : "â€”";
    const trendCell = labelTrend(trend);
    const momCell = t?.ok ? labelRet(t.ret20) : "â€”";
    const rsiCell = t?.ok ? labelRsi(t.rsi14) : "â€”";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${codeCell}</td>
      <td>${nameCell}</td>
      <td>${navCell}</td>
      <td>${costCell}</td>
      <td>${mvCell}</td>
      <td>${pnlCell}</td>
      <td>${trendCell}</td>
      <td>${momCell}</td>
      <td>${rsiCell}</td>
      <td><button class="btn small danger" data-delpos="${escapeAttr(p.id)}">åˆ é™¤</button></td>
    `;
    body.appendChild(tr);
  }

  body.querySelectorAll("[data-delpos]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-delpos");
      savePositions(loadPositions().filter(x=>String(x.id)!==String(id)));
      renderPositions();
    });
  });
}

$("btnAddPos").addEventListener("click", async ()=>{
  const type = $("posType").value;
  let code = $("posCode").value.trim();
  if(!code){ alert("è¯·å¡«å†™ä»£ç "); return; }
  if(type==="CN_FUND") code = normFundCode(code);
  else code = code.toUpperCase();

  const costAmt = Number($("posCostAmt").value.trim());
  const costNavIn = $("posCostNav").value.trim();
  const sharesIn = $("posShares").value.trim();
  const nameIn = $("posName").value.trim();

  const shares = sharesIn ? Number(sharesIn) : null;
  const costNav = costNavIn ? Number(costNavIn) : null;

  const ps = loadPositions();
  const item = {
    id: uid("p"),
    type,
    code,
    name: nameIn || null,
    costAmt: Number.isFinite(costAmt) ? costAmt : null,
    shares: Number.isFinite(shares) ? shares : null,
    costNav: Number.isFinite(costNav) ? costNav : null
  };

  // derive missing costNav/shares if possible
  const dShares = deriveShares(item.costAmt, item.costNav, item.shares);
  const dCostNav = deriveCostNav(item.costAmt, dShares, item.costNav);
  item.shares = Number.isFinite(dShares) ? dShares : item.shares;
  item.costNav = Number.isFinite(dCostNav) ? dCostNav : item.costNav;

  ps.push(item);
  savePositions(ps);

  // clear form
  $("posCode").value=""; $("posCostAmt").value=""; $("posCostNav").value=""; $("posShares").value=""; $("posName").value="";

  renderPositions();

  // auto fetch meta for this holding (best effort)
  try{
    $("holdStatus").textContent = "è‡ªåŠ¨æŠ“å–åç§°/å‡€å€¼ä¸­â€¦";
    const meta = await fetchHoldingMeta(item);
    const cache = loadHoldingCache();
    cache.map = cache.map || {};
    cache.map[holdingKey(item)] = { ...meta, ts: nowMs(), nav: meta.nav, name: meta.name, navDate: meta.navDate, estPct: meta.raw?.estPct ?? null };
    saveHoldingCache(cache);
    $("holdStatus").textContent = "å·²æŠ“å–ï¼ˆå»ºè®®ç‚¹â€œåˆ·æ–°å‡€å€¼/æŠ€æœ¯æŒ‡æ ‡â€è¡¥é½æŠ€æœ¯æŒ‡æ ‡ï¼‰";
    renderPositions();
  }catch{
    $("holdStatus").textContent = "è‡ªåŠ¨æŠ“å–å¤±è´¥ï¼ˆå¯ç¨ååˆ·æ–°ï¼‰";
  }
});

$("btnExportPos").addEventListener("click", ()=>{
  const ps = loadPositions();
  const blob = new Blob([JSON.stringify(ps, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "neon_positions.json";
  a.click();
});
$("posImportFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const j = JSON.parse(txt);
    if(!Array.isArray(j)) throw new Error("æ ¼å¼å¿…é¡»æ˜¯æ•°ç»„");
    savePositions(j);
    renderPositions();
    alert("å¯¼å…¥æˆåŠŸ");
  }catch(err){
    alert("å¯¼å…¥å¤±è´¥ï¼š" + String(err));
  }finally{ e.target.value=""; }
});
$("btnClearPos").addEventListener("click", ()=>{
  if(!confirm("æ¸…ç©ºæ‰€æœ‰æŒä»“ï¼Ÿ")) return;
  savePositions([]);
  localStorage.removeItem(LS.holdingCache);
  localStorage.removeItem(LS.techCache);
  renderPositions();
});

let refreshAbort = null;

async function refreshHoldingsAll(){
  const ps = loadPositions();
  if(!ps.length){ alert("è¯·å…ˆæ·»åŠ æŒä»“"); return; }

  if(refreshAbort) refreshAbort.abort();
  refreshAbort = new AbortController();

  $("holdStatus").textContent = "åˆ·æ–°ä¸­ï¼šé€ä¸ªæŠ“å–å‡€å€¼/ä»·æ ¼â€¦";

  const cache = loadHoldingCache();
  cache.map = cache.map || {};

  // paced refresh: 1.2s each to reduce throttling
  for(let i=0;i<ps.length;i++){
    if(refreshAbort.signal.aborted) break;
    const p = ps[i];
    $("holdStatus").textContent = `æŠ“å–å‡€å€¼/ä»·æ ¼ ${i+1}/${ps.length} Â· ${p.code}`;
    try{
      const meta = await fetchHoldingMeta(p);
      cache.map[holdingKey(p)] = { ...meta, ts: nowMs(), nav: meta.nav, name: meta.name, navDate: meta.navDate, estPct: meta.raw?.estPct ?? null };
      saveHoldingCache(cache);
      renderPositions();
    }catch{
      cache.map[holdingKey(p)] = { ok:false, ts: nowMs(), reason:"fetch failed", nav:null, name:p.name||p.code, navDate:null };
      saveHoldingCache(cache);
      renderPositions();
    }
    await sleep(1200);
  }

  if(refreshAbort.signal.aborted){
    $("holdStatus").textContent = "å·²åœæ­¢";
    return;
  }

  $("holdStatus").textContent = "å‡€å€¼/ä»·æ ¼å·²æ›´æ–°ï¼Œå¼€å§‹æ‹‰å–æŠ€æœ¯æŒ‡æ ‡â€¦";

  // tech batch
  try{
    const positions = ps.map(p=>({ type: p.type, code: p.code, name: p.name }));
    const j = await postJson(API_BASE + "/api/tech/batch", { positions }, { timeoutMs: 70000, signal: refreshAbort.signal });
    const items = Array.isArray(j?.items) ? j.items : [];
    const map = {};
    for(const it of items){
      const type = it?.type || (String(it.code||"").match(/^\d{6}$/) ? "CN_FUND" : "US_TICKER");
      const code = String(it.code||"").toUpperCase();
      const key = `${type}:${type==="CN_FUND" ? normFundCode(code) : code}`;
      map[key] = it;
      // also map for US_TICKER keys that might be stored with US_TICKER
      if(type!=="CN_FUND") map[`US_TICKER:${code}`] = it;
    }
    saveTechCache({ ts: nowMs(), map });
    renderPositions();
    $("holdStatus").textContent = "åˆ·æ–°å®Œæˆ âœ…";
  }catch(e){
    $("holdStatus").textContent = "æŠ€æœ¯æŒ‡æ ‡æ‹‰å–å¤±è´¥ï¼ˆç¨åå†è¯•ï¼‰";
  }
}

$("btnRefreshHoldings").addEventListener("click", refreshHoldingsAll);

/* =========================
   Risk engine (simple)
========================= */
function computeRiskEngine(){
  const ps = loadPositions();
  const hold = loadHoldingCache().map || {};
  let total = 0;
  const weights = ps.map(p=>{
    const k = holdingKey(p);
    const nav = Number(hold[k]?.nav);
    const shares = deriveShares(p.costAmt, p.costNav, p.shares);
    const mv = (Number.isFinite(nav) && Number.isFinite(shares)) ? nav*shares : null;
    const basis = Number(p.costAmt);
    const useV = Number.isFinite(mv) ? mv : (Number.isFinite(basis) ? basis : 0);
    total += useV;
    return { code:p.code, type:p.type, useV };
  }).sort((a,b)=>b.useV-a.useV);

  const top1 = weights[0] || null;
  const top3 = weights.slice(0,3).reduce((a,b)=>a+b.useV,0);

  const flags = [];
  const singlePct = total>0 && top1 ? +(top1.useV/total*100).toFixed(1) : null;
  const top3Pct = total>0 ? +(top3/total*100).toFixed(1) : null;
  if(singlePct!=null && singlePct>=35) flags.push({ level:"warn", rule:"å•ä¸€æŒä»“å æ¯”åé«˜", value: singlePct+"%" });
  if(top3Pct!=null && top3Pct>=70) flags.push({ level:"warn", rule:"å‰ä¸‰é›†ä¸­åº¦åé«˜", value: top3Pct+"%" });

  return { totalValue: +total.toFixed(2), top1, singlePct, top3Pct, flags };
}

/* =========================
   Sectors (same as previous paced version)
========================= */
const DEFAULT_SECTORS = [
  { id:"d1", market:"US", theme:"å¤§ç›˜", symbol:"SPY", name:"S&P 500" },
  { id:"d2", market:"US", theme:"ç§‘æŠ€", symbol:"XLK", name:"Technology" },
  { id:"d3", market:"US", theme:"åŠå¯¼ä½“", symbol:"SMH", name:"Semiconductors" },
  { id:"d4", market:"US", theme:"AI/æˆé•¿", symbol:"QQQ", name:"Nasdaq 100" },
  { id:"d5", market:"US", theme:"é‡‘è", symbol:"XLF", name:"Financials" },
  { id:"d6", market:"US", theme:"èƒ½æº", symbol:"XLE", name:"Energy" },
  { id:"d7", market:"US", theme:"è´µé‡‘å±-é»„é‡‘", symbol:"GLD", name:"Gold" },
  { id:"d8", market:"US", theme:"è´µé‡‘å±-ç™½é“¶", symbol:"SLV", name:"Silver" }
];

function getSectors(){
  const custom = loadJson(LS.sectorsCustom, []);
  const hidden = new Set(loadJson(LS.sectorsHidden, []));
  const defaults = DEFAULT_SECTORS.filter(s => !hidden.has(s.id));
  return { merged: [...defaults, ...custom], custom, hidden };
}
function saveCustomSectors(custom){ saveJson(LS.sectorsCustom, custom); }
function saveHiddenDefaults(hiddenIds){ saveJson(LS.sectorsHidden, hiddenIds); }

function sectorKey(s){ return `${s.market||"US"}:${s.symbol}`; }
function loadSectorResults(){ return loadJson(LS.sectorResults, { ts:0, map:{} }); }
function saveSectorResults(obj){ saveJson(LS.sectorResults, obj); }
function loadSectorFailSet(){ return new Set(loadJson(LS.sectorFail, [])); }
function saveSectorFailSet(set){ saveJson(LS.sectorFail, Array.from(set)); }

function renderSectorsManage(){
  const { merged } = getSectors();
  const body = $("sectorManageTable").querySelector("tbody");
  body.innerHTML = "";
  for(const s of merged){
    const isDefault = String(s.id||"").startsWith("d");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(s.theme || "")}</td>
      <td><span class="tag ${s.market==="CN_FUND"?"warn":"info"}">${marketTag(s.market)}</span></td>
      <td class="mono">${escapeHtml(s.symbol || "")}</td>
      <td>${isDefault ? `<button class="btn small secondary" data-hide="${escapeAttr(s.id)}">éšè—</button>` : `<button class="btn small danger" data-del="${escapeAttr(s.id)}">åˆ é™¤</button>`}</td>
    `;
    body.appendChild(tr);
  }
  body.querySelectorAll("[data-hide]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-hide");
      const hiddenIds = loadJson(LS.sectorsHidden, []);
      if(!hiddenIds.includes(id)) hiddenIds.push(id);
      saveHiddenDefaults(hiddenIds);
      renderSectorsManage();
      renderSectorTable();
    });
  });
  body.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-del");
      saveCustomSectors(loadJson(LS.sectorsCustom, []).filter(x=>String(x.id)!==String(id)));
      renderSectorsManage();
      renderSectorTable();
    });
  });
}

$("btnAddSector").addEventListener("click", ()=>{
  const market = $("sectorMarket").value;
  const theme = $("sectorTheme").value.trim();
  const symbolRaw = $("sectorSymbol").value.trim().toUpperCase();
  const name = $("sectorName").value.trim();
  if(!theme || !symbolRaw){ alert("è¯·å¡«å†™ï¼šæ¿å—å + Proxyä»£ç "); return; }
  if(market==="CN_FUND" && !/^\d{6}$/.test(symbolRaw)){ alert("å›½å†…ETF/åŸºé‡‘è¯·å¡«å†™ 6 ä½æ•°å­—ä»£ç "); return; }
  const custom = loadJson(LS.sectorsCustom, []);
  custom.push({ id: uid("c"), market, theme, symbol: symbolRaw, name: name||null });
  saveCustomSectors(custom);
  $("sectorTheme").value=""; $("sectorSymbol").value=""; $("sectorName").value="";
  renderSectorsManage();
  renderSectorTable();
});

$("btnResetSectors").addEventListener("click", ()=>{
  if(!confirm("ç¡®å®šé‡ç½®é»˜è®¤ï¼Ÿä¼šæ¢å¤æ‰€æœ‰é»˜è®¤æ¿å—ï¼Œå¹¶æ¸…ç©ºè‡ªå®šä¹‰ã€‚")) return;
  saveCustomSectors([]); saveHiddenDefaults([]);
  localStorage.removeItem(LS.sectorResults); localStorage.removeItem(LS.sectorFail);
  renderSectorsManage(); renderSectorTable();
});
$("btnExportSectors").addEventListener("click", ()=>{
  const custom = loadJson(LS.sectorsCustom, []);
  const hidden = loadJson(LS.sectorsHidden, []);
  const blob = new Blob([JSON.stringify({ custom, hidden }, null, 2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "neon_sectors.json"; a.click();
});
$("sectorImportFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const j = JSON.parse(await file.text());
    if(Array.isArray(j.custom)) saveCustomSectors(j.custom);
    if(Array.isArray(j.hidden)) saveHiddenDefaults(j.hidden);
    alert("å¯¼å…¥æˆåŠŸ");
    renderSectorsManage(); renderSectorTable();
  }catch(err){ alert("å¯¼å…¥å¤±è´¥ï¼š" + String(err)); }
  finally{ e.target.value=""; }
});

function renderSectorTable(){
  const { merged } = getSectors();
  const cache = loadSectorResults();
  const tbody = $("sectorTable").querySelector("tbody");
  tbody.innerHTML = "";
  for(const s of merged){
    const key = sectorKey(s);
    const r = cache.map?.[key] || null;
    const ok = r?.ok === true;
    const t = ok ? trendFrom(r.sma20, r.sma60) : "â€”";
    const status = ok ? `<span class="tag good">OK</span>` : `<span class="tag bad">æš‚æ— æ•°æ®</span>`;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(s.theme)} <span class="small muted">Â· ${escapeHtml(s.name || "")}</span></td>
      <td><span class="tag ${s.market==="CN_FUND"?"warn":"info"}">${marketTag(s.market)}</span></td>
      <td class="mono">${escapeHtml(s.symbol)}</td>
      <td>${labelTrend(t)}</td>
      <td>${ok ? labelRet(r?.ret20) : "â€”"}</td>
      <td>${ok ? labelRsi(r?.rsi14) : "â€”"}</td>
      <td>${status}<div class="small muted">${escapeHtml(r?.reason || "")}</div></td>
    `;
    tbody.appendChild(tr);
  }
}

/* Paced scan */
let scanAbort = null;
function setScanStatus(txt){ $("scanStatus").textContent = txt; }

async function scanAll({force=false, onlyFailed=false}={}){
  const { merged } = getSectors();
  if(!merged.length){ setScanStatus("æ²¡æœ‰æ¿å—"); return; }

  if(scanAbort) scanAbort.abort();
  scanAbort = new AbortController();

  const cache = loadSectorResults();
  const map = cache.map || {};
  const failSet = loadSectorFailSet();

  const ttlOk = 6*60*60*1000;
  const ttlFail = 10*60*1000;
  const now = nowMs();

  const work = [];
  for(const s of merged){
    const key = sectorKey(s);
    const r = map[key];
    const age = r?.ts ? (now - r.ts) : Infinity;
    const isOk = r?.ok === true;
    const shouldByFail = onlyFailed ? failSet.has(key) : true;
    if(!shouldByFail) continue;
    if(force){ work.push(s); continue; }
    if(isOk && age < ttlOk) continue;
    if(!isOk && age < ttlFail) continue;
    work.push(s);
  }

  if(!work.length){
    setScanStatus("æ— éœ€åˆ·æ–°ï¼ˆç¼“å­˜ä»æœ‰æ•ˆï¼‰ã€‚å¯ç‚¹â€œå¼ºåˆ¶é‡æ‰«å¤±è´¥é¡¹â€ã€‚");
    renderSectorTable(); return;
  }

  const total = work.length;
  setScanStatus(`å¼€å§‹æ…¢æ‰« ${total} ä¸ªï¼ˆ1ä¸ª/15ç§’ï¼‰`);
  renderSectorTable();

  let done = 0;
  for(const s of work){
    if(scanAbort.signal.aborted){ setScanStatus("å·²åœæ­¢"); break; }
    done += 1;
    setScanStatus(`æ‰«æä¸­â€¦ ${done}/${total} Â· ${s.symbol}ï¼ˆ${marketTag(s.market)}ï¼‰`);

    try{
      const j = await postJson(API_BASE + "/api/sector/scan", { items:[s] }, { timeoutMs: 45000, signal: scanAbort.signal });
      const item = j?.items?.[0];
      if(item){
        const key = sectorKey(s);
        map[key] = { ...item, ts: nowMs(), market:s.market, theme:s.theme, symbol:s.symbol, name:s.name||item.name||null };
        if(item.ok) failSet.delete(key);
        else failSet.add(key);
      }
      saveSectorResults({ ts: nowMs(), map });
      saveSectorFailSet(failSet);
      renderSectorTable();
    }catch{
      const key = sectorKey(s);
      map[key] = { ok:false, reason:"request failed/timeout", ts: nowMs(), market:s.market, theme:s.theme, symbol:s.symbol, name:s.name||null };
      failSet.add(key);
      saveSectorResults({ ts: nowMs(), map });
      saveSectorFailSet(failSet);
      renderSectorTable();
    }

    if(done < total){
      for(let t=15; t>=1; t--){
        if(scanAbort.signal.aborted) break;
        setScanStatus(`å·²å®Œæˆ ${done}/${total} Â· ç­‰å¾… ${t}s åç»§ç»­â€¦`);
        await sleep(1000);
      }
    }
  }

  if(!scanAbort.signal.aborted){
    const left = Array.from(failSet).filter(k=>merged.some(s=>sectorKey(s)===k)).length;
    setScanStatus(left ? `æ‰«æå®Œæˆï¼ˆä»æœ‰ ${left} ä¸ªå¤±è´¥é¡¹ï¼Œå¯ç‚¹â€œå¼ºåˆ¶é‡æ‰«å¤±è´¥é¡¹â€ï¼‰` : "æ‰«æå®Œæˆ âœ…");
  }
}

$("btnScan").addEventListener("click", ()=>scanAll({force:false, onlyFailed:false}));
$("btnStopScan").addEventListener("click", ()=>{ if(scanAbort) scanAbort.abort(); setScanStatus("å·²åœæ­¢"); });
$("btnForceScan").addEventListener("click", ()=>scanAll({force:true, onlyFailed:true}));

/* =========================
   Prompts + Keywords (dual-track)
========================= */
const DEFAULT_PROMPTS = {
  system: `ä½ æ˜¯æŠ•èµ„ç»„åˆåˆ†æåŠ©æ‰‹ã€‚å¿…é¡»ä¸¥æ ¼åŸºäºæˆ‘æä¾›çš„æ•°æ®ï¼ˆæŒä»“ã€æŠ€æœ¯æŒ‡æ ‡ã€æ¿å—åŠ¨å‘ã€æ–°é—»æ‘˜è¦ã€é£æ§æ ¡éªŒï¼‰è¿›è¡Œæ¨ç†ï¼Œä¸å¾—ç¼–é€ æ•°æ®æˆ–å¼•ç”¨ä¸å­˜åœ¨çš„æ¥æºã€‚ç¦æ­¢ä½¿ç”¨â€œä¿è¯æ”¶ç›Š/è‚¯å®šæ¶¨/ç°åœ¨å¿…é¡»ä¹°â€ç­‰ç¡®å®šæ€§æ‰¿è¯ºã€‚è¾“å‡ºå¿…é¡»åŒ…å«ï¼šNow / Next7d / Avoidï¼Œå¹¶ç»™å‡ºæ¸…æ™°ç†ç”±ã€‚`,
  analysis: `åˆ†æç›®æ ‡ï¼šç»™å¿™ç¢Œç”¨æˆ·æä¾›å¯æ‰§è¡Œã€ä½ç»´æŠ¤æˆæœ¬çš„å»ºè®®ã€‚ä¼˜å…ˆé£é™©æ§åˆ¶ä¸åˆ†æ•£ï¼Œé¿å…è¿½é«˜ã€‚å¯ä»¥ç»™â€œæ›´è¿›å–/æ›´ä¿å®ˆâ€ä¸¤å¥—æ–¹æ¡ˆï¼ˆå„ä¸è¶…è¿‡3æ¡ï¼‰ã€‚`,
  task: `ä»»åŠ¡ï¼šè¯·ä¸€æ¬¡æ€§ç»™å‡ºå…¨å±€åˆ†æï¼ˆä¸Šå¸è§†è§’ï¼‰ï¼Œè¾“å‡ºä¸‰å—å†…å®¹ï¼š
1) é£é™©ï¼šæœªæ¥1-4å‘¨ä¸»è¦é£é™©ç‚¹ã€æœ€è¯¥é˜²çš„å‘ã€ä»¥åŠä½ åŸºäºå“ªäº›ä¿¡å·å¾—å‡ºç»“è®ºï¼›
2) æŒä»“ï¼šå¯¹æ¯ä¸ªæŒä»“ç»™å‡ºåŠ¨ä½œå»ºè®®ï¼ˆæŒæœ‰/å‡ä»“/è§‚å¯Ÿ/åˆ†æ‰¹åŠ ï¼‰ï¼Œå¹¶è¯´æ˜ç†ç”±ï¼ˆå‡€å€¼/åŠ¨é‡/RSI/æ–°é—»ï¼‰ï¼›
3) æœºä¼šï¼šåŸºäºæ¿å—åŠ¨å‘+æ–°é—»ï¼ŒæŒ‘å‡º3-6ä¸ªå€¼å¾—ç•™æ„çš„æ¿å—ï¼ˆæ¯ä¸ªï¼šä¸€å¥ç†ç”± + åŠ¨ä½œå»ºè®® + ç½®ä¿¡åº¦ + é£é™©ç‚¹ï¼‰ã€‚
æœ€åå†ç»™ Now / Next7d / Avoid ä¸‰æ®µåŠ¨ä½œæ€»ç»“ã€‚`
};

const DEFAULT_KW = {
  settings: { sites:["reuters.com","ft.com","wsj.com","bloomberg.com"] },
  defaultGroups: [
    { id:"macro", name:"å®è§‚/åˆ©ç‡/æ±‡ç‡", enabled:true, weight:5, maxItems:3,
      zh:["ç¾è”å‚¨ åˆ©ç‡ ç‚¹é˜µå›¾","ç¾å…ƒæŒ‡æ•° èµ°å¼º","ä¸­å›½ é™å‡† é™æ¯","äººæ°‘å¸ æ±‡ç‡ æ³¢åŠ¨"],
      en:["Fed rates hold dot plot","US dollar index strength","PBOC RRR cut rate cut","USD/CNY moves"]
    },
    { id:"china_internet", name:"ä¸­å›½äº’è”ç½‘/æ¸¯è‚¡ç§‘æŠ€", enabled:true, weight:5, maxItems:3,
      zh:["æ¸¯è‚¡ç§‘æŠ€ ç›‘ç®¡","å¹³å°ç»æµ æ”¿ç­–","æ’ç”Ÿç§‘æŠ€ èµ„é‡‘æµ"],
      en:["China internet platforms regulation update","Hang Seng Tech Index rally drivers","Tencent Alibaba Meituan news"]
    },
    { id:"ai", name:"AI/ç®—åŠ›/åŠå¯¼ä½“", enabled:true, weight:5, maxItems:3,
      zh:["è‹±ä¼Ÿè¾¾ è´¢æŠ¥ æŒ‡å¼•","ç®—åŠ› è®¢å• æœåŠ¡å™¨","åŠå¯¼ä½“ äº§ä¸šé“¾ æ™¯æ°”"],
      en:["Nvidia earnings guidance AI demand","AI server orders datacenter capex","semiconductor cycle outlook"]
    },
    { id:"commod", name:"è´µé‡‘å±/å¤§å®—", enabled:true, weight:4, maxItems:2,
      zh:["é»„é‡‘ ä»·æ ¼ èµ°å¼º","ç™½é“¶ æ³¢åŠ¨","ç¾å€ºæ”¶ç›Šç‡ é‡‘ä»·"],
      en:["gold prices rise yields","silver volatility","real yields and gold"]
    }
  ],
  customGroups: []
};

function loadPrompts(){ return loadJson(LS.prompt, null) || structuredClone(DEFAULT_PROMPTS); }
function savePrompts(p){ saveJson(LS.prompt, p); }
function loadKeywords(){ return loadJson(LS.keywords, null) || structuredClone(DEFAULT_KW); }
function saveKeywords(k){ saveJson(LS.keywords, k); }

function openModal(id){ $(id).style.display = "flex"; }
function closeModal(id){ $(id).style.display = "none"; }
document.addEventListener("click", (e)=>{
  const closeId = e.target?.getAttribute?.("data-close");
  if(closeId) closeModal(closeId);
  if(e.target.classList.contains("modal-backdrop")) e.target.style.display="none";
});

$("fabGuide").addEventListener("click", ()=>openModal("modalGuide"));
$("fabPrompt").addEventListener("click", ()=>{ syncPromptModal(); openModal("modalPrompt"); });
$("fabKeywords").addEventListener("click", ()=>{ syncKeywordsModal(); openModal("modalKeywords"); });

function syncPromptModal(){
  const p = loadPrompts();
  $("promptSystem").value = p.system || "";
  $("promptAnalysis").value = p.analysis || "";
  $("promptTask").value = p.task || "";
}
$("btnPromptSave").addEventListener("click", ()=>{
  const p = loadPrompts();
  p.system = $("promptSystem").value || "";
  p.analysis = $("promptAnalysis").value || "";
  p.task = $("promptTask").value || "";
  savePrompts(p);
  alert("Prompt å·²ä¿å­˜");
});
$("btnPromptReset").addEventListener("click", ()=>{
  if(!confirm("æ¢å¤é»˜è®¤ Promptï¼Ÿ")) return;
  savePrompts(structuredClone(DEFAULT_PROMPTS));
  syncPromptModal();
  alert("å·²æ¢å¤é»˜è®¤");
});
$("btnPromptExport").addEventListener("click", ()=>{
  const p = loadPrompts();
  const blob = new Blob([JSON.stringify(p, null, 2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "neon_prompts.json"; a.click();
});
$("promptImportFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const j = JSON.parse(await file.text());
    if(!j.system || !j.analysis || !j.task) throw new Error("æ ¼å¼å¿…é¡»åŒ…å« system/analysis/task");
    savePrompts(j); syncPromptModal(); alert("å¯¼å…¥æˆåŠŸ");
  }catch(err){ alert("å¯¼å…¥å¤±è´¥ï¼š" + String(err)); }
  finally{ e.target.value=""; }
});

function renderKwGroupEditor(container, group, {isCustom=false}={}){
  const wrap = document.createElement("div");
  wrap.style.border = "1px solid var(--line)";
  wrap.style.borderRadius = "14px";
  wrap.style.padding = "10px";
  wrap.style.background = "rgba(7,7,10,.35)";
  wrap.style.marginBottom = "10px";

  wrap.innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div><span class="tag ${group.enabled?"good":"bad"}">${group.enabled?"å¯ç”¨":"ç¦ç”¨"}</span> <b>${escapeHtml(group.name)}</b></div>
      <div class="row">
        ${isCustom ? `<button class="btn small danger" data-kwdel="${escapeAttr(group.id)}">åˆ é™¤</button>` : ``}
        <button class="btn small secondary" data-kvtoggle="${escapeAttr(group.id)}">${group.enabled?"ç¦ç”¨":"å¯ç”¨"}</button>
      </div>
    </div>
    <div class="two" style="margin-top:10px;">
      <div>
        <div class="small">ä¸­æ–‡å…³é”®è¯ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</div>
        <textarea class="mono" data-kwzh="${escapeAttr(group.id)}">${(group.zh||[]).join("\n")}</textarea>
      </div>
      <div>
        <div class="small">è‹±æ–‡å…³é”®è¯ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</div>
        <textarea class="mono" data-kwen="${escapeAttr(group.id)}">${(group.en||[]).join("\n")}</textarea>
      </div>
    </div>
    ${isCustom ? `
      <div class="small" style="margin-top:10px;">ç»„åï¼ˆå¯æ”¹ï¼‰</div>
      <input data-kwname="${escapeAttr(group.id)}" value="${escapeAttr(group.name)}">
    ` : ``}
  `;
  container.appendChild(wrap);
}

function syncKeywordsModal(){
  const kw = loadKeywords();
  $("kwSites").value = (kw.settings?.sites || []).join(", ");

  const def = $("kwDefault");
  const cus = $("kwCustom");
  def.innerHTML = ""; cus.innerHTML = "";
  for(const g of kw.defaultGroups||[]) renderKwGroupEditor(def, g, {isCustom:false});
  for(const g of kw.customGroups||[]) renderKwGroupEditor(cus, g, {isCustom:true});

  $("modalKeywords").querySelectorAll("[data-kvtoggle]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-kvtoggle");
      const k2 = loadKeywords();
      const g = (k2.defaultGroups||[]).find(x=>x.id===id) || (k2.customGroups||[]).find(x=>x.id===id);
      if(g){ g.enabled = !g.enabled; saveKeywords(k2); syncKeywordsModal(); }
    });
  });
  $("modalKeywords").querySelectorAll("[data-kwdel]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-kwdel");
      const k2 = loadKeywords();
      k2.customGroups = (k2.customGroups||[]).filter(x=>x.id!==id);
      saveKeywords(k2); syncKeywordsModal();
    });
  });
}

function readKwEdits(){
  const kw = loadKeywords();
  const sites = $("kwSites").value.split(",").map(s=>s.trim()).filter(Boolean);
  kw.settings = kw.settings || {};
  kw.settings.sites = sites;

  const getLines = (v)=>String(v||"").split("\n").map(s=>s.trim()).filter(Boolean);
  const apply = (g)=>{
    const zhEl = document.querySelector(`[data-kwzh="${cssEsc(g.id)}"]`);
    const enEl = document.querySelector(`[data-kwen="${cssEsc(g.id)}"]`);
    const nEl  = document.querySelector(`[data-kwname="${cssEsc(g.id)}"]`);
    if(zhEl) g.zh = getLines(zhEl.value);
    if(enEl) g.en = getLines(enEl.value);
    if(nEl) g.name = String(nEl.value||g.name);
  };
  (kw.defaultGroups||[]).forEach(apply);
  (kw.customGroups||[]).forEach(apply);
  return kw;
}

$("btnKwSave").addEventListener("click", ()=>{
  saveKeywords(readKwEdits());
  alert("å…³é”®è¯åº“å·²ä¿å­˜");
});
$("btnKwReset").addEventListener("click", ()=>{
  if(!confirm("æ¢å¤é»˜è®¤å…³é”®è¯åº“ï¼Ÿ")) return;
  saveKeywords(structuredClone(DEFAULT_KW));
  syncKeywordsModal();
});
$("btnKwExport").addEventListener("click", ()=>{
  const kw = readKwEdits();
  const blob = new Blob([JSON.stringify(kw, null, 2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "neon_keywords.json"; a.click();
});
$("kwImportFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const j = JSON.parse(await file.text());
    if(!j.defaultGroups || !j.customGroups) throw new Error("æ ¼å¼ä¸å¯¹");
    saveKeywords(j);
    syncKeywordsModal();
    alert("å¯¼å…¥æˆåŠŸ");
  }catch(err){ alert("å¯¼å…¥å¤±è´¥ï¼š" + String(err)); }
  finally{ e.target.value=""; }
});
$("btnKwAddCustom").addEventListener("click", ()=>{
  const kw = loadKeywords();
  kw.customGroups = kw.customGroups || [];
  kw.customGroups.push({ id: uid("k"), name:"è‡ªå®šä¹‰ä¸»é¢˜", enabled:true, zh:[], en:[] });
  saveKeywords(kw);
  syncKeywordsModal();
});

$("btnKwBuildQueries").addEventListener("click", ()=>{
  const kw = readKwEdits();
  const sites = (kw.settings?.sites || []);
  const siteExpr = sites.length ? " (" + sites.map(s=>"site:"+s).join(" OR ") + ")" : "";
  const groups = [...(kw.defaultGroups||[]), ...(kw.customGroups||[])].filter(g=>g.enabled);
  const lines = [];
  for(const g of groups){
    lines.push(`## ${g.name}`);
    for(const q of (g.zh||[])) lines.push(`- ${q}${siteExpr}`);
    for(const q of (g.en||[])) lines.push(`- ${q}${siteExpr}`);
    lines.push("");
  }
  $("kwQueries").value = lines.join("\n").trim();
  saveKeywords(kw);
});

function cssEsc(s){ return String(s).replace(/"/g,'\\"'); }

/* =========================
   Compose AI (God View)
========================= */
function currentPayload(){
  const ps = loadPositions();
  const holding = loadHoldingCache();
  const tech = loadTechCache();
  const sectorCache = loadSectorResults();
  const { merged } = getSectors();
  const sectors = merged.map(s=>{
    const k = sectorKey(s);
    const r = sectorCache.map?.[k];
    return r ? { ...r, market:s.market, theme:s.theme, symbol:s.symbol, name:s.name||null } : { ok:false, market:s.market, theme:s.theme, symbol:s.symbol, name:s.name||null, reason:"no scan yet" };
  });

  const newsDigest = ($("newsBox").value || "").trim();
  const newsItems = loadNewsItems();

  return {
    meta: { app:"NEON QUANT", ts: new Date().toISOString() },
    holdings: ps.map(p=>{
      const k = holdingKey(p);
      const h = holding.map?.[k] || null;
      const t = tech.map?.[k] || null;
      const nav = Number(h?.nav);
      const shares = deriveShares(p.costAmt, p.costNav, p.shares);
      const mv = (Number.isFinite(nav) && Number.isFinite(shares)) ? nav*shares : null;
      const pnl = (Number.isFinite(mv) && Number.isFinite(Number(p.costAmt))) ? (mv - Number(p.costAmt)) : null;
      return {
        ...p,
        name: h?.name || p.name || null,
        navDate: h?.navDate || null,
        nav: Number.isFinite(nav) ? nav : null,
        estPct: h?.estPct ?? null,
        shares: Number.isFinite(shares) ? shares : null,
        marketValue: Number.isFinite(mv) ? mv : null,
        pnl: Number.isFinite(pnl) ? pnl : null,
        tech: t || null
      };
    }),
    sectors,
    news: {
      digest: newsDigest || null,
      items: newsItems
    },
    riskEngine: computeRiskEngine(),
    keywordLibrary: loadKeywords()
  };
}

function composeMarkdown(){
  const prompts = loadPrompts();
  const payload = currentPayload();

  const reduced = structuredClone(payload);

  if(!$("feedHoldings").checked){
    reduced.holdings = [];
  }
  if(!$("feedSectors").checked){
    reduced.sectors = [];
  }
  if(!$("feedNews").checked){
    reduced.news = { digest: null, items: [] };
  }
  if(!$("feedRisk").checked){
    reduced.riskEngine = { note:"ï¼ˆå·²å…³é—­é£æ§æ ¡éªŒå–‚å…¥ï¼‰" };
  }

  const md = [
`# NEON QUANT // ä¸€é”®å…¨å±€åˆ†æè¾“å…¥`,
``,
`## System Prompt`,
(prompts.system||"").trim(),
``,
`## Analysis Prompt`,
(prompts.analysis||"").trim(),
``,
`## Task Prompt`,
(prompts.task||"").trim(),
``,
`## Data Payload (JSON)`,
"```json",
JSON.stringify(reduced, null, 2),
"```",
``,
`## Output format requirement`,
`- é£é™©ï¼š1-4å‘¨ä¸»è¦é£é™© + ä½ å¼•ç”¨äº†å“ªäº›ä¿¡å·`,
`- æŒä»“ï¼šé€ä¸ªç»™åŠ¨ä½œå»ºè®®ï¼ˆæŒæœ‰/å‡ä»“/è§‚å¯Ÿ/åˆ†æ‰¹åŠ ï¼‰+ ç†ç”±`,
`- æœºä¼šï¼š3-6ä¸ªæ¿å—æœºä¼šï¼ˆç†ç”±/åŠ¨ä½œ/ç½®ä¿¡åº¦/é£é™©ç‚¹ï¼‰`,
`- Now / Next7d / Avoidï¼šä¸‰æ®µæ€»ç»“`
  ].join("\n");

  return { md, reduced };
}

$("btnComposeGod").addEventListener("click", async ()=>{
  const { md } = composeMarkdown();
  await copyToClipboard(md);
  alert("å·²å¤åˆ¶ï¼šç›´æ¥ç²˜è´´ç»™ ChatGPT å³å¯å¾—åˆ°å…¨å±€åˆ†æã€‚");
});

$("btnShowPayload").addEventListener("click", ()=>{
  const { reduced } = composeMarkdown();
  $("payloadBox").value = JSON.stringify(reduced, null, 2);
  openModal("modalPayload");
});
$("btnCopyPayload").addEventListener("click", async ()=>{
  await copyToClipboard($("payloadBox").value || "");
  alert("å·²å¤åˆ¶JSON");
});

/* =========================
   Boot
========================= */
initApiBase();
initNews();
renderPositions();
renderSectorsManage();
renderSectorTable();
checkHealth();

// If no prompts/keywords, initialize
if(!localStorage.getItem(LS.prompt)) savePrompts(structuredClone(DEFAULT_PROMPTS));
if(!localStorage.getItem(LS.keywords)) saveKeywords(structuredClone(DEFAULT_KW));
</script>
</body>
</html>
