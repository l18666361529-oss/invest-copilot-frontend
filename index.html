<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>NEON QUANT // éœ“è™¹æŠ•ç ”èˆ± v3</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#0f1620; --mut:#93a4b7; --fg:#e8f0ff;
      --pri:#7c5cff; --pri2:#14f195; --bd:rgba(255,255,255,.08);
      --danger:#ff4d6d; --warn:#ffd166;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(124,92,255,.28), transparent 60%),
        radial-gradient(1100px 650px at 85% -15%, rgba(20,241,149,.20), transparent 60%),
        radial-gradient(900px 520px at 50% 110%, rgba(124,92,255,.12), transparent 55%),
        linear-gradient(180deg, rgba(10,14,20,1), rgba(8,11,16,1));
      color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        linear-gradient(rgba(124,92,255,.10) 1px, transparent 1px),
        linear-gradient(90deg, rgba(20,241,149,.08) 1px, transparent 1px);
      background-size: 44px 44px, 44px 44px;
      opacity:.20;
      mix-blend-mode: screen;
      transform: translateZ(0);
      animation: gridDrift 14s linear infinite;
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.05) 0px,
          rgba(255,255,255,.05) 1px,
          transparent 3px,
          transparent 6px
        );
      opacity:.07;
      mix-blend-mode: overlay;
      transform: translateZ(0);
      animation: scanMove 9s linear infinite;
    }
    @keyframes gridDrift{
      0%{ background-position: 0 0, 0 0; }
      100%{ background-position: 120px 200px, 200px 120px; }
    }
    @keyframes scanMove{
      0%{ background-position: 0 0; }
      100%{ background-position: 0 140px; }
    }

    a{ color:inherit; }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 14px 14px 120px; position:relative; }
    .wrap::before{
      content:"";
      position:absolute; inset:-80px -40px auto -40px;
      height: 260px;
      background:
        radial-gradient(closest-side at 20% 30%, rgba(124,92,255,.22), transparent 70%),
        radial-gradient(closest-side at 80% 40%, rgba(20,241,149,.18), transparent 70%);
      filter: blur(12px);
      opacity:.9;
      pointer-events:none;
      z-index:-1;
    }

    .topbar{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,15,20,.92), rgba(11,15,20,.65));
      border-bottom: 1px solid var(--bd);
    }
    .topbar .inner{ max-width:980px; margin:0 auto; padding:12px 14px; display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .brand{ display:flex; gap:10px; align-items:center; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border:1px solid var(--bd); border-radius:999px;
      background: rgba(255,255,255,.03);
      font-size:12px; color: var(--mut);
      user-select:none;
    }
    .pill{ padding:4px 8px; border-radius:999px; border:1px solid var(--bd); font-size:12px; color:var(--mut); background:rgba(255,255,255,.03); }
    .pill.cn{ border-color:rgba(20,241,149,.35); color:#bfffe8; }
    .pill.us{ border-color:rgba(124,92,255,.35); color:#d9d1ff; }

    .grid{ display:grid; gap:12px; }
    @media (min-width:860px){ .grid{ grid-template-columns: 1fr 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--bd);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
    }
    h3{ margin:0 0 10px; font-size:16px; }
    .mut{ color: var(--mut); }
    .small{ font-size:12px; line-height: 1.45; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.03);
      color:var(--fg);
      outline:none;
      font-size:14px;
    }
    textarea{ min-height: 84px; resize: vertical; }

    button{
      border:1px solid var(--bd);
      background: rgba(255,255,255,.04);
      color:var(--fg);
      padding:12px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      touch-action: manipulation;
    }
    button.primary{
      background: linear-gradient(135deg, rgba(124,92,255,.85), rgba(20,241,149,.55));
      border-color: rgba(255,255,255,.12);
    }
    button.secondary{ background: rgba(255,255,255,.02); }
    button.danger{ background: rgba(255,77,109,.12); border-color: rgba(255,77,109,.25); }
    button:active{ transform: translateY(1px); }

    .list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .li{
      border:1px solid var(--bd);
      background: rgba(255,255,255,.02);
      border-radius:14px;
      padding:12px;
    }
    .liHead{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; }
    .liTitle{ font-weight:800; }
    .liMeta{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px; }
    .tags{ display:flex; gap:6px; flex-wrap:wrap; }
    .tag{
      font-size:12px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.02);
      color: var(--mut);
      user-select:none;
    }
    .tag.good{ border-color: rgba(20,241,149,.35); color:#bfffe8; }
    .tag.bad{ border-color: rgba(255,77,109,.35); color:#ffd1da; }
    .tag.warn{ border-color: rgba(255,209,102,.35); color:#fff3c4; }

    .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .kpi .box{ flex:1 1 150px; border:1px solid var(--bd); border-radius:14px; padding:10px; background: rgba(255,255,255,.02); }
    .kpi .v{ font-size:18px; font-weight:900; }
    .kpi .l{ font-size:12px; color: var(--mut); }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .scroll{ max-height: 360px; overflow:auto; -webkit-overflow-scrolling: touch; padding-right: 2px; }
    details summary{ cursor:pointer; padding:8px 0; color: var(--mut); font-weight:800; }

    /* Modal / sheet (scrollable) */
    .mask{
      position:fixed; inset:0; z-index:20;
      background: rgba(0,0,0,.55);
      display:none;
      padding: 16px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .mask.show{ display:block; }

    .sheet{
      max-width: 980px;
      margin: 0 auto;
      background: linear-gradient(180deg, rgba(15,22,32,.98), rgba(15,22,32,.92));
      border:1px solid var(--bd);
      border-radius: 18px;
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
      overflow:hidden;
      max-height: calc(100vh - 32px);
      display:flex;
      flex-direction:column;
    }
    .sheetHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 14px 14px;
      border-bottom: 1px solid var(--bd);
      flex: 0 0 auto;
    }
    .sheetBody{
      padding: 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }
    .sheetFoot{
      padding: 14px; border-top:1px solid var(--bd);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      flex: 0 0 auto;
      background: linear-gradient(180deg, rgba(15,22,32,.55), rgba(15,22,32,.92));
      position: sticky; bottom: 0;
    }
    .xbtn{ width:42px; height:42px; border-radius: 14px; display:grid; place-items:center; }

    /* Floating guide button */
    .fab{
      position: fixed;
      right: 14px;
      bottom: calc(14px + env(safe-area-inset-bottom));
      z-index: 15;
      border-radius: 999px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(124,92,255,.20);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
      display:flex; gap:8px; align-items:center;
      user-select:none;
    }
    .fab .dot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(20,241,149,.85));
      box-shadow: 0 0 18px rgba(124,92,255,.45);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="badge"><span style="opacity:.9">NEON QUANT</span> <span class="pill mono" id="buildTag">v3</span></div>
        <div class="badge small">ç§»åŠ¨ç«¯ä¼˜å…ˆ Â· æ•°æ®é©±åŠ¨ Â· ä¸æ‰¿è¯ºæ”¶ç›Š</div>
      </div>
      <div class="row">
        <button class="secondary" onclick="openPromptManager()">ğŸ§© Prompt ç®¡ç†</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <div class="card">
        <h3>â‘  åç«¯åœ°å€</h3>
        <div class="row">
          <input id="backend" placeholder="ä¾‹å¦‚ï¼šhttps://your-backend.example.com" />
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="primary" onclick="saveBackend()">ä¿å­˜</button>
          <button class="secondary" onclick="checkHealth()">å¥åº·æ£€æŸ¥</button>
        </div>
        <div class="mut small" id="healthOut" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <h3>â‘¡ AI é…ç½®ï¼ˆOpenAI å…¼å®¹ï¼‰</h3>
        <div class="row">
          <input id="aiBase" placeholder="BaseUrlï¼Œä¾‹å¦‚ï¼šhttps://api.openai.com" />
        </div>
        <div class="row" style="margin-top:10px;">
          <input id="aiKey" placeholder="API Keyï¼ˆä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼‰" />
        </div>
        <div class="row" style="margin-top:10px;">
          <input id="aiModel" placeholder="Modelï¼Œä¾‹å¦‚ï¼šgpt-4.1-mini / gpt-4o-mini / deepseek-chat..." />
        </div>
        <div class="row" style="margin-top:10px;">
          <select id="outLang">
            <option value="zh">è¾“å‡ºï¼šä¸­æ–‡</option>
            <option value="en">è¾“å‡ºï¼šEnglish</option>
            <option value="bi">è¾“å‡ºï¼šä¸­è‹±åŒè¯­</option>
          </select>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="primary" onclick="saveAI()">ä¿å­˜</button>
          <button class="secondary" onclick="clearAI()">æ¸…ç©º</button>
        </div>
        <div class="mut small" id="aiCfgOut" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <h3>â‘¢ æˆ‘çš„æŒä»“ï¼ˆå«æŠ€æœ¯/é£æ§æ‘˜è¦ï¼‰</h3>
        <div class="row">
          <button class="primary" onclick="openPosEditor()">â• æ·»åŠ æŒä»“</button>
          <button class="secondary" onclick="refreshAll()">ğŸ”„ åˆ·æ–°è¡Œæƒ…/å‡€å€¼</button>
          <button class="secondary" onclick="refreshRisk()">ğŸ›¡ é£æ§æ£€æŸ¥</button>
          <button class="secondary" onclick="refreshTech()">ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡</button>
        </div>
        <div class="kpi">
          <div class="box"><div class="v" id="kpiMV">-</div><div class="l">æ€»å¸‚å€¼</div></div>
          <div class="box"><div class="v" id="kpiPNL">-</div><div class="l">æ€»ç›ˆäº</div></div>
          <div class="box"><div class="v" id="kpiPNLP">-</div><div class="l">æ€»æ”¶ç›Šç‡</div></div>
        </div>

        <details open style="margin-top:10px;">
          <summary>æŒä»“åˆ—è¡¨ï¼ˆç‚¹å¼€æ¯æ¡å¯ç¼–è¾‘/åˆ é™¤ï¼‰</summary>
          <div id="posList" class="list"></div>
        </details>

        <details style="margin-top:10px;">
          <summary>é£æ§æ‘˜è¦</summary>
          <div class="li">
            <div class="liHead">
              <div>
                <div class="liTitle">é£é™©ç­‰çº§ï¼š<span id="riskLevel">-</span></div>
                <div class="mut small" id="riskExplain">-</div>
              </div>
              <div class="tags">
                <span class="tag" id="riskSuggest">å»ºè®®æ€»ä»“ä½ï¼š-</span>
              </div>
            </div>
            <div class="mut small" style="margin-top:8px;" id="riskDetail">-</div>
          </div>
        </details>

        <div class="mut small" style="margin-top:10px;">
          æŠ€æœ¯/é£æ§ä»…ç”¨äºâ€œæç¤ºé£é™©ä¸çŠ¶æ€â€ï¼Œä¸ç­‰äºä¹°å–å»ºè®®ï¼›çœŸæ­£åŠ¨ä½œè¯·ç»“åˆä½ çš„ç›®æ ‡ã€æœŸé™ã€å›æ’¤æ‰¿å—åŠ›ã€‚
        </div>
      </div>

      <div class="card">
        <h3>â‘£ æ–°é—»ä¸æ”¿ç­–ï¼ˆæ”¯æŒç¾å›½æ¥æº + ä¸­è‹±å…³é”®è¯ï¼‰</h3>
        <div class="row">
          <textarea id="kwZh" placeholder="ä¸­æ–‡å…³é”®è¯ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰ï¼šä¾‹å¦‚ é™å‡†, åœ°äº§, å›½ä¼æ”¹é©, æ’ç”Ÿç§‘æŠ€, æ•°æ®è¦ç´ ..."></textarea>
        </div>
        <div class="row" style="margin-top:10px;">
          <textarea id="kwEn" placeholder="English keywords (comma-separated): e.g. Fed, rate cut, CPI, Nvidia, AI chips, China stimulus..."></textarea>
        </div>

        <div class="row" style="margin-top:10px;">
          <select id="newsSourcePreset">
            <option value="mixed">æ¥æºï¼šæ··åˆï¼ˆä¸­+ç¾ï¼‰</option>
            <option value="us">æ¥æºï¼šç¾å›½ä¸ºä¸»</option>
            <option value="cn">æ¥æºï¼šä¸­å›½/ä¸­æ–‡ä¸ºä¸»</option>
            <option value="custom">æ¥æºï¼šè‡ªå®šä¹‰ RSS</option>
          </select>
          <input id="newsLimit" type="number" min="5" max="50" value="18" placeholder="æ¡æ•°" style="max-width:140px;"/>
        </div>

        <details style="margin-top:10px;">
          <summary>è‡ªå®šä¹‰ RSSï¼ˆæ¯è¡Œä¸€ä¸ª URLï¼Œåªæœ‰é€‰æ‹©â€œè‡ªå®šä¹‰ RSSâ€æ‰ä¼šä½¿ç”¨ï¼‰</summary>
          <textarea id="rssCustom" placeholder="https://...
https://..."></textarea>
          <div class="mut small">æç¤ºï¼šå»ºè®®ç”¨ç¨³å®š RSSï¼ˆä¾‹å¦‚ MarketWatch å®˜æ–¹ RSS é¡µã€Bloomberg feedsã€CNBC å„æ ç›® RSSï¼‰ã€‚</div>
        </details>

        <div class="row" style="margin-top:10px;">
          <button class="primary" onclick="saveNewsConfig()">ä¿å­˜é…ç½®</button>
          <button class="secondary" onclick="fetchNews()">ğŸ— æŠ“å–æ–°é—»</button>
          <button class="secondary" onclick="clearNews()">æ¸…ç©º</button>
        </div>

        <div class="mut small" id="newsStatus" style="margin-top:10px;"></div>
        <div id="newsList" class="list"></div>
      </div>

      <div class="card">
        <h3>â‘¤ æ¿å—åŠ¨å‘ï¼ˆå¯åˆ /å¯è‡ªå®šä¹‰ + å›½å†…/ç¾è‚¡æ ‡ç­¾ï¼‰</h3>
        <div class="row">
          <button class="primary" onclick="refreshSectors()">ğŸ§­ æ‰«ææ¿å—</button>
          <button class="secondary" onclick="openSectorManager()">ğŸ§± ç®¡ç†æ¿å—</button>
          <input id="sectorSearch" placeholder="æœç´¢æ¿å—/ETFï¼Œä¾‹å¦‚ï¼šé»„é‡‘ / åŠå¯¼ä½“ / India / Oil..." oninput="renderSectors()" style="flex:1; min-width: 220px;"/>
        </div>
        <div class="mut small" id="sectorStatus" style="margin-top:10px;"></div>

        <details open style="margin-top:10px;">
          <summary>Topï¼ˆä¼˜å…ˆå…³æ³¨ï¼šè¶‹åŠ¿ + åŠ¨é‡ + RSI ç»¼åˆï¼‰</summary>
          <div id="sectorTop" class="list"></div>
        </details>

        <details style="margin-top:10px;">
          <summary>å…¨éƒ¨æ¿å—ï¼ˆå¯æ»šåŠ¨ï¼‰</summary>
          <div id="sectorAll" class="scroll" style="margin-top:8px;"></div>
        </details>

        <div class="mut small" style="margin-top:10px;">
          è¯´æ˜ï¼šè¿™é‡ŒåªæŠŠâ€œä»£è¡¨æ€§ ETF/Tickerâ€çš„è¶‹åŠ¿/åŠ¨é‡/RSIç®—å‡ºæ¥ï¼Œç”¨æ¥å‘ç°â€œåçƒ­/åå†·/ä¸Šè¡Œ/ä¸‹è¡Œâ€ã€‚ä¸æ˜¯é¢„æµ‹ï¼Œä¹Ÿä¸æ˜¯ä¿è¯æ”¶ç›Šã€‚
        </div>
      </div>

      <div class="card">
        <h3>â‘¥ ğŸ¤– AI å†³ç­–ï¼ˆæ”¯æŒä¸‰å±‚ Promptï¼‰</h3>
        <div class="row">
          <select id="taskMode">
            <option value="pre">æ¯æ—¥ç›˜å‰</option>
            <option value="review">æŒä»“å¤ç›˜</option>
            <option value="risk">é£é™©ä½“æ£€</option>
            <option value="radar">æœºä¼šé›·è¾¾ï¼ˆæ¿å—ï¼‰</option>
            <option value="news">æ–°é—»è§£è¯»</option>
          </select>
          <button class="primary" onclick="runAI()">ç”Ÿæˆåˆ†æ</button>
        </div>
        <div class="mut small" style="margin-top:10px;">
          æç¤ºï¼šSystem Prompt å›ºå®šåœ¨åç«¯ï¼ˆå®‰å…¨è¾¹ç•Œ/æ ¼å¼/å¼•ç”¨è§„åˆ™/ä¸ç¼–é€ /ä¸æ‰¿è¯ºæ”¶ç›Šï¼‰ã€‚ä½ å¯åœ¨ã€ŒPrompt ç®¡ç†ã€é‡Œè°ƒæ•´ Analysis Prompt å’Œå„ Task Promptã€‚
        </div>
        <textarea id="aiOut" style="margin-top:10px; min-height:220px;" placeholder="AI è¾“å‡ºä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ"></textarea>
      </div>

    </div>
  </div>

  <div class="fab" onclick="openGuide()" role="button" aria-label="æ‰“å¼€æŒ‡æ ‡æŒ‡å—">
    <div class="dot"></div>
    <div style="font-weight:900;">æŒ‡å—</div>
    <div class="mut small">æŒ‡æ ‡æ ‡ç­¾è§£é‡Š</div>
  </div>

  <div id="mask" class="mask" onclick="closeSheet(event)">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="sheetHead">
        <div style="display:flex; flex-direction:column; gap:2px;">
          <div style="font-weight:900;" id="sheetTitle">-</div>
          <div class="mut small" id="sheetSub">-</div>
        </div>
        <button class="xbtn secondary" onclick="closeSheet()">âœ•</button>
      </div>
      <div class="sheetBody" id="sheetBody"></div>
      <div class="sheetFoot" id="sheetFoot" style="display:none;"></div>
    </div>
  </div>

<script>
const LS = {
  backend: "nq_backend",
  positions: "nq_positions_v3",
  ai: "nq_ai",
  prompts: "nq_prompts",
  news: "nq_news",
  newsCache: "nq_news_cache",
  techCache: "nq_tech_cache",
  riskCache: "nq_risk_cache",
  sectorCfg: "nq_sector_cfg",
  sectorCache: "nq_sector_cache"
};
const DEFAULT_BACKEND = (localStorage.getItem(LS.backend) || "").trim() || "http://localhost:3000";
const $ = (id)=>document.getElementById(id);
function safeJsonParse(s, fallback){ try{ return JSON.parse(s); }catch{ return fallback; } }
function fmtMoney(x){
  if (x==null || !isFinite(x)) return "-";
  const sign = x<0 ? "-" : "";
  const n = Math.abs(x);
  return sign + n.toLocaleString(undefined,{ maximumFractionDigits: 2 });
}
function clampStr(s, max=6000){ s=String(s||""); return s.length<=max? s : s.slice(0,max)+"\n[...å·²æˆªæ–­...]"; }

function init(){
  $("backend").value = localStorage.getItem(LS.backend) || DEFAULT_BACKEND;
  const ai = safeJsonParse(localStorage.getItem(LS.ai), {});
  $("aiBase").value = ai.baseUrl || "https://api.openai.com";
  $("aiKey").value = ai.apiKey || "";
  $("aiModel").value = ai.model || "";
  $("outLang").value = ai.outLang || "zh";
  $("aiCfgOut").textContent = ai.model ? "âœ… å·²åŠ è½½æœ¬æœº AI é…ç½®" : "æœªé…ç½®ã€‚";

  const news = safeJsonParse(localStorage.getItem(LS.news), {});
  $("kwZh").value = news.kwZh || "";
  $("kwEn").value = news.kwEn || "";
  $("newsSourcePreset").value = news.preset || "mixed";
  $("newsLimit").value = news.limit || 18;
  $("rssCustom").value = (news.customRss || []).join("\n");

  window.positions = safeJsonParse(localStorage.getItem(LS.positions), defaultPositions());
  renderPositions();

  const risk = safeJsonParse(localStorage.getItem(LS.riskCache), null);
  if (risk && risk.ok) renderRisk(risk);

  const tech = safeJsonParse(localStorage.getItem(LS.techCache), null);
  if (tech && tech.ok) window.techCache = tech;

  const sectors = safeJsonParse(localStorage.getItem(LS.sectorCache), null);
  if (sectors && sectors.ok) { window.sectorCache = sectors; renderSectors(); }

  const newsCache = safeJsonParse(localStorage.getItem(LS.newsCache), null);
  if (newsCache && newsCache.ok) renderNews(newsCache.items||[]);

  ensurePrompts();
  ensureSectorCfg();

  $("buildTag").textContent = "v3";
}
window.addEventListener("load", init);

function defaultPositions(){
  return [
    { id: crypto.randomUUID(), type:"CN_FUND", code:"019449", name:"ç¤ºä¾‹ï¼šæ’ç”Ÿç§‘æŠ€ETFè”æ¥", amount: 10000, cost: null },
    { id: crypto.randomUUID(), type:"US_TICKER", code:"QQQ", name:"ç¤ºä¾‹ï¼šçº³æŒ‡100ETF", amount: 10000, cost: null },
  ];
}
function defaultSectorCfg(){
  return {
    sectors: [
      { id: crypto.randomUUID(), name:"åŠå¯¼ä½“", market:"US", tickers:["SOXX","SMH"] },
      { id: crypto.randomUUID(), name:"AI/ç§‘æŠ€", market:"US", tickers:["QQQ","XLK"] },
      { id: crypto.randomUUID(), name:"èƒ½æº/åŸæ²¹", market:"US", tickers:["XLE","USO"] },
      { id: crypto.randomUUID(), name:"é»„é‡‘", market:"US", tickers:["GLD","IAU"] },
      { id: crypto.randomUUID(), name:"ä¸­å›½äº’è”ç½‘", market:"CN", etfs:["513180","513330"] },
      { id: crypto.randomUUID(), name:"åŒ»è¯", market:"CN", etfs:["512010","512170"] },
      { id: crypto.randomUUID(), name:"ç…¤ç‚­", market:"CN", etfs:["515220"] },
      { id: crypto.randomUUID(), name:"å†›å·¥", market:"CN", etfs:["512660"] },
      { id: crypto.randomUUID(), name:"æœºå™¨äºº", market:"CN", etfs:["562500"] },
      { id: crypto.randomUUID(), name:"å°åº¦", market:"US", tickers:["INDA"] },
    ]
  };
}
function defaultPrompts(){
  return {
    analysisPrompt: `ä½ æ˜¯ä¸¥è°¨çš„æŠ•ç ”åŠ©ç†ã€‚\n\nã€åˆ†æé£æ ¼ã€‘\n- å…ˆé£é™©åæœºä¼šï¼›ä¼˜å…ˆè§£é‡Šâ€œä¸ç¡®å®šæ€§â€å’Œâ€œæ¡ä»¶â€ã€‚\n- ç»“è®ºè¦å¯æ‰§è¡Œï¼Œä½†ä¸å…è®¸æ‰¿è¯ºæ”¶ç›Šæˆ–ç¡®å®šæ€§è¡¨è¿°ã€‚\n- æ˜ç¡®åŒºåˆ†ï¼šäº‹å®/æ•°æ® vs æ¨æ–­/è§‚ç‚¹ã€‚\n\nã€ä½ è¦åˆ©ç”¨çš„æ•°æ®ã€‘\n- æŒä»“ï¼ˆé‡‘é¢ã€ç›ˆäºã€ä¼°å€¼/å‡€å€¼æ—¶é—´ï¼‰\n- é£æ§ï¼ˆé›†ä¸­åº¦ã€å•ä¸€æŒä»“å æ¯”ã€åœ°åŸŸ/ä¸»é¢˜æš´éœ²ç­‰ï¼‰\n- æŠ€æœ¯æŒ‡æ ‡ï¼ˆè¶‹åŠ¿/åŠ¨é‡/RSIç­‰æ ‡ç­¾ï¼‰\n- æ¿å—åŠ¨å‘ï¼ˆå„æ¿å—ä»£è¡¨æ€§ETFçš„è¶‹åŠ¿/åŠ¨é‡/RSIï¼‰\n- æ–°é—»ï¼ˆæ¡ç›®åˆ—è¡¨ï¼Œå«æ—¶é—´ã€æ¥æºã€ä¸»é¢˜ä¸æƒ…ç»ªæ ‡ç­¾ï¼‰\n\nã€è¾“å‡ºåå¥½ã€‘\n- æ€»ç»“å°½é‡çŸ­ï¼›å¿…è¦æ—¶å¯åŠ â€œå±•å¼€è§£é‡Šâ€ã€‚`,
    taskPrompts: {
      pre: `ä»»åŠ¡ï¼šæ¯æ—¥ç›˜å‰ã€‚\nè¾“å‡ºï¼š\n1) ä»Šæ—¥æœ€é‡è¦çš„3ä»¶äº‹ï¼ˆæ¥è‡ªæ–°é—»/æ”¿ç­–/é£é™©/æŠ€æœ¯çš„äº¤é›†ï¼‰\n2) æŒä»“ä»Šæ—¥åŠ¨ä½œï¼ˆä¹°/å–/ä¸åŠ¨ï¼‰â€”â€”å¦‚æœæ•°æ®ä¸è¶³å°±ç»™â€œè§‚å¯Ÿ/ç­‰å¾…â€çš„æ¡ä»¶\n3) é£é™©æ¸…å•ï¼ˆä»Šå¤©æœ€éœ€è¦é˜²çš„2ä¸ªé£é™©ï¼‰\n4) æ¿å—è§‚å¯Ÿæ¸…å•ï¼ˆ1-3ä¸ªæ¿å— + ä»£è¡¨ETFï¼‰`,
      review: `ä»»åŠ¡ï¼šæŒä»“å¤ç›˜ã€‚\nè¾“å‡ºï¼š\n1) æ€»ä½“ä»“ä½ä¸é£é™©ç­‰çº§\n2) æ¯åªæŒä»“ï¼šç°çŠ¶ï¼ˆè¶‹åŠ¿/åŠ¨é‡/RSI/æ–°é—»ï¼‰+ ä¸‹ä¸€æ­¥åŠ¨ä½œ\n3) éœ€è¦æ­¢æŸ/å‡ä»“çš„â€œæ¡ä»¶â€ï¼ˆè€Œä¸æ˜¯ç›´æ¥ç»™ç¡®å®šç»“è®ºï¼‰`,
      risk: `ä»»åŠ¡ï¼šé£é™©ä½“æ£€ã€‚\nè¾“å‡ºï¼š\n1) ä¸»è¦é£é™©æ¥æºæ’åºï¼ˆé›†ä¸­åº¦/ç›¸å…³æ€§/å•ä¸€ä¸»é¢˜/äº‹ä»¶é£é™©ï¼‰\n2) 3æ¡å¯æ“ä½œçš„é™é£é™©åŠ¨ä½œï¼ˆä¸æ¶‰åŠæ æ†/ä¿è¯æ”¶ç›Šï¼‰\n3) å¦‚æœç»§ç»­æŒæœ‰ï¼Œéœ€è¦æ»¡è¶³çš„â€œç›‘æ§ç‚¹â€`,
      radar: `ä»»åŠ¡ï¼šæœºä¼šé›·è¾¾ï¼ˆæ¿å—ï¼‰ã€‚\nè¾“å‡ºï¼š\n1) æ¿å—çƒ­åº¦Top3ï¼ˆç»“åˆè¶‹åŠ¿+åŠ¨é‡+RSIï¼‰\n2) å¯¹åº”ä»£è¡¨ETF + æ³¨æ„äº‹é¡¹\n3) å¦‚æœè¦å¸ƒå±€ï¼Œæœ€ä¿å®ˆçš„åˆ†æ‰¹ç­–ç•¥ï¼ˆç»™æ¡ä»¶/è§¦å‘ï¼‰`,
      news: `ä»»åŠ¡ï¼šæ–°é—»è§£è¯»ã€‚\nè¾“å‡ºï¼š\n1) ä»æ–°é—»ä¸­æç‚¼3-5æ¡è¦ç‚¹ï¼ˆæ ‡æ³¨åˆ©å¥½/åˆ©ç©º/ä¸ç¡®å®šï¼‰\n2) æ˜ å°„åˆ°æŒä»“/æ¿å—ï¼šå“ªäº›æœ€ç›¸å…³\n3) æ¥ä¸‹æ¥24-72å°æ—¶ä½ ä¼šå…³æ³¨çš„â€œéªŒè¯ä¿¡å·â€`
    }
  };
}

function saveBackend(){
  const v = $("backend").value.trim();
  if (!v) return alert("è¯·è¾“å…¥åç«¯åœ°å€");
  localStorage.setItem(LS.backend, v);
  $("healthOut").textContent = "âœ… å·²ä¿å­˜ã€‚";
}
async function checkHealth(){
  const base = (localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND).replace(/\/+$/,"");
  $("healthOut").textContent = "æ£€æŸ¥ä¸­â€¦";
  try{
    const r = await fetch(`${base}/health`);
    const j = await r.json();
    $("healthOut").textContent = j.ok ? `âœ… OK | build=${j.build} | tz=${j.tz}` : "âŒ æœªé€šè¿‡";
  }catch(e){
    $("healthOut").textContent = "âŒ æ— æ³•è¿æ¥åç«¯ï¼š" + (e?.message || e);
  }
}

function saveAI(){
  const cfg = {
    baseUrl: $("aiBase").value.trim(),
    apiKey: $("aiKey").value.trim(),
    model: $("aiModel").value.trim(),
    outLang: $("outLang").value
  };
  if (!cfg.baseUrl || !cfg.apiKey || !cfg.model) return alert("è¯·å¡«å†™ BaseUrl / Key / Model");
  localStorage.setItem(LS.ai, JSON.stringify(cfg));
  $("aiCfgOut").textContent = "âœ… AI é…ç½®å·²ä¿å­˜ï¼ˆä»…æœ¬æœºæµè§ˆå™¨ï¼‰ã€‚";
}
function clearAI(){
  localStorage.removeItem(LS.ai);
  $("aiKey").value = "";
  $("aiModel").value = "";
  $("aiCfgOut").textContent = "å·²æ¸…ç©ºã€‚";
}

function persistPositions(){ localStorage.setItem(LS.positions, JSON.stringify(window.positions)); }

function renderPositions(){
  const box = $("posList");
  box.innerHTML = "";
  const totalMV = window.positions.reduce((s,p)=>s+(p.mv||p.amount||0),0);
  const totalPNL = window.positions.reduce((s,p)=>s+(p.pnl||0),0);
  $("kpiMV").textContent = fmtMoney(totalMV);
  $("kpiPNL").textContent = fmtMoney(totalPNL);

  for (const p of window.positions){
    const div = document.createElement("div");
    div.className = "li";
    const tags = [];
    if (p.type==="CN_FUND") tags.push(`<span class="pill cn">å›½å†…</span>`);
    if (p.type==="US_TICKER") tags.push(`<span class="pill us">ç¾è‚¡</span>`);
    if (p._techTags?.length){
      for (const t of p._techTags.slice(0,6)) tags.push(`<span class="tag ${t.kind||""}">${t.text}</span>`);
    }
    div.innerHTML = `
      <div class="liHead">
        <div style="min-width: 0;">
          <div class="liTitle">${escapeHtml(p.name||"-")} <span class="mut mono">${escapeHtml(p.code||"")}</span></div>
          <div class="liMeta">
            <span class="tag">é‡‘é¢ï¼š${fmtMoney(p.amount)}</span>
            <span class="tag">å¸‚å€¼ï¼š${fmtMoney(p.mv||p.amount)}</span>
            <span class="tag ${p.pnl<0?"bad":"good"}">ç›ˆäºï¼š${fmtMoney(p.pnl||0)}</span>
          </div>
          <div class="tags" style="margin-top:8px;">${tags.join("")}</div>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button class="secondary" onclick="editPos('${p.id}')">ç¼–è¾‘</button>
          <button class="danger" onclick="delPos('${p.id}')">åˆ é™¤</button>
        </div>
      </div>
    `;
    box.appendChild(div);
  }
}

function openPosEditor(pos){
  const p = pos || { id: crypto.randomUUID(), type:"CN_FUND", code:"", name:"", amount:0, cost:null };
  const body = document.createElement("div");
  body.innerHTML = `
    <div class="row">
      <select id="peType">
        <option value="CN_FUND">å›½å†…åŸºé‡‘/ETFï¼ˆ6ä½ï¼‰</option>
        <option value="US_TICKER">æµ·å¤–æ ‡çš„ï¼ˆTickerï¼‰</option>
      </select>
      <input id="peCode" placeholder="ä»£ç ï¼Œä¾‹å¦‚ 513180 æˆ– QQQ" />
    </div>
    <div class="row" style="margin-top:10px;">
      <input id="peName" placeholder="åç§°ï¼ˆå¯é€‰ï¼‰" />
    </div>
    <div class="row" style="margin-top:10px;">
      <input id="peAmount" type="number" placeholder="æŒæœ‰é‡‘é¢" />
      <input id="peCost" type="number" placeholder="æˆæœ¬ä»·/æˆæœ¬å‡€å€¼ï¼ˆå¯é€‰ï¼‰" />
    </div>
    <div class="mut small" style="margin-top:10px;" id="peHint">æç¤ºï¼šé‡‘é¢ç”¨äºè®¡ç®—å æ¯”ä¸é›†ä¸­åº¦ï¼›æˆæœ¬ç”¨äºæ”¶ç›Šç‡ä¼°ç®—ï¼ˆå¯ä¸å¡«ï¼‰ã€‚</div>
  `;
  $("sheetTitle").textContent = pos ? "ç¼–è¾‘æŒä»“" : "æ·»åŠ æŒä»“";
  $("sheetSub").textContent = "æ”¯æŒè§¦å±æ“ä½œï¼šå¤§æŒ‰é’®/å¤§è¾“å…¥æ¡†";
  $("sheetBody").innerHTML = "";
  $("sheetBody").appendChild(body);
  $("sheetFoot").style.display = "flex";
  $("sheetFoot").innerHTML = `
    <button class="secondary" onclick="closeSheet()">å–æ¶ˆ</button>
    <button class="primary" onclick="savePosEditor('${p.id}')">ä¿å­˜</button>
  `;
  $("mask").classList.add("show");
  $("peType").value = p.type;
  $("peCode").value = p.code || "";
  $("peName").value = p.name || "";
  $("peAmount").value = p.amount || 0;
  $("peCost").value = (p.cost==null? "" : p.cost);
}
function editPos(id){ const p = window.positions.find(x=>x.id===id); if(p) openPosEditor(p); }
function delPos(id){
  if (!confirm("ç¡®å®šåˆ é™¤è¿™æ¡æŒä»“ï¼Ÿ")) return;
  window.positions = window.positions.filter(x=>x.id!==id);
  persistPositions();
  renderPositions();
}
function savePosEditor(id){
  const type = $("peType").value;
  const code = $("peCode").value.trim().toUpperCase();
  const name = $("peName").value.trim();
  const amount = Number($("peAmount").value || 0);
  const costRaw = $("peCost").value;
  const cost = (costRaw==="" ? null : Number(costRaw));
  if (!code) return alert("è¯·è¾“å…¥ä»£ç ");
  if (!isFinite(amount) || amount<=0) return alert("è¯·è¾“å…¥æ­£ç¡®é‡‘é¢");
  if (type==="CN_FUND" && !/^\d{6}$/.test(code)) return alert("å›½å†…åŸºé‡‘/ETFä»£ç åº”ä¸º 6 ä½æ•°å­—");
  if (type==="US_TICKER" && !/^[A-Z0-9\.-]{1,12}$/.test(code)) return alert("Ticker æ ¼å¼ä¸æ­£ç¡®");

  const idx = window.positions.findIndex(x=>x.id===id);
  const obj = { id, type, code, name: name||null, amount, cost };
  if (idx>=0) window.positions[idx] = { ...window.positions[idx], ...obj };
  else window.positions.unshift(obj);

  persistPositions();
  renderPositions();
  closeSheet();
}

async function refreshAll(){
  for (const p of window.positions){
    p.mv = p.amount;
    p.pnl = (p.pnl || 0);
  }
  persistPositions();
  renderPositions();
}

async function refreshRisk(){
  const base = (localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND).replace(/\/+$/,"");
  const payload = window.positions.map(p=>({ type:p.type, code:p.code, name:p.name, amount:p.amount, mv:(p.mv||p.amount) }));
  $("riskExplain").textContent = "æ£€æŸ¥ä¸­â€¦";
  try{
    const r = await fetch(`${base}/api/risk/check`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ positions: payload })
    });
    const j = await r.json();
    if (!j.ok) return alert("é£æ§æ£€æŸ¥å¤±è´¥ï¼š" + (j.error||""));
    localStorage.setItem(LS.riskCache, JSON.stringify(j));
    renderRisk(j);
  }catch(e){
    alert("é£æ§æ¥å£ä¸å¯ç”¨ï¼š" + (e?.message||e));
  }
}
function renderRisk(j){
  $("riskLevel").textContent = j.riskLevel || "-";
  $("riskSuggest").textContent = j.suggestTotalPct!=null ? `å»ºè®®æ€»ä»“ä½ï¼š${j.suggestTotalPct}%` : "å»ºè®®æ€»ä»“ä½ï¼š-";
  $("riskExplain").textContent = j.summary || "-";
  $("riskDetail").textContent = (j.details||[]).join("  Â·  ") || "-";
}
async function refreshTech(){
  const base = (localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND).replace(/\/+$/,"");
  const payload = window.positions.map(p=>({ type:p.type, code:p.code, name:p.name, amount:p.amount, mv:(p.mv||p.amount) }));
  try{
    const r = await fetch(`${base}/api/tech/batch`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ positions: payload })
    });
    const j = await r.json();
    if (!j.ok) return alert("æŠ€æœ¯æŒ‡æ ‡å¤±è´¥ï¼š" + (j.error||""));
    localStorage.setItem(LS.techCache, JSON.stringify(j));
    window.techCache = j;

    const byCode = new Map((j.items||[]).map(it=>[String(it.code||it.symbol||"").toUpperCase(), it]));
    for (const p of window.positions){
      const key = String(p.code||"").toUpperCase();
      const it = byCode.get(key);
      if (!it || !it.ok) { p._techTags = []; continue; }
      p._techTags = (it.tags||[]).map(t=>{
        const kind = (t.includes("åçƒ­")||t.includes("è¿‡çƒ­")||t.includes("ä¸‹è¡Œ")||t.includes("è½¬å¼±")) ? "warn"
                   : (t.includes("ä¸Šè¡Œ")||t.includes("è½¬å¼º")||t.includes("åå†·")||t.includes("è¶…å–")) ? "good"
                   : "";
        return { text: t, kind };
      });
      p._techRaw = it;
    }
    persistPositions();
    renderPositions();
  }catch(e){
    alert("æŠ€æœ¯æŒ‡æ ‡æ¥å£ä¸å¯ç”¨ï¼š" + (e?.message||e));
  }
}

function saveNewsConfig(){
  const cfg = {
    kwZh: $("kwZh").value.trim(),
    kwEn: $("kwEn").value.trim(),
    preset: $("newsSourcePreset").value,
    limit: Math.max(5, Math.min(50, Number($("newsLimit").value||18))),
    customRss: $("rssCustom").value.split(/\n+/).map(s=>s.trim()).filter(Boolean)
  };
  localStorage.setItem(LS.news, JSON.stringify(cfg));
  $("newsStatus").textContent = "âœ… å·²ä¿å­˜æ–°é—»é…ç½®ã€‚";
}
function clearNews(){
  localStorage.removeItem(LS.newsCache);
  $("newsList").innerHTML = "";
  $("newsStatus").textContent = "å·²æ¸…ç©ºã€‚";
}
async function fetchNews(){
  const base = (localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND).replace(/\/+$/,"");
  const cfg = safeJsonParse(localStorage.getItem(LS.news), null) || (saveNewsConfig(), safeJsonParse(localStorage.getItem(LS.news), {}));
  const kwZh = (cfg.kwZh||"").trim();
  const kwEn = (cfg.kwEn||"").trim();
  if (!kwZh && !kwEn) return alert("è‡³å°‘å¡«å†™ä¸­æ–‡æˆ–è‹±æ–‡å…³é”®è¯ä¹‹ä¸€");

  $("newsStatus").textContent = "æŠ“å–ä¸­â€¦";
  $("newsList").innerHTML = `<div class="mut small">æŠ“å–ä¸­â€¦</div>`;

  try{
    const r = await fetch(`${base}/api/news/rss`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        kwZh, kwEn,
        preset: cfg.preset || "mixed",
        limit: cfg.limit || 18,
        customRss: cfg.customRss || []
      })
    });
    const j = await r.json();
    if (!j.ok) return alert("æŠ“å–æ–°é—»å¤±è´¥ï¼š" + (j.error||""));
    localStorage.setItem(LS.newsCache, JSON.stringify(j));
    $("newsStatus").textContent = `âœ… è·å– ${j.items?.length||0} æ¡ï¼ˆå»é‡åï¼‰`;
    renderNews(j.items||[]);
  }catch(e){
    $("newsStatus").textContent = "âŒ æŠ“å–å¤±è´¥ï¼š" + (e?.message||e);
  }
}
function renderNews(items){
  const box = $("newsList");
  box.innerHTML = "";
  if (!items.length){
    box.innerHTML = `<div class="mut small">æš‚æ— æ–°é—»ã€‚ä½ å¯ä»¥å…ˆä¿å­˜å…³é”®è¯ï¼Œç„¶åç‚¹â€œæŠ“å–æ–°é—»â€ã€‚</div>`;
    return;
  }
  for (const it of items){
    const div = document.createElement("div");
    div.className = "li";
    const tags = [];
    if (it.market) tags.push(`<span class="tag">${escapeHtml(it.market)}</span>`);
    if (it.sentiment) tags.push(`<span class="tag ${it.sentiment==='åˆ©å¥½'?'good':it.sentiment==='åˆ©ç©º'?'bad':''}">${escapeHtml(it.sentiment)}</span>`);
    if (it.topics?.length){
      for (const t of it.topics.slice(0,4)) tags.push(`<span class="tag">${escapeHtml(t)}</span>`);
    }
    div.innerHTML = `
      <div class="liHead">
        <div style="min-width:0;">
          <div class="liTitle">${escapeHtml(it.title||"-")}</div>
          <div class="mut small" style="margin-top:6px;">
            ${escapeHtml(it.source||"")} Â· ${escapeHtml(it.pubDate||"")}
          </div>
          <div class="tags" style="margin-top:8px;">${tags.join("")}</div>
          <div class="mut small" style="margin-top:8px;">${escapeHtml(it.summary||it.description||"").slice(0,240)}${(it.summary||it.description||"").length>240?"â€¦":""}</div>
        </div>
        <div>
          ${it.link ? `<a class="tag" href="${escapeAttr(it.link)}" target="_blank" rel="noopener">æ‰“å¼€</a>` : ""}
        </div>
      </div>
    `;
    box.appendChild(div);
  }
}

let sectorScanCtrl = null;
function ensureSectorCfg(){
  const cfg = safeJsonParse(localStorage.getItem(LS.sectorCfg), null);
  if (cfg && Array.isArray(cfg.sectors)) return;
  localStorage.setItem(LS.sectorCfg, JSON.stringify(defaultSectorCfg()));
}
function getSectorCfg(){ ensureSectorCfg(); return safeJsonParse(localStorage.getItem(LS.sectorCfg), defaultSectorCfg()); }

function openSectorManager(){
  const cfg = getSectorCfg();
  const body = document.createElement("div");
  body.innerHTML = `
    <div class="mut small">ä½ å¯ä»¥åˆ é™¤é»˜è®¤æ¿å—ï¼Œä¹Ÿå¯ä»¥æ–°å¢ã€‚å›½å†…æ¿å—ï¼šé€šè¿‡â€œETF ä»£ç ï¼ˆ6ä½ï¼‰â€æ·»åŠ ï¼›ç¾è‚¡æ¿å—ï¼šé€šè¿‡â€œTICKERâ€æ·»åŠ ã€‚</div>
    <div id="secMgrList" class="scroll" style="margin-top:12px; max-height: 46vh;"></div>
    <hr style="border:0;border-top:1px solid var(--bd); margin:14px 0;">
    <div style="font-weight:900; margin-bottom:8px;">æ–°å¢æ¿å—</div>
    <div class="row">
      <input id="secNewName" placeholder="æ¿å—åç§°ï¼Œä¾‹å¦‚ï¼šAI/æœºå™¨äºº/ç…¤ç‚­/å†›å·¥/ä¸­å›½äº’è”ç½‘..." />
      <select id="secNewMarket" style="max-width:160px;">
        <option value="CN">å›½å†…</option>
        <option value="US">ç¾è‚¡</option>
      </select>
    </div>
    <div class="row" style="margin-top:10px;">
      <textarea id="secNewTickers" placeholder="ä»£ç åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰\nå›½å†…ï¼šETF 6ä½ï¼Œå¦‚ 513180,515220\nç¾è‚¡ï¼šTickerï¼Œå¦‚ QQQ,XLK,SOXX"></textarea>
    </div>
  `;
  $("sheetTitle").textContent = "ç®¡ç†æ¿å—";
  $("sheetSub").textContent = "âœ… ç°åœ¨æ”¯æŒæ»šåŠ¨ï¼šæ¿å—å†å¤šä¹Ÿèƒ½ç®¡ç†";
  $("sheetBody").innerHTML = "";
  $("sheetBody").appendChild(body);
  $("sheetFoot").style.display = "flex";
  $("sheetFoot").innerHTML = `
    <button class="secondary" onclick="closeSheet()">å…³é—­</button>
    <button class="primary" onclick="saveNewSector()">æ·»åŠ </button>
  `;
  $("mask").classList.add("show");
  renderSectorMgrList(cfg);
}
function renderSectorMgrList(cfg){
  const box = $("secMgrList"); if (!box) return;
  box.innerHTML = "";
  for (const s of cfg.sectors){
    const div = document.createElement("div");
    div.className = "li";
    const pill = s.market==="CN" ? `<span class="pill cn">å›½å†…</span>` : `<span class="pill us">ç¾è‚¡</span>`;
    const codes = s.market==="CN" ? (s.etfs||[]) : (s.tickers||[]);
    div.innerHTML = `
      <div class="liHead">
        <div style="min-width:0;">
          <div class="liTitle">${escapeHtml(s.name||"-")} ${pill}</div>
          <div class="mut small" style="margin-top:6px;">ä»£è¡¨æ ‡çš„ï¼š${escapeHtml(codes.join(", ")||"-")}</div>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button class="danger" onclick="deleteSector('${s.id}')">åˆ é™¤</button>
        </div>
      </div>
    `;
    box.appendChild(div);
  }
}
function saveNewSector(){
  const name = $("secNewName").value.trim();
  const market = $("secNewMarket").value;
  const raw = $("secNewTickers").value.trim();
  if (!name) return alert("è¯·è¾“å…¥æ¿å—åç§°");
  if (!raw) return alert("è¯·è¾“å…¥ä»£ç åˆ—è¡¨");
  const parts = raw.split(/[,ï¼Œ\s]+/).map(s=>s.trim()).filter(Boolean);
  if (!parts.length) return alert("ä»£ç åˆ—è¡¨ä¸ºç©º");
  let etfs=[], tickers=[];
  if (market==="CN"){
    etfs = parts.filter(x=>/^\d{6}$/.test(x));
    if (!etfs.length) return alert("å›½å†…æ¿å—å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ª 6 ä½ ETF ä»£ç ");
  } else {
    tickers = parts.map(x=>x.toUpperCase()).filter(x=>/^[A-Z0-9\.-]{1,12}$/.test(x));
    if (!tickers.length) return alert("ç¾è‚¡æ¿å—å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªåˆæ³• Ticker");
  }
  const cfg = getSectorCfg();
  cfg.sectors.unshift({ id: crypto.randomUUID(), name, market, etfs, tickers });
  localStorage.setItem(LS.sectorCfg, JSON.stringify(cfg));
  renderSectorMgrList(cfg);
  $("secNewName").value = "";
  $("secNewTickers").value = "";
}
function deleteSector(id){
  if (!confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªæ¿å—ï¼Ÿ")) return;
  const cfg = getSectorCfg();
  cfg.sectors = cfg.sectors.filter(s=>s.id!==id);
  localStorage.setItem(LS.sectorCfg, JSON.stringify(cfg));
  renderSectorMgrList(cfg);
}

async function refreshSectors(){
  const base = (localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND).replace(/\/+$/,"");
  const cfg = getSectorCfg();
  if (sectorScanCtrl) { sectorScanCtrl.abort(); sectorScanCtrl=null; $("sectorStatus").textContent="å·²åœæ­¢æ‰«æã€‚"; return; }
  $("sectorStatus").textContent = "æ‰«æä¸­â€¦ï¼ˆå†æ¬¡ç‚¹å‡»å¯åœæ­¢ï¼‰";
  sectorScanCtrl = new AbortController();
  const items = [];
  for (const s of cfg.sectors){
    const codes = s.market==="CN" ? (s.etfs||[]) : (s.tickers||[]);
    for (const sym of codes) items.push({ theme: s.name, market: s.market, symbol: sym, name: null });
  }
  try{
    const r = await fetch(`${base}/api/sector/scan`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ items }),
      signal: sectorScanCtrl.signal
    });
    const j = await r.json();
    sectorScanCtrl = null;
    if (!j.ok) return alert("æ¿å—æ‰«æå¤±è´¥ï¼š" + (j.error||""));
    localStorage.setItem(LS.sectorCache, JSON.stringify(j));
    window.sectorCache = j;
    $("sectorStatus").textContent = `âœ… å·²æ›´æ–°ï¼š${j.items?.length||0} æ¡`;
    renderSectors();
  }catch(e){
    if (String(e?.name||"").includes("Abort")) { $("sectorStatus").textContent="å·²åœæ­¢ã€‚"; return; }
    sectorScanCtrl = null;
    $("sectorStatus").textContent = "âŒ æ‰«æå¤±è´¥ï¼š" + (e?.message||e);
  }
}
function renderSectors(){
  const cache = window.sectorCache;
  const q = ($("sectorSearch").value||"").trim().toLowerCase();
  const items = (cache?.items||[]).filter(it=>{
    const s = `${it.theme||""} ${it.symbol||""} ${it.name||""}`.toLowerCase();
    return !q || s.includes(q);
  });
  const scored = items.map(it=>{
    let score=0; const tags = it.tags||[];
    if (tags.some(t=>t.includes("ä¸Šè¡Œ"))) score += 2;
    if (tags.some(t=>t.includes("åŠ¨é‡å¼º")||t.includes("è½¬å¼º"))) score += 2;
    if (tags.some(t=>t.includes("åçƒ­")||t.includes("è¿‡çƒ­"))) score -= 1;
    if (tags.some(t=>t.includes("åå†·")||t.includes("è¶…å–"))) score += 1;
    if (tags.some(t=>t.includes("ä¸‹è¡Œ")||t.includes("è½¬å¼±"))) score -= 2;
    return { ...it, _score: score };
  }).sort((a,b)=>b._score-a._score);

  const topThemes = new Set(); const top=[];
  for (const it of scored){
    if (topThemes.has(it.theme)) continue;
    topThemes.add(it.theme); top.push(it);
    if (top.length>=8) break;
  }
  $("sectorTop").innerHTML = ""; for (const it of top) $("sectorTop").appendChild(renderSectorItem(it));
  $("sectorAll").innerHTML = "";
  if (!scored.length){ $("sectorAll").innerHTML = `<div class="mut small">æš‚æ— æ¿å—æ•°æ®ã€‚å…ˆç‚¹â€œğŸ§­ æ‰«ææ¿å—â€ã€‚</div>`; return; }
  for (const it of scored) $("sectorAll").appendChild(renderSectorItem(it));
}
function renderSectorItem(it){
  const div = document.createElement("div"); div.className="li";
  const pill = (it.market==="CN") ? `<span class="pill cn">å›½å†…</span>` : `<span class="pill us">ç¾è‚¡</span>`;
  const tags = (it.tags||[]).slice(0,6).map(t=>{
    const k = (t.includes("åçƒ­")||t.includes("è¿‡çƒ­")||t.includes("ä¸‹è¡Œ")||t.includes("è½¬å¼±")) ? "warn"
            : (t.includes("ä¸Šè¡Œ")||t.includes("åŠ¨é‡å¼º")||t.includes("è½¬å¼º")||t.includes("åå†·")||t.includes("è¶…å–")) ? "good"
            : "";
    return `<span class="tag ${k}">${escapeHtml(t)}</span>`;
  }).join("");
  div.innerHTML = `
    <div class="liHead">
      <div style="min-width:0;">
        <div class="liTitle">${escapeHtml(it.theme||"-")} ${pill}</div>
        <div class="mut small" style="margin-top:6px;">ä»£è¡¨æ ‡çš„ï¼š<span class="mono">${escapeHtml(it.symbol||"-")}</span> ${escapeHtml(it.name||"")}</div>
        <div class="tags" style="margin-top:8px;">${tags}</div>
      </div>
      <div class="tag">Score ${it._score ?? 0}</div>
    </div>
  `;
  return div;
}

function ensurePrompts(){
  const p = safeJsonParse(localStorage.getItem(LS.prompts), null);
  if (p && p.analysisPrompt && p.taskPrompts) return;
  localStorage.setItem(LS.prompts, JSON.stringify(defaultPrompts()));
}
function openPromptManager(){
  ensurePrompts();
  const p = safeJsonParse(localStorage.getItem(LS.prompts), defaultPrompts());
  const body = document.createElement("div");
  body.innerHTML = `
    <div class="li">
      <div class="liTitle">System Promptï¼ˆå›ºå®šï¼‰</div>
      <div class="mut small" style="margin-top:8px;">System Prompt å›ºå®šåœ¨åç«¯ï¼šå®‰å…¨è¾¹ç•Œã€å¼•ç”¨è§„åˆ™ã€ä¸è¦ç¼–é€ ã€ä¸è¦â€œä¿è¯æ”¶ç›Šâ€ã€è¾“å‡ºæ ¼å¼è¦æ±‚ç­‰ã€‚</div>
    </div>
    <div class="li" style="margin-top:10px;">
      <div class="liTitle">Analysis Promptï¼ˆå¯ç¼–è¾‘ï¼Œå¸¸æ”¹ï¼‰</div>
      <textarea id="pmAnalysis" style="margin-top:10px;"></textarea>
      <div class="mut small" style="margin-top:8px;">å»ºè®®ï¼šç”¨å®ƒè°ƒâ€œé£æ ¼/é‡ç‚¹/æ¡†æ¶/ä¿å®ˆç¨‹åº¦/è¾“å‡ºé•¿åº¦â€ã€‚</div>
    </div>
    <div class="li" style="margin-top:10px;">
      <div class="liTitle">Task Promptï¼ˆæŒ‰æ¨¡å¼åˆ‡æ¢ï¼‰</div>
      <div class="row" style="margin-top:10px;">
        <select id="pmTaskKey" style="max-width:220px;">
          <option value="pre">æ¯æ—¥ç›˜å‰</option>
          <option value="review">æŒä»“å¤ç›˜</option>
          <option value="risk">é£é™©ä½“æ£€</option>
          <option value="radar">æœºä¼šé›·è¾¾ï¼ˆæ¿å—ï¼‰</option>
          <option value="news">æ–°é—»è§£è¯»</option>
        </select>
        <button class="secondary" onclick="pmLoadTask()">è½½å…¥</button>
        <button class="secondary" onclick="pmSaveTask()">ä¿å­˜</button>
      </div>
      <textarea id="pmTaskText" style="margin-top:10px; min-height:140px;"></textarea>
      <div class="row" style="margin-top:10px; justify-content:space-between;">
        <button class="secondary" onclick="pmRestoreDefaults()">æ¢å¤é»˜è®¤</button>
        <button class="secondary" onclick="pmCopy()">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
      </div>
    </div>
  `;
  $("sheetTitle").textContent = "Prompt ç®¡ç†";
  $("sheetSub").textContent = "ä¸‰å±‚ Promptï¼šSystemï¼ˆå›ºå®šï¼‰/Analysisï¼ˆå¯ç¼–è¾‘ï¼‰/Taskï¼ˆæŒ‰æ¨¡å¼åˆ‡æ¢ï¼‰";
  $("sheetBody").innerHTML = "";
  $("sheetBody").appendChild(body);
  $("sheetFoot").style.display = "flex";
  $("sheetFoot").innerHTML = `
    <button class="secondary" onclick="closeSheet()">å…³é—­</button>
    <button class="primary" onclick="pmSaveAll()">ä¿å­˜</button>
  `;
  $("mask").classList.add("show");
  $("pmAnalysis").value = p.analysisPrompt || "";
  $("pmTaskKey").value = $("taskMode").value || "pre";
  $("pmTaskText").value = p.taskPrompts[$("pmTaskKey").value] || "";
}
function pmLoadTask(){ const p = safeJsonParse(localStorage.getItem(LS.prompts), defaultPrompts()); $("pmTaskText").value = p.taskPrompts[$("pmTaskKey").value] || ""; }
function pmSaveTask(){
  const p = safeJsonParse(localStorage.getItem(LS.prompts), defaultPrompts());
  const k = $("pmTaskKey").value;
  p.taskPrompts[k] = $("pmTaskText").value;
  localStorage.setItem(LS.prompts, JSON.stringify(p));
  alert("å·²ä¿å­˜è¯¥ Task Promptã€‚");
}
function pmSaveAll(){
  const p = safeJsonParse(localStorage.getItem(LS.prompts), defaultPrompts());
  p.analysisPrompt = $("pmAnalysis").value;
  const k = $("pmTaskKey").value;
  p.taskPrompts[k] = $("pmTaskText").value;
  localStorage.setItem(LS.prompts, JSON.stringify(p));
  alert("âœ… å·²ä¿å­˜ã€‚");
  closeSheet();
}
function pmRestoreDefaults(){
  if (!confirm("æ¢å¤é»˜è®¤ Promptï¼Ÿä¼šè¦†ç›–ä½ çš„è‡ªå®šä¹‰ã€‚")) return;
  localStorage.setItem(LS.prompts, JSON.stringify(defaultPrompts()));
  openPromptManager();
}
async function pmCopy(){
  const txt = `Analysis Prompt:\n\n${$("pmAnalysis").value}\n\nTask(${ $("pmTaskKey").value }):\n\n${$("pmTaskText").value}`;
  try{ await navigator.clipboard.writeText(txt); alert("å·²å¤åˆ¶ã€‚"); }
  catch{ alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚"); }
}

async function runAI(){
  const base = (localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND).replace(/\/+$/,"");
  const cfg = safeJsonParse(localStorage.getItem(LS.ai), {});
  if (!cfg.baseUrl || !cfg.apiKey || !cfg.model) return alert("å…ˆé…ç½® AI BaseUrl / Key / Model å¹¶ä¿å­˜");
  await refreshAll();
  const prompts = safeJsonParse(localStorage.getItem(LS.prompts), defaultPrompts());
  const mode = $("taskMode").value;
  const analysisPrompt = clampStr(prompts.analysisPrompt || "");
  const taskPrompt = clampStr((prompts.taskPrompts||{})[mode] || "");

  const holdings = window.positions.map(p=>({
    type:p.type, code:p.code, name:p.name, amount:p.amount, cost:p.cost,
    mv:(p.mv||p.amount), pnl:p.pnl,
    tech: p._techRaw || null,
    techTags: (p._techTags||[]).map(x=>x.text)
  }));
  const risk = safeJsonParse(localStorage.getItem(LS.riskCache), null);
  const tech = safeJsonParse(localStorage.getItem(LS.techCache), null);
  const sectors = safeJsonParse(localStorage.getItem(LS.sectorCache), null);
  const news = safeJsonParse(localStorage.getItem(LS.newsCache), null);

  $("aiOut").value = "ç”Ÿæˆä¸­â€¦";
  try{
    const r = await fetch(`${base}/api/ai/chat`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        baseUrl: cfg.baseUrl,
        apiKey: cfg.apiKey,
        model: cfg.model,
        outLang: cfg.outLang || "zh",
        analysisPrompt,
        taskPrompt,
        data: {
          holdings,
          risk: risk && risk.ok ? risk : null,
          tech: tech && tech.ok ? tech : null,
          sectors: sectors && sectors.ok ? sectors : null,
          news: news && news.ok ? (news.items||[]) : []
        }
      })
    });
    const text = await r.text();
    let content = text;
    try{
      const j = JSON.parse(text);
      content = j?.choices?.[0]?.message?.content || j?.output_text || text;
    }catch{}
    $("aiOut").value = content;
  }catch(e){
    $("aiOut").value = "âŒ ç”Ÿæˆå¤±è´¥ï¼š" + (e?.message || e);
  }
}

function openGuide(){
  const body = document.createElement("div");
  body.innerHTML = `
    <div class="li">
      <div class="liTitle">è¿™äº›æ ‡ç­¾ä»£è¡¨ä»€ä¹ˆï¼Ÿï¼ˆç»™å°ç™½çš„å¿«é€Ÿè§£é‡Šï¼‰</div>
      <div class="mut small" style="margin-top:8px;">ä¸‹é¢æ˜¯â€œæ•°å­¦çŠ¶æ€â€ï¼Œä¸æ˜¯ä¹°å–æŒ‡ä»¤ã€‚ä½ å¯ä»¥æŠŠå®ƒå½“ä½œï¼š<b>æ¸©åº¦è®¡ + æ–¹å‘ç›˜</b>ã€‚</div>
    </div>
    <details open style="margin-top:10px;">
      <summary>è¶‹åŠ¿ï¼šä¸Šè¡Œ / ä¸‹è¡Œ</summary>
      <div class="li"><div class="mut small">
        - <b>ä¸Šè¡Œ</b>ï¼šæ–¹å‘æ›´å¼ºï¼›<b>ä¸‹è¡Œ</b>ï¼šæ–¹å‘æ›´å¼±ã€‚<br><br>
        æ–°æ‰‹å»ºè®®ï¼šä¸‹è¡Œæ—¶æ›´é€‚åˆ<b>è§‚å¯Ÿ/åˆ†æ‰¹</b>ï¼›ä¸Šè¡Œä¹Ÿä¸ç­‰äºä¸€å®šæ¶¨ã€‚
      </div></div>
    </details>
    <details style="margin-top:10px;">
      <summary>åŠ¨é‡ï¼šåŠ¨é‡å¼º / è½¬å¼º / è½¬å¼±</summary>
      <div class="li"><div class="mut small">
        - <b>åŠ¨é‡å¼º/è½¬å¼º</b>ï¼šé€Ÿåº¦æ›´å¿«ï¼›<b>è½¬å¼±</b>ï¼šé€Ÿåº¦æ”¾ç¼“æˆ–ä¸‹è·ŒåŠ é€Ÿã€‚<br><br>
        æ–°æ‰‹å»ºè®®ï¼šåŠ¨é‡å¼ºæ›´æ˜“è¿½é«˜â†’<b>å°ä»“+åˆ†æ‰¹</b>ã€‚
      </div></div>
    </details>
    <details style="margin-top:10px;">
      <summary>RSIï¼šåçƒ­ / åå†· / ä¸­æ€§</summary>
      <div class="li"><div class="mut small">
        - <b>åçƒ­</b>ï¼šçŸ­æœŸæ¶¨å¤ªå¿«ï¼Œå›æ’¤æ¦‚ç‡ä¸Šå‡ï¼›<b>åå†·/è¶…å–</b>ï¼šçŸ­æœŸè·Œå¤ªå¤šï¼Œåå¼¹æ¦‚ç‡ä¸Šå‡ã€‚<br><br>
        æ–°æ‰‹å»ºè®®ï¼š<b>åçƒ­â†’è§‚å¯Ÿ/ç­‰å›è¸©/åˆ†æ‰¹</b>ï¼›åå†·ä¹Ÿä¸è¦æ¢­å“ˆã€‚
      </div></div>
    </details>
  `;
  $("sheetTitle").textContent = "æŒ‡æ ‡æŒ‡å—";
  $("sheetSub").textContent = "ç‚¹ä¸€ä¸‹å°±èƒ½çœ‹æ‡‚æ ‡ç­¾å«ä¹‰ï¼ˆè§¦å±ä¼˜åŒ–ï¼‰";
  $("sheetBody").innerHTML = "";
  $("sheetBody").appendChild(body);
  $("sheetFoot").style.display = "none";
  $("mask").classList.add("show");
}

function closeSheet(evt){
  if (evt && evt.target && evt.target.id!=="mask") return;
  $("mask").classList.remove("show");
  $("sheetFoot").style.display = "none";
  $("sheetBody").innerHTML = "";
}

function escapeHtml(s){
  s = String(s ?? "");
  return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }
</script>
</body>
</html>
