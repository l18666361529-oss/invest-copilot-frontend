<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEON QUANT // NightCity Terminal</title>
  <style>
    :root{
      --bg0:#07070a;
      --bg1:#0b0b12;
      --card:#0f1020;
      --card2:#12142a;
      --fg:#e8e8ff;
      --muted:#a7a7d6;
      --muted2:#7f80b3;
      --line:#23244a;
      --cyan:#38f6ff;
      --pink:#ff3cf0;
      --lime:#8dff6a;
      --amber:#ffd25e;
      --danger:#ff4d6d;
      --shadow: 0 10px 30px rgba(0,0,0,.55);
      --radius:16px;
      --radius2:22px;
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; background: radial-gradient(1200px 800px at 20% 0%, rgba(255,60,240,.12), transparent 55%),
                                      radial-gradient(900px 700px at 80% 10%, rgba(56,246,255,.12), transparent 55%),
                                      radial-gradient(900px 700px at 60% 90%, rgba(141,255,106,.08), transparent 55%),
                                      linear-gradient(180deg, var(--bg0), var(--bg1));
               color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
    }
    a{ color:var(--cyan); text-decoration:none; }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px 14px 110px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 14px; border:1px solid var(--line); background:linear-gradient(180deg, rgba(18,20,42,.85), rgba(15,16,32,.78));
      border-radius: var(--radius2); box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: conic-gradient(from 220deg, var(--cyan), var(--pink), var(--lime), var(--cyan));
      box-shadow: 0 0 0 1px rgba(56,246,255,.25), 0 0 26px rgba(255,60,240,.18);
    }
    .title{ line-height:1.1; min-width:0;}
    .title h1{ margin:0; font-size:14px; letter-spacing:.12em; text-transform:uppercase; color:var(--fg); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .title .sub{ font-size:12px; color:var(--muted); margin-top:4px; }
    .statuspill{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      color:var(--muted);
      font-size:12px;
    }
    .pill{
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      background: rgba(10,10,18,.6);
    }
    .grid{
      display:grid; grid-template-columns: 1fr; gap:14px; margin-top:14px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 1.1fr .9fr; }
    }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(18,20,42,.85), rgba(15,16,32,.8));
      box-shadow: var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .card h2{
      margin:0 0 10px; font-size:13px; letter-spacing:.08em; text-transform:uppercase; color:var(--fg);
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .muted{ color:var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select, textarea, button{
      font: inherit;
      color: var(--fg);
    }
    input, select, textarea{
      background: rgba(7,7,10,.6);
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 10px;
      outline:none;
      width:100%;
    }
    textarea{ min-height:92px; resize:vertical; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border-radius: 999px;
      padding:10px 12px;
      border:1px solid rgba(56,246,255,.35);
      background: linear-gradient(180deg, rgba(56,246,255,.14), rgba(255,60,240,.08));
      box-shadow: 0 0 0 1px rgba(56,246,255,.08), 0 10px 22px rgba(0,0,0,.35);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn.secondary{
      border:1px solid var(--line);
      background: rgba(7,7,10,.55);
    }
    .btn.danger{
      border:1px solid rgba(255,77,109,.35);
      background: linear-gradient(180deg, rgba(255,77,109,.18), rgba(255,60,240,.08));
    }
    .btn.small{ padding:7px 10px; font-size:12px; }
    .two{
      display:grid; grid-template-columns:1fr; gap:10px;
    }
    @media (min-width: 720px){
      .two{ grid-template-columns:1fr 1fr; }
    }
    .tbl{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(7,7,10,.45);
    }
    .tbl th, .tbl td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(35,36,74,.65);
      font-size:12px;
      vertical-align:top;
    }
    .tbl th{ color:var(--muted); font-weight:600; background: rgba(15,16,32,.35); }
    .tbl tr:last-child td{ border-bottom:none; }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; border:1px solid var(--line);
      background: rgba(15,16,32,.5);
      color:var(--muted);
      font-size:12px;
    }
    .tag.good{ border-color: rgba(141,255,106,.35); color: #d7ffd0; }
    .tag.warn{ border-color: rgba(255,210,94,.35); color: #fff0c6; }
    .tag.bad{ border-color: rgba(255,77,109,.35); color: #ffd0da; }
    .tag.info{ border-color: rgba(56,246,255,.35); color: #d7fbff; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .floating{
      position: fixed; right: 14px; bottom: 14px;
      display:flex; flex-direction:column; gap:10px; z-index: 50;
    }
    .fab{
      width:52px; height:52px; border-radius:18px;
      border:1px solid rgba(56,246,255,.35);
      background: linear-gradient(180deg, rgba(56,246,255,.18), rgba(255,60,240,.10));
      box-shadow: var(--shadow);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .fab span{ font-size:18px; }
    .modal-backdrop{
      position: fixed; inset:0; background: rgba(0,0,0,.66);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index: 60;
    }
    .modal{
      width:min(980px, 100%);
      max-height: 86vh;
      overflow:auto;
      border-radius: 22px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,20,42,.95), rgba(12,12,20,.92));
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding-bottom:10px; border-bottom:1px solid rgba(35,36,74,.7);
      margin-bottom:12px;
    }
    .modal header h3{ margin:0; font-size:13px; letter-spacing:.08em; text-transform:uppercase;}
    .modal header p{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    .xbtn{
      width:38px; height:38px; border-radius:14px;
      border:1px solid var(--line); background: rgba(7,7,10,.5);
      display:flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .kbd{ padding:2px 6px; border:1px solid var(--line); border-radius:8px; background:rgba(7,7,10,.5); font-size:12px;}
    .hr{ height:1px; background: rgba(35,36,74,.7); margin:12px 0; }
    .small{ font-size:12px; color:var(--muted); }
    .okdot{ display:inline-block; width:8px; height:8px; border-radius:50%; background: var(--lime); box-shadow:0 0 12px rgba(141,255,106,.35);}
    .baddot{ display:inline-block; width:8px; height:8px; border-radius:50%; background: var(--danger); box-shadow:0 0 12px rgba(255,77,109,.35);}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>NEON QUANT // NightCity Terminal</h1>
          <div class="sub">èµ›åšæŠ•ç ”èˆ± Â· Proxy æ¿å—é›·è¾¾ Â· ä½ç»´æŠ¤åŠ¨ä½œå»ºè®®</div>
        </div>
      </div>
      <div class="statuspill">
        <div class="pill"><span id="healthDot" class="baddot"></span> <span id="healthText">åç«¯æœªæ£€æµ‹</span></div>
        <div class="pill">Backend: <span class="mono" id="backendText"></span></div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Core -->
      <div class="card">
        <h2>è¿æ¥ä¸æ•°æ®</h2>

        <div class="two">
          <div>
            <div class="small">åç«¯åŸŸåï¼ˆRenderï¼‰</div>
            <input id="apiBase" placeholder="https://xxx.onrender.com" />
            <div class="row" style="margin-top:10px;">
              <button class="btn small" id="btnHealth">æµ‹è¯•åç«¯</button>
              <button class="btn small secondary" id="btnClearLocal">æ¸…ç†æœ¬åœ°ç¼“å­˜</button>
            </div>
            <div class="small" style="margin-top:8px;">æç¤ºï¼šæ‰‹æœºç«¯å»ºè®®ç”¨æ— ç—•çª—å£æˆ– <span class="kbd">Ctrl+F5</span> å¼ºåˆ·ä»¥é¿å…æ—§ç¼“å­˜ã€‚</div>
          </div>

          <div>
            <div class="small">æ–°é—»æ‘˜è¦ï¼ˆå¯ç²˜è´´ï¼Œå¯ç©ºï¼‰</div>
            <textarea id="newsBox" placeholder="æŠŠä½ æ•´ç†çš„æ–°é—»æ‘˜è¦è´´åœ¨è¿™é‡Œï¼ˆä¸­è‹±éƒ½è¡Œï¼‰ã€‚ç³»ç»Ÿä¼šä¸€èµ·å–‚ç»™AIæç¤ºè¯ã€‚"></textarea>
            <div class="row" style="margin-top:10px;">
              <button class="btn small secondary" id="btnSaveNews">ä¿å­˜æ–°é—»æ‘˜è¦</button>
              <button class="btn small danger" id="btnClearNews">æ¸…ç©º</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <h2>æ¿å—åŠ¨å‘ï¼ˆProxy ETF / åˆ†æ—¶æ…¢æ‰«ï¼‰</h2>
        <div class="row">
          <button class="btn" id="btnScan">åˆ·æ–°æ¿å—åŠ¨å‘ï¼ˆæ…¢æ‰«ï¼‰</button>
          <button class="btn secondary" id="btnStopScan">åœæ­¢</button>
          <button class="btn secondary" id="btnForceScan">å¼ºåˆ¶é‡æ‰«å¤±è´¥é¡¹</button>
        </div>
        <div class="small" id="scanStatus" style="margin-top:10px;">å°šæœªå¼€å§‹æ‰«æã€‚</div>

        <div style="margin-top:12px; overflow:auto;">
          <table class="tbl" id="sectorTable">
            <thead>
              <tr>
                <th style="width:28%;">æ¿å—</th>
                <th style="width:10%;">å¸‚åœº</th>
                <th style="width:12%;">Proxy</th>
                <th style="width:12%;">è¶‹åŠ¿</th>
                <th style="width:12%;">åŠ¨é‡(20d)</th>
                <th style="width:12%;">RSI</th>
                <th style="width:14%;">çŠ¶æ€</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <details style="margin-top:12px;">
          <summary class="small">ç®¡ç†æ¿å—ï¼ˆæ·»åŠ /åˆ é™¤/éšè—é»˜è®¤/é‡ç½®ï¼‰</summary>
          <div class="hr"></div>
          <div class="two">
            <div>
              <div class="small">æ·»åŠ  Proxy æ¿å—</div>
              <div class="two">
                <div>
                  <select id="sectorMarket">
                    <option value="US">ç¾è‚¡/æµ·å¤–</option>
                    <option value="CN_FUND">å›½å†…ETF/åŸºé‡‘ï¼ˆ6ä½ï¼‰</option>
                  </select>
                </div>
                <div>
                  <input id="sectorTheme" placeholder="æ¿å—å/ä¸»é¢˜ï¼ˆå¦‚ï¼šè´µé‡‘å±/å†›å·¥/åŠå¯¼ä½“ï¼‰" />
                </div>
              </div>
              <div class="two" style="margin-top:10px;">
                <div><input id="sectorSymbol" placeholder="Proxyä»£ç ï¼šUSå¡«SPY/SMHï¼›å›½å†…å¡«512xxx/159xxx" /></div>
                <div><input id="sectorName" placeholder="æ˜¾ç¤ºåï¼ˆå¯ç©ºï¼‰" /></div>
              </div>
              <div class="row" style="margin-top:10px;">
                <button class="btn small" id="btnAddSector">æ·»åŠ </button>
                <button class="btn small secondary" id="btnExportSectors">å¯¼å‡º</button>
                <label class="btn small secondary" style="cursor:pointer;">
                  å¯¼å…¥<input type="file" id="sectorImportFile" accept="application/json" style="display:none;">
                </label>
                <button class="btn small danger" id="btnResetSectors">é‡ç½®é»˜è®¤</button>
              </div>
              <div class="small" style="margin-top:8px;">è¯´æ˜ï¼šå›½å†…æ¿å—ç”¨â€œä»£è¡¨ETF/åŸºé‡‘(6ä½)â€ä½œä¸º Proxyã€‚åç«¯ä¼šèµ° <span class="mono">/api/tech/cnfund</span> è®¡ç®—è¶‹åŠ¿/åŠ¨é‡/RSIã€‚</div>
            </div>

            <div>
              <div class="small">å½“å‰æ¿å—åˆ—è¡¨</div>
              <div style="max-height:220px; overflow:auto; margin-top:10px; border:1px solid var(--line); border-radius:14px; background: rgba(7,7,10,.35);">
                <table class="tbl" id="sectorManageTable" style="border:none; border-radius:0;">
                  <thead>
                    <tr>
                      <th>æ¿å—</th>
                      <th>å¸‚åœº</th>
                      <th>Proxy</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="small" style="margin-top:8px;">æç¤ºï¼šé»˜è®¤æ¿å—å¯â€œéšè—â€ï¼›è‡ªå®šä¹‰æ¿å—å¯â€œåˆ é™¤â€ã€‚</div>
            </div>
          </div>
        </details>
      </div>

      <!-- Right: AI tools -->
      <div class="card">
        <h2>AI åˆ†ææ§åˆ¶å° <span class="tag info">é»˜è®¤å¿…å–‚</span></h2>

        <div class="small">åˆ†ææ¨¡å¼</div>
        <select id="taskMode">
          <option value="opportunity_radar">æœºä¼šé›·è¾¾ï¼ˆæ¿å—ï¼‰</option>
          <option value="risk_check">é£é™©ä½“æ£€</option>
          <option value="weekly_review">æŒä»“å¤ç›˜</option>
        </select>

        <div class="hr"></div>

        <div class="row">
          <button class="btn" id="btnCompose">ç”ŸæˆAIè¾“å…¥ï¼ˆå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼‰</button>
          <button class="btn secondary" id="btnShowPayload">æŸ¥çœ‹å–‚ç»™AIçš„æ•°æ®</button>
        </div>

        <div class="small" style="margin-top:10px;">
          ä½ å¯ä»¥åœ¨ã€ŒPromptã€å¼¹å±‚é‡Œéšæ—¶è°ƒæ•´ä¸‰å±‚æç¤ºè¯ï¼›åœ¨ã€Œå…³é”®è¯ã€å¼¹å±‚é‡Œè°ƒæ•´åŒè½¨åˆ¶å…³é”®è¯åº“ï¼ˆè‡ªå®šä¹‰ä¸ä¼šè¢«è¦†ç›–ï¼‰ã€‚
        </div>

        <div class="hr"></div>

        <h2>é£æ§æ ¡éªŒï¼ˆå¯å–‚/å¯å…³ï¼‰</h2>
        <div class="row">
          <label class="tag"><input type="checkbox" id="feedRisk" checked style="margin-right:8px;">å–‚ç»™AIï¼ˆä»…ä½œæ ¡éªŒï¼‰</label>
          <label class="tag"><input type="checkbox" id="feedSectors" checked style="margin-right:8px;">å–‚æ¿å—åŠ¨å‘</label>
          <label class="tag"><input type="checkbox" id="feedTech" checked style="margin-right:8px;">å–‚æŠ€æœ¯æŒ‡æ ‡</label>
          <label class="tag"><input type="checkbox" id="feedNews" checked style="margin-right:8px;">å–‚æ–°é—»æ‘˜è¦</label>
        </div>

        <div class="hr"></div>

        <h2>ä½ çš„æŒä»“ï¼ˆæ‰‹åŠ¨å½•å…¥ / åç»­å¯æ¥å…¥å¯¼å…¥ï¼‰</h2>
        <div class="two">
          <div>
            <div class="small">ç±»å‹</div>
            <select id="posType">
              <option value="CN_FUND">å›½å†…åŸºé‡‘/ETFï¼ˆ6ä½ï¼‰</option>
              <option value="US_TICKER">ç¾è‚¡Tickerï¼ˆå¦‚SPY/QQQï¼‰</option>
            </select>
          </div>
          <div>
            <div class="small">ä»£ç </div>
            <input id="posCode" placeholder="å¦‚ï¼š012922 æˆ– SPY" />
          </div>
        </div>
        <div class="two" style="margin-top:10px;">
          <div>
            <div class="small">åç§°ï¼ˆå¯ç©ºï¼‰</div>
            <input id="posName" placeholder="å¦‚ï¼šä¸­æ¬§åŒ»ç–—ã€SPY" />
          </div>
          <div>
            <div class="small">æƒé‡ï¼ˆ%ï¼‰</div>
            <input id="posWeight" placeholder="å¦‚ï¼š25" />
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn small" id="btnAddPos">æ·»åŠ æŒä»“</button>
          <button class="btn small secondary" id="btnExportPos">å¯¼å‡º</button>
          <label class="btn small secondary" style="cursor:pointer;">
            å¯¼å…¥<input type="file" id="posImportFile" accept="application/json" style="display:none;">
          </label>
          <button class="btn small danger" id="btnClearPos">æ¸…ç©º</button>
        </div>

        <div style="margin-top:12px; overflow:auto;">
          <table class="tbl" id="posTable">
            <thead>
              <tr>
                <th>ç±»å‹</th><th>ä»£ç </th><th>åç§°</th><th>æƒé‡%</th><th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="hr"></div>
        <div class="row">
          <button class="btn secondary" id="btnFetchTech">æ‹‰å–æŒä»“æŠ€æœ¯æŒ‡æ ‡</button>
          <span class="small" id="techStatus">æœªæ‹‰å–</span>
        </div>
        <div style="margin-top:12px; overflow:auto;">
          <table class="tbl" id="techTable">
            <thead>
              <tr>
                <th>ä»£ç </th><th>è¶‹åŠ¿</th><th>åŠ¨é‡</th><th>RSI</th><th>å¤‡æ³¨</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- Floating buttons -->
  <div class="floating">
    <div class="fab" id="fabGuide" title="æŒ‡å—"><span>?</span></div>
    <div class="fab" id="fabPrompt" title="Prompt"><span>âš™ï¸</span></div>
    <div class="fab" id="fabKeywords" title="å…³é”®è¯"><span>ğŸ”</span></div>
  </div>

  <!-- Modals -->
  <div class="modal-backdrop" id="modalGuide">
    <div class="modal">
      <header>
        <div>
          <h3>æŒ‡å— // æ ‡ç­¾è§£é‡Šï¼ˆæ‰‹æœºå‹å¥½ï¼‰</h3>
          <p>è¿™äº›æ ‡ç­¾ä¸æ˜¯â€œä¹°å–æŒ‡ä»¤â€ï¼Œè€Œæ˜¯â€œå¸‚åœºçŠ¶æ€æç¤ºâ€ã€‚å¿™äººæœ€ç¨³ç”¨æ³•ï¼šç”¨å®ƒå†³å®š<strong>è¿½ä¸è¿½</strong>ã€<strong>åˆ†ä¸åˆ†æ‰¹</strong>ã€<strong>å…ˆè§‚æœ›</strong>ã€‚</p>
        </div>
        <div class="xbtn" data-close="modalGuide">âœ•</div>
      </header>

      <div class="tag info">è¶‹åŠ¿ï¼ˆä¸Šè¡Œ/ä¸‹è¡Œ/éœ‡è¡ï¼‰</div>
      <p class="muted">é€šå¸¸åŸºäº SMA20 ä¸ SMA60ï¼šSMA20 > SMA60 æ›´åå¼ºï¼›åä¹‹åå¼±ã€‚ä¸Šè¡Œä¸ç­‰äºå¿…æ¶¨ï¼Œåªè¡¨ç¤ºè¿‘æœŸæ›´å¼ºåŠ¿ã€‚</p>
      <ul class="muted">
        <li><b>ä¸Šè¡Œ</b>ï¼šæ›´é€‚åˆâ€œåˆ†æ‰¹å‚ä¸â€ï¼Œåˆ«ä¸€æŠŠæ¢­ã€‚</li>
        <li><b>ä¸‹è¡Œ</b>ï¼šæ›´é€‚åˆâ€œå°‘é‡è¯•æ¢/è§‚æœ›â€ï¼Œé¿å…æŠ„åº•å†²åŠ¨ã€‚</li>
        <li><b>éœ‡è¡</b>ï¼šæ–¹å‘ä¸æ¸…ï¼Œé€‚åˆç­‰æ˜ç¡®è¶‹åŠ¿å†åšåŠ¨ä½œã€‚</li>
      </ul>

      <div class="tag info">åŠ¨é‡ï¼ˆ20dæ¶¨è·Œå¹…ï¼‰</div>
      <p class="muted">è¿‘çº¦ä¸€ä¸ªæœˆçš„æ¶¨è·Œå¹…ã€‚åŠ¨é‡è¶Šé«˜ï¼ŒçŸ­æœŸè¿½é«˜é£é™©è¶Šå¤§ï¼›åŠ¨é‡ä¸ºè´Ÿè¯´æ˜è¿‘æœŸèµ°å¼±ã€‚</p>

      <div class="tag info">RSIï¼ˆåçƒ­/ä¸­æ€§/åå†·ï¼‰</div>
      <p class="muted">RSI æ˜¯â€œæ¶¨å¾—æ˜¯ä¸æ˜¯å¤ªå¿«â€çš„æ¸©åº¦è®¡ï¼ˆ0-100ï¼‰ï¼šé€šå¸¸ >70 åçƒ­ï¼Œ<30 åå†·ã€‚</p>
      <ul class="muted">
        <li><b>åçƒ­</b>ï¼šä¸å»ºè®®è¿½æ¶¨ä¸€æ¬¡æ€§ä¹°å…¥ï¼›æ›´é€‚åˆâ€œè§‚æœ›/å°ä»“åˆ†æ‰¹â€ã€‚</li>
        <li><b>ä¸­æ€§</b>ï¼šæ›´é€‚åˆâ€œåˆ†æ‰¹/å®šæŠ•â€ã€‚</li>
        <li><b>åå†·</b>ï¼šä¸æ˜¯å¿…ä¹°ï¼›æ›´åƒâ€œåˆ«ææ…Œå–ï¼Œå¯å¼€å§‹å…³æ³¨â€ã€‚</li>
      </ul>

      <div class="hr"></div>
      <div class="tag warn">å¿™äººåŠ¨ä½œå»ºè®®ï¼ˆNow / Next7d / Avoidï¼‰</div>
      <p class="muted">ä½ ä¸éœ€è¦ç›¯è§¦å‘æ¡ä»¶ã€‚ç³»ç»Ÿé»˜è®¤è®© AI ç»™ä½ ï¼šç°åœ¨åšä»€ä¹ˆã€è¿™å‘¨ç•™æ„ä»€ä¹ˆã€ä¸è¦åšä»€ä¹ˆã€‚è§¦å‘æ¡ä»¶ä¼šæ”¾åˆ°â€œå¯é€‰ç»†èŠ‚â€ã€‚</p>
    </div>
  </div>

  <div class="modal-backdrop" id="modalPrompt">
    <div class="modal">
      <header>
        <div>
          <h3>Prompt ç®¡ç† // ä¸‰å±‚æç¤ºè¯</h3>
          <p>System å°½é‡å°‘æ”¹ï¼›Analysis å¸¸æ”¹ï¼›Task æŒ‰æ¨¡å¼åˆ‡æ¢ã€‚æ”¯æŒä¿å­˜/å¯¼å…¥/å¯¼å‡ºã€‚</p>
        </div>
        <div class="xbtn" data-close="modalPrompt">âœ•</div>
      </header>

      <div class="row">
        <button class="btn small" id="btnPromptSave">ä¿å­˜</button>
        <button class="btn small secondary" id="btnPromptExport">å¯¼å‡º</button>
        <label class="btn small secondary" style="cursor:pointer;">
          å¯¼å…¥<input type="file" id="promptImportFile" accept="application/json" style="display:none;">
        </label>
        <button class="btn small danger" id="btnPromptReset">æ¢å¤é»˜è®¤</button>
      </div>

      <div class="hr"></div>
      <div class="small">System Promptï¼ˆå›ºå®šè§„åˆ™ï¼‰</div>
      <textarea id="promptSystem"></textarea>

      <div class="small" style="margin-top:12px;">Analysis Promptï¼ˆåˆ†æåå¥½ï¼‰</div>
      <textarea id="promptAnalysis"></textarea>

      <div class="small" style="margin-top:12px;">Task Promptï¼ˆéšæ¨¡å¼åˆ‡æ¢ï¼‰</div>
      <textarea id="promptTask"></textarea>

      <div class="small" style="margin-top:10px;">
        å°æç¤ºï¼šä½ å¯ä»¥æŠŠè¯­æ°”è°ƒå¾—æ›´â€œæœæ–­â€ï¼Œä½†ä¸å»ºè®®å†™â€œè‚¯å®šç°åœ¨å°±ä¹°â€ã€‚æ›´ç¨³çš„å†™æ³•æ˜¯ï¼šåŠ¨ä½œå»ºè®® + ç½®ä¿¡åº¦ + é£é™©ç‚¹ã€‚
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalKeywords">
    <div class="modal">
      <header>
        <div>
          <h3>å…³é”®è¯åº“ // åŒè½¨åˆ¶ï¼ˆä¸­è‹±ï¼‰</h3>
          <p>é»˜è®¤åº“ + è‡ªå®šä¹‰åº“å¹¶å­˜ã€‚é»˜è®¤æ›´æ–°ä¸ä¼šè¦†ç›–è‡ªå®šä¹‰ã€‚å¯ä¸€é”®ç”Ÿæˆå¯å¤åˆ¶çš„æœç´¢è¯­å¥ã€‚</p>
        </div>
        <div class="xbtn" data-close="modalKeywords">âœ•</div>
      </header>

      <div class="row">
        <button class="btn small" id="btnKwSave">ä¿å­˜</button>
        <button class="btn small secondary" id="btnKwExport">å¯¼å‡º</button>
        <label class="btn small secondary" style="cursor:pointer;">
          å¯¼å…¥<input type="file" id="kwImportFile" accept="application/json" style="display:none;">
        </label>
        <button class="btn small danger" id="btnKwReset">æ¢å¤é»˜è®¤</button>
      </div>

      <div class="hr"></div>
      <div class="two">
        <div>
          <div class="small">æ€»æ–°é—»æ¡æ•°ä¸Šé™ï¼ˆå–‚ç»™AIæ—¶ï¼‰</div>
          <input id="kwMaxItems" type="number" min="6" max="30"/>
        </div>
        <div>
          <div class="small">å¤–åª’ä¼˜å…ˆç«™ç‚¹ï¼ˆé€—å·åˆ†éš”ï¼Œå¯æ”¹ï¼‰</div>
          <input id="kwSites" placeholder="reuters.com, ft.com, wsj.com, bloomberg.com" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="two">
        <div>
          <div class="small">é»˜è®¤å…³é”®è¯ç»„ï¼ˆå¯ç¦ç”¨ï¼Œä¸ä¼šè¢«è‡ªå®šä¹‰è¦†ç›–ï¼‰</div>
          <div id="kwDefault"></div>
        </div>
        <div>
          <div class="small">è‡ªå®šä¹‰å…³é”®è¯ç»„ï¼ˆä½ è‡ªå·±åŠ çš„ï¼‰</div>
          <div class="row" style="margin-bottom:10px;">
            <button class="btn small" id="btnKwAddCustom">æ–°å¢è‡ªå®šä¹‰ç»„</button>
          </div>
          <div id="kwCustom"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="btnKwBuildQueries">ç”Ÿæˆå¯å¤åˆ¶æœç´¢è¯­å¥</button>
        <button class="btn secondary" id="btnKwOpenTop">æ‰“å¼€å¤–åª’æœç´¢ï¼ˆæ–°æ ‡ç­¾é¡µï¼‰</button>
      </div>
      <textarea id="kwQueries" class="mono" style="margin-top:10px; min-height:140px;" placeholder="ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®ç”Ÿæˆ..."></textarea>
    </div>
  </div>

  <div class="modal-backdrop" id="modalPayload">
    <div class="modal">
      <header>
        <div>
          <h3>å–‚ç»™ AI çš„æ•°æ®ï¼ˆè°ƒè¯•ï¼‰</h3>
          <p>è¿™é‡Œæ˜¯â€œé»˜è®¤å¿…å–‚â€çš„æœ€ç»ˆ payload é¢„è§ˆï¼ˆJSONï¼‰ã€‚</p>
        </div>
        <div class="xbtn" data-close="modalPayload">âœ•</div>
      </header>
      <div class="row">
        <button class="btn small secondary" id="btnCopyPayload">å¤åˆ¶JSON</button>
      </div>
      <textarea id="payloadBox" class="mono" style="margin-top:10px; min-height:340px;"></textarea>
    </div>
  </div>

<script>
/* =========================
   Storage helpers
========================= */
const LS = {
  apiBase: "nq_api_base",
  sectorsCustom: "nq_sectors_custom_v1",
  sectorsHidden: "nq_sectors_hidden_v1",
  sectorResults: "nq_sector_results_v1",
  sectorFail: "nq_sector_fail_v1",
  news: "nq_news_v1",
  positions: "nq_positions_v1",
  techCache: "nq_tech_cache_v1",
  prompt: "nq_prompts_v1",
  keywords: "nq_keywords_v1"
};

const DEFAULT_API_BASE = "https://invest-copilot-backend.onrender.com";

function nowMs(){ return Date.now(); }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

function loadJson(key, fallback){
  try{
    const s = localStorage.getItem(key);
    if(!s) return fallback;
    return JSON.parse(s);
  }catch{ return fallback; }
}
function saveJson(key, obj){
  localStorage.setItem(key, JSON.stringify(obj));
}

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function fmtNum(x, d=2){
  const n = Number(x);
  if(!Number.isFinite(n)) return "â€”";
  return n.toFixed(d);
}
function pct(x, d=1){
  const n = Number(x);
  if(!Number.isFinite(n)) return "â€”";
  return (n>=0?"+":"") + n.toFixed(d) + "%";
}
function trendFrom(sma20, sma60){
  if(!Number.isFinite(sma20) || !Number.isFinite(sma60)) return "â€”";
  if(sma20 > sma60 * 1.002) return "ä¸Šè¡Œ";
  if(sma20 < sma60 * 0.998) return "ä¸‹è¡Œ";
  return "éœ‡è¡";
}
function rsiTag(rsi){
  const n = Number(rsi);
  if(!Number.isFinite(n)) return "â€”";
  if(n >= 70) return "åçƒ­";
  if(n <= 30) return "åå†·";
  return "ä¸­æ€§";
}
function marketTag(mkt){
  if(mkt === "CN_FUND") return "å›½å†…";
  return "US";
}

/* =========================
   Default sectors (proxy ETFs)
========================= */
const DEFAULT_SECTORS = [
  { id:"d1", market:"US", theme:"å¤§ç›˜", symbol:"SPY", name:"S&P 500" },
  { id:"d2", market:"US", theme:"ç§‘æŠ€", symbol:"XLK", name:"Technology" },
  { id:"d3", market:"US", theme:"åŠå¯¼ä½“", symbol:"SMH", name:"Semiconductors" },
  { id:"d4", market:"US", theme:"AI/æˆé•¿", symbol:"QQQ", name:"Nasdaq 100" },
  { id:"d5", market:"US", theme:"é‡‘è", symbol:"XLF", name:"Financials" },
  { id:"d6", market:"US", theme:"èƒ½æº", symbol:"XLE", name:"Energy" },
  { id:"d7", market:"US", theme:"æ¶ˆè´¹", symbol:"XLY", name:"Consumer Discretionary" },
  { id:"d8", market:"US", theme:"åŒ»ç–—", symbol:"XLV", name:"Health Care" },
  { id:"d9", market:"US", theme:"å·¥ä¸š", symbol:"XLI", name:"Industrials" },
  { id:"d10", market:"US", theme:"è´µé‡‘å±-é»„é‡‘", symbol:"GLD", name:"Gold" },
  { id:"d11", market:"US", theme:"è´µé‡‘å±-ç™½é“¶", symbol:"SLV", name:"Silver" },
  { id:"d12", market:"US", theme:"æ–°èƒ½æº", symbol:"ICLN", name:"Clean Energy" },
  { id:"d13", market:"US", theme:"å¤ªé˜³èƒ½", symbol:"TAN", name:"Solar" }
];

/* =========================
   Default prompts
========================= */
const DEFAULT_PROMPTS = {
  system: `ä½ æ˜¯æŠ•èµ„ç»„åˆåˆ†æåŠ©æ‰‹ã€‚å¿…é¡»ä¸¥æ ¼åŸºäºæˆ‘æä¾›çš„æ•°æ®ï¼ˆæŒä»“ã€æŠ€æœ¯æŒ‡æ ‡ã€æ¿å—åŠ¨å‘ã€æ–°é—»æ‘˜è¦ã€é£æ§æ ¡éªŒï¼‰è¿›è¡Œæ¨ç†ï¼Œä¸å¾—ç¼–é€ æ•°æ®æˆ–å¼•ç”¨ä¸å­˜åœ¨çš„æ¥æºã€‚ç¦æ­¢ä½¿ç”¨â€œä¿è¯æ”¶ç›Š/è‚¯å®šæ¶¨/ç°åœ¨å¿…é¡»ä¹°â€ç­‰ç¡®å®šæ€§æ‰¿è¯ºã€‚è¾“å‡ºå¿…é¡»åŒ…å«ï¼šNow / Next7d / Avoid ä¸‰æ®µåŠ¨ä½œå»ºè®®ï¼Œå¹¶è¯´æ˜æ¯æ¡å»ºè®®å¼•ç”¨äº†å“ªäº›è¾“å…¥ä¿¡å·ï¼ˆç”¨ç®€çŸ­æ•°æ®ç‚¹ï¼‰ã€‚å¦‚æœè¾“å…¥ä¸è¶³è¯·æ˜ç¡®è¯´æ˜ç¼ºå£å¹¶ç»™å‡ºæœ€å°è¡¥å……å»ºè®®ã€‚`,
  analysis: `åˆ†æç›®æ ‡ï¼šç»™å¿™ç¢Œç”¨æˆ·æä¾›å¯æ‰§è¡Œã€ä½ç»´æŠ¤æˆæœ¬çš„ç»„åˆå»ºè®®ã€‚ä¼˜å…ˆè€ƒè™‘é£é™©æ§åˆ¶ä¸åˆ†æ•£ï¼Œé¿å…è¿½é«˜ã€‚å…è®¸ç»™å‡ºâ€œæ›´è¿›å–/æ›´ä¿å®ˆâ€ä¸¤å¥—æ–¹æ¡ˆï¼ˆå„ä¸è¶…è¿‡3æ¡ï¼‰ã€‚å°½é‡å°‘ç”¨å¤æ‚è§¦å‘æ¡ä»¶ï¼›å¦‚éœ€è§¦å‘æ¡ä»¶æ”¾åˆ°â€œå¯é€‰ç»†èŠ‚â€ã€‚`,
  tasks: {
    opportunity_radar: `ä»»åŠ¡ï¼šåŸºäºæ¿å—åŠ¨å‘ï¼ˆProxy ETFï¼‰+ æ–°é—»æ‘˜è¦ + æŠ€æœ¯æŒ‡æ ‡ï¼Œç»™å‡ºæœªæ¥1-4å‘¨å€¼å¾—ç•™æ„çš„3-6ä¸ªæ¿å—ã€‚æ¯ä¸ªæ¿å—è¾“å‡ºï¼šä¸€å¥ç†ç”± + åŠ¨ä½œå»ºè®®ï¼ˆè§‚å¯Ÿ/å°ä»“è¯•æ¢/åˆ†æ‰¹ï¼‰+ ç½®ä¿¡åº¦ï¼ˆé«˜/ä¸­/ä½ï¼‰+ ä¸»è¦é£é™©ç‚¹ã€‚`,
    risk_check: `ä»»åŠ¡ï¼šåšä¸€æ¬¡ç»„åˆé£é™©ä½“æ£€ã€‚ç”¨æŠ€æœ¯æŒ‡æ ‡ã€æ¿å—åŠ¨å‘ã€æ–°é—»æ‘˜è¦åˆ¤æ–­æœªæ¥1-4å‘¨ä¸»è¦é£é™©ã€‚å¯¹ç…§riskEngineä»…ä½œæ ¡éªŒï¼ŒæŒ‡å‡ºä¸€è‡´/ä¸ä¸€è‡´åŸå› ã€‚`,
    weekly_review: `ä»»åŠ¡ï¼šåšæœ¬å‘¨å¤ç›˜ï¼šå“ªäº›ä»“ä½è´¡çŒ®é£é™©/æ”¶ç›Šï¼Œæ˜¯å¦éœ€è¦è°ƒä»“ï¼ˆç»™åŒºé—´ï¼Œä¸ç»™ç²¾ç¡®ç‚¹ä½ï¼‰ã€‚å¼ºè°ƒä½ç»´æŠ¤ä¸å¯æ‰§è¡Œæ€§ã€‚`
  }
};

/* =========================
   Default keyword library (dual track)
========================= */
const DEFAULT_KW = {
  settings: {
    mode: "dual_track",
    totalMaxItems: 15,
    sites: ["reuters.com","ft.com","wsj.com","bloomberg.com","sec.gov","prnewswire.com","businesswire.com"]
  },
  defaultGroups: [
    { id:"macro", name:"å®è§‚/åˆ©ç‡/æ±‡ç‡", enabled:true, weight:5, maxItems:3,
      zh:["ç¾è”å‚¨ åˆ©ç‡ ç‚¹é˜µå›¾","ç¾å…ƒæŒ‡æ•° èµ°å¼º","ä¸­å›½ é™å‡† é™æ¯","äººæ°‘å¸ æ±‡ç‡ æ³¢åŠ¨"],
      en:["Fed rates hold dot plot","US dollar index strength","PBOC RRR cut rate cut","USD/CNY moves"]
    },
    { id:"china_internet", name:"ä¸­å›½äº’è”ç½‘/æ¸¯è‚¡ç§‘æŠ€", enabled:true, weight:5, maxItems:3,
      zh:["æ¸¯è‚¡ç§‘æŠ€ ç›‘ç®¡","å¹³å°ç»æµ æ”¿ç­–","æ’ç”Ÿç§‘æŠ€ èµ„é‡‘æµ"],
      en:["China internet platforms regulation update","Hang Seng Tech Index rally drivers","Tencent Alibaba Meituan news"]
    },
    { id:"ai", name:"AI/ç®—åŠ›/åŠå¯¼ä½“", enabled:true, weight:5, maxItems:3,
      zh:["è‹±ä¼Ÿè¾¾ è´¢æŠ¥ æŒ‡å¼•","ç®—åŠ› è®¢å• æœåŠ¡å™¨","åŠå¯¼ä½“ äº§ä¸šé“¾ æ™¯æ°”"],
      en:["Nvidia earnings guidance AI demand","AI server orders datacenter capex","semiconductor cycle outlook"]
    },
    { id:"commod", name:"è´µé‡‘å±/å¤§å®—", enabled:true, weight:4, maxItems:2,
      zh:["é»„é‡‘ ä»·æ ¼ èµ°å¼º","ç™½é“¶ æ³¢åŠ¨","ç¾å€ºæ”¶ç›Šç‡ é‡‘ä»·"],
      en:["gold prices rise yields","silver volatility","real yields and gold"]
    }
  ],
  customGroups: []
};

/* =========================
   DOM refs
========================= */
const $ = (id)=>document.getElementById(id);

const apiBaseEl = $("apiBase");
const backendText = $("backendText");
const healthText = $("healthText");
const healthDot = $("healthDot");

const sectorTableBody = $("sectorTable").querySelector("tbody");
const sectorManageBody = $("sectorManageTable").querySelector("tbody");
const scanStatus = $("scanStatus");

const modalGuide = $("modalGuide");
const modalPrompt = $("modalPrompt");
const modalKeywords = $("modalKeywords");
const modalPayload = $("modalPayload");

const payloadBox = $("payloadBox");

let API_BASE = DEFAULT_API_BASE;

/* =========================
   Modal helpers
========================= */
function openModal(id){ $(id).style.display = "flex"; }
function closeModal(id){ $(id).style.display = "none"; }
document.addEventListener("click", (e)=>{
  const closeId = e.target?.getAttribute?.("data-close");
  if(closeId) closeModal(closeId);
  if(e.target.classList.contains("modal-backdrop")) e.target.style.display="none";
});

/* =========================
   Init API base
========================= */
function initApiBase(){
  const saved = localStorage.getItem(LS.apiBase);
  API_BASE = (saved || DEFAULT_API_BASE).trim().replace(/\/+$/,"");
  apiBaseEl.value = API_BASE;
  backendText.textContent = API_BASE || "(æœªè®¾ç½®)";
}
apiBaseEl.addEventListener("change", ()=>{
  API_BASE = apiBaseEl.value.trim().replace(/\/+$/,"");
  localStorage.setItem(LS.apiBase, API_BASE);
  backendText.textContent = API_BASE || "(æœªè®¾ç½®)";
});

/* =========================
   Health check
========================= */
async function checkHealth(){
  if(!API_BASE){ healthText.textContent="æœªè®¾ç½®åç«¯"; healthDot.className="baddot"; return; }
  try{
    const r = await fetch(API_BASE + "/health", { cache:"no-store" });
    const j = await r.json();
    if(j?.ok){
      healthText.textContent = "OK " + (j.build || "");
      healthDot.className="okdot";
    }else{
      healthText.textContent = "å¼‚å¸¸";
      healthDot.className="baddot";
    }
  }catch(e){
    healthText.textContent = "æ— æ³•è¿æ¥";
    healthDot.className="baddot";
  }
}

/* =========================
   Clear local cache
========================= */
$("btnClearLocal").addEventListener("click", ()=>{
  const keys = Object.values(LS);
  for(const k of keys) localStorage.removeItem(k);
  location.reload();
});

/* =========================
   News box
========================= */
function initNews(){
  $("newsBox").value = localStorage.getItem(LS.news) || "";
}
$("btnSaveNews").addEventListener("click", ()=>{
  localStorage.setItem(LS.news, $("newsBox").value || "");
  alert("å·²ä¿å­˜æ–°é—»æ‘˜è¦");
});
$("btnClearNews").addEventListener("click", ()=>{
  $("newsBox").value = "";
  localStorage.removeItem(LS.news);
});

/* =========================
   Sectors: load/merge/default+custom-hidden
========================= */
function getSectors(){
  const custom = loadJson(LS.sectorsCustom, []);
  const hidden = new Set(loadJson(LS.sectorsHidden, []));
  const defaults = DEFAULT_SECTORS.filter(s => !hidden.has(s.id));
  // assign stable ids for custom
  const merged = [...defaults, ...custom];
  return { merged, custom, hidden };
}
function saveCustomSectors(custom){ saveJson(LS.sectorsCustom, custom); }
function saveHiddenDefaults(hiddenIds){ saveJson(LS.sectorsHidden, hiddenIds); }

function renderSectorsManage(){
  const { merged, custom, hidden } = getSectors();
  sectorManageBody.innerHTML = "";
  for(const s of merged){
    const tr = document.createElement("tr");
    const isDefault = s.id && String(s.id).startsWith("d");
    tr.innerHTML = `
      <td>${escapeHtml(s.theme || "æœªåˆ†ç±»")}</td>
      <td><span class="tag ${s.market==="CN_FUND"?"warn":"info"}">${marketTag(s.market)}</span></td>
      <td class="mono">${escapeHtml(s.symbol)}</td>
      <td>
        ${isDefault
          ? `<button class="btn small secondary" data-hide="${s.id}">éšè—</button>`
          : `<button class="btn small danger" data-del="${escapeAttr(s.id)}">åˆ é™¤</button>`
        }
      </td>
    `;
    sectorManageBody.appendChild(tr);
  }
  // handlers
  sectorManageBody.querySelectorAll("[data-hide]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-hide");
      const hiddenIds = loadJson(LS.sectorsHidden, []);
      if(!hiddenIds.includes(id)) hiddenIds.push(id);
      saveHiddenDefaults(hiddenIds);
      renderSectorsManage();
      renderSectorTable(); // reflect
    });
  });
  sectorManageBody.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-del");
      const customNow = loadJson(LS.sectorsCustom, []);
      saveCustomSectors(customNow.filter(x=>String(x.id)!==String(id)));
      renderSectorsManage();
      renderSectorTable();
    });
  });
}

function uuid(){
  return "c_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

$("btnAddSector").addEventListener("click", ()=>{
  const market = $("sectorMarket").value;
  const theme = $("sectorTheme").value.trim();
  const symbol = $("sectorSymbol").value.trim().toUpperCase();
  const name = $("sectorName").value.trim();
  if(!theme || !symbol){
    alert("è¯·å¡«å†™ï¼šæ¿å—å + Proxyä»£ç ");
    return;
  }
  if(market === "CN_FUND" && !/^\d{6}$/.test(symbol)){
    alert("å›½å†…ETF/åŸºé‡‘è¯·å¡«å†™ 6 ä½æ•°å­—ä»£ç ï¼ˆä¾‹å¦‚ 512480ï¼‰");
    return;
  }
  const custom = loadJson(LS.sectorsCustom, []);
  custom.push({ id: uuid(), market, theme, symbol, name: name||null });
  saveCustomSectors(custom);
  $("sectorTheme").value=""; $("sectorSymbol").value=""; $("sectorName").value="";
  renderSectorsManage();
  renderSectorTable();
});

$("btnResetSectors").addEventListener("click", ()=>{
  if(!confirm("ç¡®å®šé‡ç½®é»˜è®¤ï¼Ÿä¼šæ¢å¤æ‰€æœ‰é»˜è®¤æ¿å—ï¼Œå¹¶æ¸…ç©ºè‡ªå®šä¹‰ã€‚")) return;
  saveCustomSectors([]);
  saveHiddenDefaults([]);
  localStorage.removeItem(LS.sectorResults);
  localStorage.removeItem(LS.sectorFail);
  renderSectorsManage();
  renderSectorTable();
});

$("btnExportSectors").addEventListener("click", ()=>{
  const custom = loadJson(LS.sectorsCustom, []);
  const hidden = loadJson(LS.sectorsHidden, []);
  const blob = new Blob([JSON.stringify({ custom, hidden }, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "neon_sectors.json";
  a.click();
});

$("sectorImportFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const j = JSON.parse(txt);
    if(Array.isArray(j.custom)) saveCustomSectors(j.custom);
    if(Array.isArray(j.hidden)) saveHiddenDefaults(j.hidden);
    alert("å¯¼å…¥æˆåŠŸ");
    renderSectorsManage();
    renderSectorTable();
  }catch(err){
    alert("å¯¼å…¥å¤±è´¥ï¼š" + String(err));
  }finally{
    e.target.value="";
  }
});

/* =========================
   Sector results cache
========================= */
function loadSectorResults(){
  return loadJson(LS.sectorResults, { ts:0, map:{} });
}
function saveSectorResults(obj){
  saveJson(LS.sectorResults, obj);
}
function loadSectorFailSet(){
  const arr = loadJson(LS.sectorFail, []);
  return new Set(arr);
}
function saveSectorFailSet(set){
  saveJson(LS.sectorFail, Array.from(set));
}

/* =========================
   Render sector table
========================= */
function renderSectorTable(){
  const { merged } = getSectors();
  const cache = loadSectorResults();
  sectorTableBody.innerHTML = "";
  for(const s of merged){
    const key = sectorKey(s);
    const r = cache.map?.[key] || null;
    const ok = r?.ok === true;
    const t = ok ? trendFrom(r.sma20, r.sma60) : "â€”";
    const status = ok ? `<span class="tag good">OK</span>` : `<span class="tag bad">æš‚æ— æ•°æ®</span>`;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(s.theme)} <span class="small muted">Â· ${escapeHtml(s.name || "")}</span></td>
      <td><span class="tag ${s.market==="CN_FUND"?"warn":"info"}">${marketTag(s.market)}</span></td>
      <td class="mono">${escapeHtml(s.symbol)}</td>
      <td>${labelTrend(t)}</td>
      <td>${labelRet(r?.ret20)}</td>
      <td>${labelRsi(r?.rsi14)}</td>
      <td>${status}<div class="small muted">${escapeHtml(r?.reason || "")}</div></td>
    `;
    sectorTableBody.appendChild(tr);
  }
}
function labelTrend(t){
  if(t==="ä¸Šè¡Œ") return `<span class="tag good">ä¸Šè¡Œ</span>`;
  if(t==="ä¸‹è¡Œ") return `<span class="tag bad">ä¸‹è¡Œ</span>`;
  if(t==="éœ‡è¡") return `<span class="tag warn">éœ‡è¡</span>`;
  return "â€”";
}
function labelRet(v){
  if(!Number.isFinite(Number(v))) return "â€”";
  const n = Number(v);
  if(n>=6) return `<span class="tag good">${pct(n)}</span>`;
  if(n>=2) return `<span class="tag info">${pct(n)}</span>`;
  if(n<=-4) return `<span class="tag bad">${pct(n)}</span>`;
  return `<span class="tag warn">${pct(n)}</span>`;
}
function labelRsi(v){
  if(!Number.isFinite(Number(v))) return "â€”";
  const n = Number(v);
  const tag = rsiTag(n);
  if(tag==="åçƒ­") return `<span class="tag warn">${fmtNum(n,0)} åçƒ­</span>`;
  if(tag==="åå†·") return `<span class="tag warn">${fmtNum(n,0)} åå†·</span>`;
  return `<span class="tag info">${fmtNum(n,0)} ä¸­æ€§</span>`;
}
function sectorKey(s){
  return `${s.market||"US"}:${s.symbol}`;
}

/* =========================
   Paced scanning (1 item / 15s)
========================= */
let scanAbort = null;

async function postJson(url, body, {timeoutMs=30000, signal=null}={}){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  const mergedSignal = mergeSignals(signal, ctrl.signal);
  try{
    const r = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body),
      signal: mergedSignal
    });
    const j = await r.json();
    return j;
  } finally{
    clearTimeout(t);
  }
}

function mergeSignals(a,b){
  if(!a) return b;
  if(!b) return a;
  const ctrl = new AbortController();
  const onAbort = ()=>ctrl.abort();
  a.addEventListener("abort", onAbort, {once:true});
  b.addEventListener("abort", onAbort, {once:true});
  return ctrl.signal;
}

function setScanStatus(txt){ scanStatus.textContent = txt; }

async function scanAll({force=false, onlyFailed=false}={}){
  const { merged } = getSectors();
  if(!merged.length){ setScanStatus("æ²¡æœ‰æ¿å—"); return; }

  if(scanAbort) scanAbort.abort();
  scanAbort = new AbortController();

  // load cache
  const cache = loadSectorResults();
  const map = cache.map || {};
  const failSet = loadSectorFailSet();

  // determine worklist
  const ttlOk = 6*60*60*1000;      // 6h
  const ttlFail = 10*60*1000;      // 10m
  const now = nowMs();

  const work = [];
  for(const s of merged){
    const key = sectorKey(s);
    const r = map[key];
    const age = r?.ts ? (now - r.ts) : Infinity;
    const isOk = r?.ok === true;
    const shouldByFail = onlyFailed ? failSet.has(key) : true;
    if(!shouldByFail) continue;

    if(force){
      work.push(s);
      continue;
    }
    if(isOk && age < ttlOk) continue;
    if(!isOk && age < ttlFail) continue;
    work.push(s);
  }

  if(!work.length){
    setScanStatus("æ— éœ€åˆ·æ–°ï¼ˆç¼“å­˜ä»æœ‰æ•ˆï¼‰ã€‚å¦‚è¦é‡æ‰«å¤±è´¥é¡¹è¯·ç‚¹ï¼šå¼ºåˆ¶é‡æ‰«å¤±è´¥é¡¹ã€‚");
    renderSectorTable();
    return;
  }

  const total = work.length;
  setScanStatus(`å¼€å§‹æ…¢æ‰« ${total} ä¸ªï¼ˆ1ä¸ª/15ç§’ï¼‰ã€‚è¯·å‹¿é¢‘ç¹ç‚¹å‡»å…¶ä»–åˆ·æ–°ï¼Œé¿å…APIé™æµã€‚`);
  renderSectorTable();

  let done=0;
  for(const s of work){
    if(scanAbort.signal.aborted) { setScanStatus("å·²åœæ­¢"); break; }

    done += 1;
    setScanStatus(`æ‰«æä¸­â€¦ ${done}/${total} Â· ${s.symbol}ï¼ˆ${marketTag(s.market)}ï¼‰`);

    try{
      const j = await postJson(API_BASE + "/api/sector/scan", { items:[s] }, { timeoutMs: 45000, signal: scanAbort.signal });
      const item = j?.items?.[0];
      if(item){
        const key = sectorKey(s);
        // normalize store
        map[key] = { ...item, ts: nowMs(), market:s.market, theme:s.theme, symbol:s.symbol, name:s.name||item.name||null };
        if(item.ok) failSet.delete(key);
        else failSet.add(key);
      }
      saveSectorResults({ ts: nowMs(), map });
      saveSectorFailSet(failSet);
      renderSectorTable();
    }catch(e){
      const key = sectorKey(s);
      map[key] = { ok:false, reason: "request failed/timeout", ts: nowMs(), market:s.market, theme:s.theme, symbol:s.symbol, name:s.name||null };
      failSet.add(key);
      saveSectorResults({ ts: nowMs(), map });
      saveSectorFailSet(failSet);
      renderSectorTable();
    }

    if(done < total){
      // 15s pacing
      for(let t=15; t>=1; t--){
        if(scanAbort.signal.aborted) break;
        setScanStatus(`å·²å®Œæˆ ${done}/${total} Â· ç­‰å¾… ${t}s åç»§ç»­â€¦`);
        await sleep(1000);
      }
    }
  }

  if(!scanAbort.signal.aborted){
    const left = Array.from(failSet).filter(k=>{
      // only those in current sector list
      return merged.some(s=>sectorKey(s)===k);
    }).length;
    setScanStatus(left ? `æ‰«æå®Œæˆï¼ˆä»æœ‰ ${left} ä¸ªå¤±è´¥é¡¹ï¼Œå¯ç‚¹â€œå¼ºåˆ¶é‡æ‰«å¤±è´¥é¡¹â€ç¨åè¡¥æ‰«ï¼‰` : "æ‰«æå®Œæˆ âœ… å…¨éƒ¨æœ‰æ•°æ®");
  }
}

/* Buttons */
$("btnScan").addEventListener("click", ()=>scanAll({force:false, onlyFailed:false}));
$("btnStopScan").addEventListener("click", ()=>{
  if(scanAbort) scanAbort.abort();
  setScanStatus("å·²åœæ­¢");
});
$("btnForceScan").addEventListener("click", ()=>scanAll({force:true, onlyFailed:true}));

/* =========================
   Positions
========================= */
function loadPositions(){ return loadJson(LS.positions, []); }
function savePositions(ps){ saveJson(LS.positions, ps); }

function renderPositions(){
  const ps = loadPositions();
  const body = $("posTable").querySelector("tbody");
  body.innerHTML = "";
  for(const p of ps){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="tag ${p.type==="CN_FUND"?"warn":"info"}">${p.type==="CN_FUND"?"å›½å†…":"US"}</span></td>
      <td class="mono">${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.name||"")}</td>
      <td>${fmtNum(p.weight,1)}</td>
      <td><button class="btn small danger" data-delpos="${escapeAttr(p.id)}">åˆ é™¤</button></td>
    `;
    body.appendChild(tr);
  }
  body.querySelectorAll("[data-delpos]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-delpos");
      savePositions(loadPositions().filter(x=>String(x.id)!==String(id)));
      renderPositions();
    });
  });
}

function posUuid(){ return "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

$("btnAddPos").addEventListener("click", ()=>{
  const type = $("posType").value;
  let code = $("posCode").value.trim();
  const name = $("posName").value.trim();
  const weight = Number($("posWeight").value.trim());
  if(!code || !Number.isFinite(weight)){
    alert("è¯·å¡«å†™ï¼šä»£ç  + æƒé‡ï¼ˆæ•°å­—ï¼‰");
    return;
  }
  if(type==="CN_FUND"){
    if(!/^\d{1,6}$/.test(code)){ alert("å›½å†…åŸºé‡‘/ETF è¯·è¾“å…¥ 1-6 ä½æ•°å­—"); return; }
    code = code.padStart(6,"0");
  }else{
    code = code.toUpperCase();
  }
  const ps = loadPositions();
  ps.push({ id: posUuid(), type, code, name: name||null, weight });
  savePositions(ps);
  $("posCode").value=""; $("posName").value=""; $("posWeight").value="";
  renderPositions();
});

$("btnClearPos").addEventListener("click", ()=>{
  if(!confirm("æ¸…ç©ºæ‰€æœ‰æŒä»“ï¼Ÿ")) return;
  savePositions([]);
  localStorage.removeItem(LS.techCache);
  renderPositions();
  renderTechTable([]);
});

$("btnExportPos").addEventListener("click", ()=>{
  const ps = loadPositions();
  const blob = new Blob([JSON.stringify(ps, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "neon_positions.json";
  a.click();
});

$("posImportFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const j = JSON.parse(txt);
    if(!Array.isArray(j)) throw new Error("æ ¼å¼å¿…é¡»æ˜¯æ•°ç»„");
    savePositions(j);
    renderPositions();
    alert("å¯¼å…¥æˆåŠŸ");
  }catch(err){
    alert("å¯¼å…¥å¤±è´¥ï¼š" + String(err));
  }finally{
    e.target.value="";
  }
});

/* =========================
   Tech fetch for positions
========================= */
function renderTechTable(items){
  const body = $("techTable").querySelector("tbody");
  body.innerHTML = "";
  for(const it of items){
    const ok = it.ok === true;
    const t = ok ? trendFrom(it.sma20, it.sma60) : "â€”";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(it.code||it.symbol||"")}</td>
      <td>${labelTrend(t)}</td>
      <td>${ok ? labelRet(it.ret20) : "â€”"}</td>
      <td>${ok ? labelRsi(it.rsi14) : "â€”"}</td>
      <td class="small muted">${escapeHtml(ok ? (it.source||it.historySource||"") : (it.reason||""))}</td>
    `;
    body.appendChild(tr);
  }
}

async function fetchTechForPositions(){
  const ps = loadPositions();
  if(!ps.length){ alert("è¯·å…ˆæ·»åŠ æŒä»“"); return; }
  $("techStatus").textContent = "æ‹‰å–ä¸­â€¦";
  try{
    const positions = ps.map(p=>{
      const type = p.type === "CN_FUND" ? "CN_FUND" : "US_TICKER";
      return { type, code: p.code, name: p.name };
    });
    const j = await postJson(API_BASE + "/api/tech/batch", { positions }, { timeoutMs: 60000 });
    const items = j?.items || [];
    saveJson(LS.techCache, { ts: nowMs(), items });
    renderTechTable(items.map(x=>({ ...x, code: x.code })));
    $("techStatus").textContent = "å·²æ›´æ–°";
  }catch(e){
    $("techStatus").textContent = "å¤±è´¥ï¼š" + String(e);
  }
}
$("btnFetchTech").addEventListener("click", fetchTechForPositions);

/* =========================
   Risk engine (simple, deterministic)
========================= */
function computeRiskEngine(){
  const ps = loadPositions();
  const totalW = ps.reduce((a,b)=>a + (Number(b.weight)||0), 0);
  const wNorm = totalW > 0 ? totalW : 100;
  const sorted = [...ps].sort((a,b)=>(Number(b.weight)||0)-(Number(a.weight)||0));
  const top1 = sorted[0] ? { code: sorted[0].code, weight: Number(sorted[0].weight)||0 } : null;
  const top3Sum = sorted.slice(0,3).reduce((a,b)=>a + (Number(b.weight)||0), 0);
  const singleConcentration = top1 ? +(top1.weight / wNorm * 100).toFixed(1) : null;
  const top3Concentration = +(top3Sum / wNorm * 100).toFixed(1);

  const flags = [];
  if(singleConcentration != null && singleConcentration >= 35) flags.push({ level:"warn", rule:"å•ä¸€æŒä»“å æ¯”åé«˜", value: singleConcentration + "%" });
  if(top3Concentration >= 70) flags.push({ level:"warn", rule:"å‰ä¸‰é›†ä¸­åº¦åé«˜", value: top3Concentration + "%" });
  if(ps.filter(p=>p.type==="US_TICKER").length && ps.filter(p=>p.type==="CN_FUND").length===0){
    flags.push({ level:"info", rule:"åœ°åŸŸåå‘", value:"ä¸»è¦ä¸ºæµ·å¤–èµ„äº§" });
  }
  return {
    totalWeight: +wNorm.toFixed(1),
    singleConcentration,
    top3Concentration,
    top1,
    flags
  };
}

/* =========================
   Compose AI input (default must-feed)
   -> Copies a single markdown text to clipboard
========================= */
function loadPrompts(){
  const saved = loadJson(LS.prompt, null);
  if(saved && saved.system && saved.analysis && saved.tasks) return saved;
  return structuredClone(DEFAULT_PROMPTS);
}
function savePrompts(p){ saveJson(LS.prompt, p); }

function loadKeywords(){
  const saved = loadJson(LS.keywords, null);
  if(saved && saved.settings && saved.defaultGroups && saved.customGroups) return saved;
  return structuredClone(DEFAULT_KW);
}
function saveKeywords(k){ saveJson(LS.keywords, k); }

function getTaskPrompt(mode){
  const p = loadPrompts();
  return p.tasks?.[mode] || "";
}

function currentPayload(){
  const ps = loadPositions();
  const tech = loadJson(LS.techCache, {ts:0, items:[]});
  const sectorCache = loadSectorResults();
  const { merged } = getSectors();
  const sectors = merged.map(s=>{
    const key = sectorKey(s);
    return sectorCache.map?.[key] ? { ...sectorCache.map[key], market:s.market, theme:s.theme, symbol:s.symbol, name:s.name||null } : { ok:false, market:s.market, theme:s.theme, symbol:s.symbol, name:s.name||null, reason:"no scan yet" };
  });
  const news = ($("newsBox").value || "").trim();
  const kw = loadKeywords();
  const risk = computeRiskEngine();
  return {
    meta: { app:"NEON QUANT", ts: new Date().toISOString() },
    inputs: {
      positions: ps,
      techIndicators: tech.items || [],
      sectorScan: sectors,
      newsDigest: news ? [{ text: news, source:"user_paste" }] : []
    },
    riskEngine: {
      computed: risk,
      note: "è¿™æ˜¯ç³»ç»Ÿè§„åˆ™è®¡ç®—ç»“æœï¼Œä»…ç”¨äºæ ¡éªŒã€‚è¯·AIç‹¬ç«‹å¤æ ¸å¹¶æŒ‡å‡ºä¸€è‡´/ä¸ä¸€è‡´åŸå› ã€‚"
    },
    keywordLibrary: kw
  };
}

function composeMarkdown(){
  const mode = $("taskMode").value;
  const prompts = loadPrompts();
  const payload = currentPayload();

  const feedRisk = $("feedRisk").checked;
  const feedTech = $("feedTech").checked;
  const feedSectors = $("feedSectors").checked;
  const feedNews = $("feedNews").checked;

  // Build reduced payload based on toggles (still include keywordLibrary)
  const reduced = structuredClone(payload);
  if(!feedTech) reduced.inputs.techIndicators = [];
  if(!feedSectors) reduced.inputs.sectorScan = [];
  if(!feedNews) reduced.inputs.newsDigest = [];
  if(!feedRisk) reduced.riskEngine = { note:"ï¼ˆå·²å…³é—­é£æ§æ ¡éªŒå–‚å…¥ï¼‰" };

  const sys = prompts.system || "";
  const ana = prompts.analysis || "";
  const task = getTaskPrompt(mode);

  const md = [
`# NEON QUANT // AI åˆ†æè¾“å…¥`,
`> æ¨¡å¼ï¼š${mode}`,
``,
`## System Prompt`,
sys.trim(),
``,
`## Analysis Prompt`,
ana.trim(),
``,
`## Task Prompt`,
task.trim(),
``,
`## Data Payload (JSON)`,
"```json",
JSON.stringify(reduced, null, 2),
"```",
``,
`## Output format requirement`,
`- Nowï¼šä½ å»ºè®®æˆ‘ç°åœ¨åšä»€ä¹ˆï¼ˆ1-3æ¡ï¼Œä½ç»´æŠ¤ï¼Œä¸è¦æ±‚ç›¯ç›˜ï¼‰`,
`- Next7dï¼šæœªæ¥7å¤©æˆ‘ç•™æ„ä»€ä¹ˆï¼ˆ1-3æ¡ï¼‰`,
`- Avoidï¼šæˆ‘ç°åœ¨ä¸è¦åšä»€ä¹ˆï¼ˆ1-3æ¡ï¼‰`,
`- å¯é€‰ç»†èŠ‚ï¼šè§¦å‘æ¡ä»¶/ç½®ä¿¡åº¦/é£é™©ç‚¹ï¼ˆå¦‚æœéœ€è¦ï¼‰`
  ].join("\n");

  return { md, reduced };
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch{
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    return true;
  }
}

$("btnCompose").addEventListener("click", async ()=>{
  const { md } = composeMarkdown();
  await copyToClipboard(md);
  alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼šç›´æ¥ç²˜è´´ç»™ä½ çš„AI/ChatGPTå³å¯ã€‚");
});

$("btnShowPayload").addEventListener("click", ()=>{
  const { reduced } = composeMarkdown();
  payloadBox.value = JSON.stringify(reduced, null, 2);
  openModal("modalPayload");
});
$("btnCopyPayload").addEventListener("click", async ()=>{
  await copyToClipboard(payloadBox.value || "");
  alert("å·²å¤åˆ¶JSON");
});

/* =========================
   Prompt modal binding
========================= */
function syncPromptModal(){
  const mode = $("taskMode").value;
  const p = loadPrompts();
  $("promptSystem").value = p.system || "";
  $("promptAnalysis").value = p.analysis || "";
  $("promptTask").value = p.tasks?.[mode] || "";
}
$("taskMode").addEventListener("change", ()=>{
  syncPromptModal();
});

$("btnPromptSave").addEventListener("click", ()=>{
  const mode = $("taskMode").value;
  const p = loadPrompts();
  p.system = $("promptSystem").value || "";
  p.analysis = $("promptAnalysis").value || "";
  p.tasks = p.tasks || {};
  p.tasks[mode] = $("promptTask").value || "";
  savePrompts(p);
  alert("Prompt å·²ä¿å­˜");
});
$("btnPromptReset").addEventListener("click", ()=>{
  if(!confirm("æ¢å¤é»˜è®¤ Promptï¼Ÿä¼šè¦†ç›–ä½ å½“å‰ Prompt é…ç½®ã€‚")) return;
  savePrompts(structuredClone(DEFAULT_PROMPTS));
  syncPromptModal();
  alert("å·²æ¢å¤é»˜è®¤");
});
$("btnPromptExport").addEventListener("click", ()=>{
  const p = loadPrompts();
  const blob = new Blob([JSON.stringify(p, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "neon_prompts.json";
  a.click();
});
$("promptImportFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const j = JSON.parse(txt);
    if(!j.system || !j.analysis || !j.tasks) throw new Error("æ ¼å¼ä¸å¯¹ï¼šéœ€è¦ system/analysis/tasks");
    savePrompts(j);
    syncPromptModal();
    alert("å¯¼å…¥æˆåŠŸ");
  }catch(err){
    alert("å¯¼å…¥å¤±è´¥ï¼š" + String(err));
  }finally{
    e.target.value="";
  }
});

/* =========================
   Keyword modal binding
========================= */
function renderKwGroupEditor(container, group, {isCustom=false}={}){
  const wrap = document.createElement("div");
  wrap.style.border = "1px solid var(--line)";
  wrap.style.borderRadius = "14px";
  wrap.style.padding = "10px";
  wrap.style.background = "rgba(7,7,10,.35)";
  wrap.style.marginBottom = "10px";

  wrap.innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div><span class="tag ${group.enabled?"good":"bad"}">${group.enabled?"å¯ç”¨":"ç¦ç”¨"}</span> <b>${escapeHtml(group.name)}</b></div>
      <div class="row">
        ${isCustom ? `<button class="btn small danger" data-kwdel="${escapeAttr(group.id)}">åˆ é™¤</button>` : ``}
        <button class="btn small secondary" data-kvtoggle="${escapeAttr(group.id)}">${group.enabled?"ç¦ç”¨":"å¯ç”¨"}</button>
      </div>
    </div>
    <div class="two" style="margin-top:10px;">
      <div>
        <div class="small">ä¸­æ–‡å…³é”®è¯ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</div>
        <textarea class="mono" data-kwzh="${escapeAttr(group.id)}">${(group.zh||[]).join("\n")}</textarea>
      </div>
      <div>
        <div class="small">è‹±æ–‡å…³é”®è¯ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</div>
        <textarea class="mono" data-kwen="${escapeAttr(group.id)}">${(group.en||[]).join("\n")}</textarea>
      </div>
    </div>
    <div class="two" style="margin-top:10px;">
      <div>
        <div class="small">æƒé‡(1-5)</div>
        <input type="number" min="1" max="5" data-kwweight="${escapeAttr(group.id)}" value="${Number(group.weight||3)}">
      </div>
      <div>
        <div class="small">ç»„å†…æ¡æ•°ä¸Šé™</div>
        <input type="number" min="1" max="8" data-kwmax="${escapeAttr(group.id)}" value="${Number(group.maxItems||2)}">
      </div>
    </div>
    ${isCustom ? `
      <div class="small" style="margin-top:10px;">ç»„åï¼ˆå¯æ”¹ï¼‰</div>
      <input data-kwname="${escapeAttr(group.id)}" value="${escapeAttr(group.name)}">
    ` : ``}
  `;
  container.appendChild(wrap);
}

function syncKeywordsModal(){
  const kw = loadKeywords();
  $("kwMaxItems").value = kw.settings?.totalMaxItems ?? 15;
  $("kwSites").value = (kw.settings?.sites || []).join(", ");

  const def = $("kwDefault");
  const cus = $("kwCustom");
  def.innerHTML = ""; cus.innerHTML = "";
  for(const g of kw.defaultGroups||[]) renderKwGroupEditor(def, g, {isCustom:false});
  for(const g of kw.customGroups||[]) renderKwGroupEditor(cus, g, {isCustom:true});

  // bind buttons inside
  $("modalKeywords").querySelectorAll("[data-kvtoggle]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-kvtoggle");
      const kw2 = loadKeywords();
      const g = (kw2.defaultGroups||[]).find(x=>x.id===id) || (kw2.customGroups||[]).find(x=>x.id===id);
      if(g){ g.enabled = !g.enabled; saveKeywords(kw2); syncKeywordsModal(); }
    });
  });
  $("modalKeywords").querySelectorAll("[data-kwdel]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-kwdel");
      const kw2 = loadKeywords();
      kw2.customGroups = (kw2.customGroups||[]).filter(x=>x.id!==id);
      saveKeywords(kw2);
      syncKeywordsModal();
    });
  });
}

function readKwEdits(){
  const kw = loadKeywords();
  const getLines = (v)=>String(v||"").split("\n").map(s=>s.trim()).filter(Boolean);

  const maxItems = clamp(Number($("kwMaxItems").value||15), 6, 30);
  const sites = $("kwSites").value.split(",").map(s=>s.trim()).filter(Boolean);

  kw.settings.totalMaxItems = maxItems;
  kw.settings.sites = sites;

  const applyToGroup = (g)=>{
    const zhEl = document.querySelector(`[data-kwzh="${cssEsc(g.id)}"]`);
    const enEl = document.querySelector(`[data-kwen="${cssEsc(g.id)}"]`);
    const wEl  = document.querySelector(`[data-kwweight="${cssEsc(g.id)}"]`);
    const mEl  = document.querySelector(`[data-kwmax="${cssEsc(g.id)}"]`);
    const nEl  = document.querySelector(`[data-kwname="${cssEsc(g.id)}"]`);
    if(zhEl) g.zh = getLines(zhEl.value);
    if(enEl) g.en = getLines(enEl.value);
    if(wEl) g.weight = clamp(Number(wEl.value||3), 1, 5);
    if(mEl) g.maxItems = clamp(Number(mEl.value||2), 1, 8);
    if(nEl) g.name = String(nEl.value||g.name);
  };

  (kw.defaultGroups||[]).forEach(applyToGroup);
  (kw.customGroups||[]).forEach(applyToGroup);
  return kw;
}

$("btnKwSave").addEventListener("click", ()=>{
  const kw = readKwEdits();
  saveKeywords(kw);
  alert("å…³é”®è¯åº“å·²ä¿å­˜");
});
$("btnKwReset").addEventListener("click", ()=>{
  if(!confirm("æ¢å¤é»˜è®¤å…³é”®è¯åº“ï¼Ÿä¼šè¦†ç›–é»˜è®¤ç»„ä¸è‡ªå®šä¹‰ç»„ã€‚")) return;
  saveKeywords(structuredClone(DEFAULT_KW));
  syncKeywordsModal();
});
$("btnKwExport").addEventListener("click", ()=>{
  const kw = readKwEdits();
  const blob = new Blob([JSON.stringify(kw, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "neon_keywords.json";
  a.click();
});
$("kwImportFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const j = JSON.parse(txt);
    if(!j.settings || !j.defaultGroups || !j.customGroups) throw new Error("æ ¼å¼ä¸å¯¹ï¼šéœ€è¦ settings/defaultGroups/customGroups");
    saveKeywords(j);
    syncKeywordsModal();
    alert("å¯¼å…¥æˆåŠŸ");
  }catch(err){
    alert("å¯¼å…¥å¤±è´¥ï¼š" + String(err));
  }finally{ e.target.value=""; }
});

$("btnKwAddCustom").addEventListener("click", ()=>{
  const kw = loadKeywords();
  kw.customGroups = kw.customGroups || [];
  kw.customGroups.push({
    id: "c_" + Math.random().toString(16).slice(2),
    name: "è‡ªå®šä¹‰ä¸»é¢˜",
    enabled: true,
    weight: 3,
    maxItems: 2,
    zh: [],
    en: []
  });
  saveKeywords(kw);
  syncKeywordsModal();
});

function buildQueries(){
  const kw = readKwEdits();
  const sites = (kw.settings?.sites || []);
  const siteExpr = sites.length ? " (" + sites.map(s=>"site:"+s).join(" OR ") + ")" : "";
  const lines = [];
  const groups = [...(kw.defaultGroups||[]), ...(kw.customGroups||[])].filter(g=>g.enabled);
  // order by weight desc
  groups.sort((a,b)=>(b.weight||0)-(a.weight||0));
  for(const g of groups){
    lines.push(`## ${g.name}`);
    const zh = (g.zh||[]).slice(0,10);
    const en = (g.en||[]).slice(0,10);
    for(const q of zh){
      lines.push(`- ${q}${siteExpr}`);
    }
    for(const q of en){
      lines.push(`- ${q}${siteExpr}`);
    }
    lines.push("");
  }
  const txt = lines.join("\n").trim();
  $("kwQueries").value = txt;
  saveKeywords(kw); // persist edits
}

$("btnKwBuildQueries").addEventListener("click", ()=>{
  buildQueries();
  alert("å·²ç”Ÿæˆæœç´¢è¯­å¥ï¼ˆå¯å¤åˆ¶ï¼‰");
});

$("btnKwOpenTop").addEventListener("click", ()=>{
  buildQueries();
  const kw = loadKeywords();
  const groups = [...(kw.defaultGroups||[]), ...(kw.customGroups||[])].filter(g=>g.enabled);
  groups.sort((a,b)=>(b.weight||0)-(a.weight||0));
  const sites = (kw.settings?.sites || []);
  const siteExpr = sites.length ? " (" + sites.map(s=>"site:"+s).join(" OR ") + ")" : "";
  // open top 3 queries
  const qs = [];
  for(const g of groups.slice(0,2)){
    const q = (g.en?.[0] || g.zh?.[0] || "").trim();
    if(q) qs.push(q + siteExpr);
  }
  if(!qs.length){ alert("æ²¡æœ‰å¯æ‰“å¼€çš„å…³é”®è¯ï¼ˆè¯·å…ˆå¯ç”¨å¹¶å¡«å…¥å…³é”®è¯ï¼‰"); return; }
  for(const q of qs){
    const url = "https://www.google.com/search?q=" + encodeURIComponent(q);
    window.open(url, "_blank");
  }
});

/* =========================
   Floating buttons
========================= */
$("fabGuide").addEventListener("click", ()=>openModal("modalGuide"));
$("fabPrompt").addEventListener("click", ()=>{ syncPromptModal(); openModal("modalPrompt"); });
$("fabKeywords").addEventListener("click", ()=>{ syncKeywordsModal(); openModal("modalKeywords"); });

/* =========================
   Utils: html escaping
========================= */
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }
function cssEsc(s){ return String(s).replace(/"/g,'\\"'); }

/* =========================
   Boot
========================= */
initApiBase();
initNews();
renderSectorsManage();
renderSectorTable();
renderPositions();

// load tech cache if any
const techCache = loadJson(LS.techCache, null);
if(techCache?.items) renderTechTable(techCache.items);

// prompt init if missing
if(!localStorage.getItem(LS.prompt)) savePrompts(structuredClone(DEFAULT_PROMPTS));
if(!localStorage.getItem(LS.keywords)) saveKeywords(structuredClone(DEFAULT_KW));

// health check
$("btnHealth").addEventListener("click", checkHealth);
checkHealth();

</script>
</body>
</html>
