<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æŠ•èµ„å‰¯é©¾é©¶ v1ï¼ˆä¸“ä¸šç‰ˆï¼‰</title>
  <style>
    :root{--bg:#0b1220;--card:#0f1a33;--line:#1f2a44;--txt:#e6edf7;--mut:#9fb0d0;--ok:#30d158;--bad:#ff453a;--btn:#2f6bff;}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
    header{padding:14px 16px;background:#061027;border-bottom:1px solid var(--line);font-weight:700}
    .wrap{padding:14px;max-width:980px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
    h3{margin:0 0 10px;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,select,textarea{background:#07122b;color:var(--txt);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:15px;flex:1;min-width:140px}
    textarea{min-height:110px}
    button{background:var(--btn);border:none;color:#fff;border-radius:10px;padding:10px 12px;font-weight:700;font-size:15px}
    button.secondary{background:#13224a;border:1px solid var(--line);color:var(--txt)}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:center;vertical-align:top}
    .mut{color:var(--mut)}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--mut);font-size:12px}
  </style>
</head>
<body>
<header>ğŸ“ˆ æŠ•èµ„å‰¯é©¾é©¶ v1ï¼ˆä¸“ä¸šç‰ˆï¼‰</header>
<div class="wrap">

  <div class="card">
    <h3>â‘  åç«¯åœ°å€ï¼ˆå·²é»˜è®¤å¡«å¥½ï¼‰</h3>
    <div class="row">
      <input id="backend" placeholder="ä¾‹å¦‚ï¼šhttps://xxx.onrender.com" />
      <button class="secondary" onclick="saveBackend()">ä¿å­˜</button>
      <button class="secondary" onclick="ping()">æµ‹è¯•</button>
    </div>
    <div class="mut" id="pingResult" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <h3>â‘¡ æ·»åŠ æŒä»“</h3>
    <div class="row">
      <select id="type">
        <option value="CN_FUND">å›½å†…åŸºé‡‘ï¼ˆ6ä½ï¼‰</option>
        <option value="US_TICKER">æµ·å¤–æ ‡çš„ï¼ˆTickerï¼‰</option>
      </select>
      <input id="code" placeholder="åŸºé‡‘ä»£ç /Tickerï¼š025167 / SPY" />
      <input id="amount" type="number" placeholder="æŒæœ‰é‡‘é¢ï¼ˆå…ƒæˆ–ç¾å…ƒéƒ½å¯ï¼‰" />
      <input id="cost" type="number" placeholder="æˆæœ¬å‡€å€¼/æˆæœ¬ä»·ï¼ˆå¯é€‰ï¼‰" />
      <button onclick="add()">æ·»åŠ </button>
    </div>

    <div class="row" style="margin-top:10px;">
      <button onclick="refreshAll()">ğŸ”„ åˆ·æ–°çœŸå®ä»·æ ¼å¹¶è®¡ç®—ç›ˆäº</button>
      <button class="secondary" onclick="clearAll()">æ¸…ç©º</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ç±»å‹</th><th>ä»£ç </th><th>åç§°</th><th>ç°ä»·</th><th>å¸‚å€¼</th><th>ç›ˆäº</th><th>ç›ˆäºç‡</th><th>ä»“ä½</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
    <div class="mut" id="sum" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3>â‘¢ AI å†³ç­–ï¼ˆOpenAI-compatible æ–¹å¼ï¼‰</h3>
    <div class="row">
      <input id="aiBase" placeholder="AI BaseUrlï¼Œä¾‹å¦‚ï¼šhttps://api.openai.com/v1 æˆ–ä½ çš„ç½‘å…³" />
      <input id="aiKey" placeholder="API Keyï¼ˆä»…ä¿å­˜åœ¨æœ¬æœºï¼‰" />
      <input id="aiModel" placeholder="æ¨¡å‹åï¼Œä¾‹å¦‚ï¼šgpt-5-mini / grok-xxx / gemini-xxx" />
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="secondary" onclick="saveAI()">ä¿å­˜AIé…ç½®</button>
      <button onclick="runAI()">ğŸ¤– ç”Ÿæˆä»Šæ—¥åŠ¨ä½œ + 3-6ä¸ªæœˆæ¿å—æ¨è</button>
    </div>
    <textarea id="aiOut" placeholder="AI è¾“å‡ºä¼šåœ¨è¿™é‡Œ..."></textarea>
    <div class="mut">æç¤ºï¼šAI Key ä¸å†™è¿›ä»£ç ï¼›åªå­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ã€‚</div>
  </div>

</div>

<script>
  const LS = { backend:"ic_backend", pos:"ic_positions", ai:"ic_ai" };
  const $ = (id)=>document.getElementById(id);

  function load() {
    // é»˜è®¤å¡«ä½ çš„åç«¯åœ°å€
    const defaultBackend = "https://invest-copilot-backend.onrender.com";
    const b = localStorage.getItem(LS.backend) || defaultBackend;
    $("backend").value = b;
    localStorage.setItem(LS.backend, b);

    window.positions = JSON.parse(localStorage.getItem(LS.pos) || "[]");
    const ai = JSON.parse(localStorage.getItem(LS.ai) || "{}");
    $("aiBase").value = ai.baseUrl || "";
    $("aiKey").value  = ai.apiKey || "";
    $("aiModel").value= ai.model || "";
    render();
  }

  function saveBackend(){
    localStorage.setItem(LS.backend, $("backend").value.trim());
    $("pingResult").textContent = "å·²ä¿å­˜ã€‚";
  }

  async function ping(){
    const base = $("backend").value.trim();
    if(!base) return alert("å…ˆå¡«å†™åç«¯åœ°å€");
    try{
      const r = await fetch(base.replace(/\/+$/,"") + "/health");
      const j = await r.json();
      $("pingResult").textContent = j.ok ? "âœ… åç«¯æœåŠ¡æ­£å¸¸" : "âš ï¸ åç«¯å¼‚å¸¸";
    }catch(e){
      $("pingResult").textContent = "âŒ è¿æ¥å¤±è´¥ï¼š" + e.message;
    }
  }

  function add(){
    const type = $("type").value;
    const code = $("code").value.trim();
    const amount = Number($("amount").value);
    const cost = $("cost").value ? Number($("cost").value) : null;
    if(!code || !amount) return alert("è¯·å¡«ä»£ç  + é‡‘é¢");

    window.positions.push({
      type, code, amount, cost,
      name:"",
      price:null, mv:null, pnl:null, pnlPct:null,
      // å›½å†…åŸºé‡‘é™„åŠ å­—æ®µï¼ˆç”¨äºå±•ç¤ºï¼‰
      _nav:null, _navDate:null, _estNav:null, _estPct:null, _time:null
    });
    persist(); render();
  }

  function clearAll(){
    if(!confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æŒä»“ï¼Ÿ")) return;
    window.positions = [];
    persist(); render();
  }

  function persist(){ localStorage.setItem(LS.pos, JSON.stringify(window.positions)); }

  function render(){
    const tb = $("tb"); tb.innerHTML = "";

    const totalAmount = window.positions.reduce((s,p)=>s + (p.amount||0), 0);
    const totalMV = window.positions.reduce((s,p)=>s + (p.mv||0), 0);
    const totalPNL = window.positions.reduce((s,p)=>s + (p.pnl||0), 0);

    window.positions.forEach(p=>{
      const tr = document.createElement("tr");
      const pnlCls = (p.pnlPct ?? 0) >= 0 ? "ok" : "bad";
      const w = totalMV ? (p.mv||0)/totalMV*100 : 0;

      const priceCell = (p.type === "CN_FUND")
        ? `
          ${p.price ?? "-"}
          <div class="mut" style="font-size:12px; margin-top:2px; line-height:1.25;">
            å‡€å€¼: ${(typeof p._nav === "number" ? p._nav : "-")}ï¼ˆ${p._navDate || "-"}ï¼‰
            <br/>
            ä¼°å€¼: ${(typeof p._estNav === "number" ? p._estNav : "-")}ï¼ˆ${(typeof p._estPct === "number" ? p._estPct : "-")}%ï¼‰${p._time ? " " + p._time : ""}
          </div>
        `
        : `${p.price ?? "-"}`;

      tr.innerHTML = `
        <td><span class="pill">${p.type}</span></td>
        <td>${p.code}</td>
        <td class="mut">${p.name || "-"}</td>
        <td>${priceCell}</td>
        <td>${p.mv!=null ? p.mv.toFixed(2) : "-"}</td>
        <td class="${pnlCls}">${p.pnl!=null ? p.pnl.toFixed(2) : "-"}</td>
        <td class="${pnlCls}">${p.pnlPct!=null ? p.pnlPct.toFixed(2)+"%" : "-"}</td>
        <td>${(w||0).toFixed(1)}%</td>
      `;
      tb.appendChild(tr);
    });

    $("sum").textContent =
      `æŠ•å…¥åˆè®¡ï¼š${totalAmount.toFixed(2)} ï½œ å¸‚å€¼åˆè®¡ï¼š${totalMV.toFixed(2)} ï½œ æ€»ç›ˆäºï¼š${totalPNL.toFixed(2)}`;
  }

  async function refreshAll(){
    const base = localStorage.getItem(LS.backend) || $("backend").value.trim();
    if(!base) return alert("å…ˆå¡«åç«¯åœ°å€");
    const api = base.replace(/\/+$/,"");

    // å›½å†…åŸºé‡‘ï¼šé€ä¸ªæ‹‰ï¼ˆå¯¹è´¦æ¨¡å¼ï¼šé»˜è®¤ç”¨å•ä½å‡€å€¼ navï¼‰
    for (const p of window.positions){
      if (p.type === "CN_FUND"){
        const r = await fetch(`${api}/api/cn/fund/${encodeURIComponent(p.code)}`);
        const j = await r.json();

        p.name = j.name || p.name;

        // âœ… å…³é”®ï¼šä¸»ç°ä»·ç”¨å•ä½å‡€å€¼ navï¼ˆä¸ä½ ç†è´¢è½¯ä»¶ä¸€è‡´ï¼‰ï¼Œè‹¥ nav æ— åˆ™é€€å› estNav
        p.price = (typeof j.nav === "number" && j.nav > 0) ? j.nav : j.estNav;

        // ä¿å­˜é™„åŠ å±•ç¤ºå­—æ®µ
        p._nav = (typeof j.nav === "number") ? j.nav : null;
        p._navDate = j.navDate || null;
        p._estNav = (typeof j.estNav === "number") ? j.estNav : null;
        p._estPct = (typeof j.estPct === "number") ? j.estPct : null;
        p._time = j.time || null;
      }
    }

    // æµ·å¤–ï¼šæ‰¹é‡æ‹‰
    const gl = window.positions.filter(p=>p.type==="US_TICKER");
    if (gl.length){
      const symbols = gl.map(p=>p.code).join(",");
      const r = await fetch(`${api}/api/gl/quote?symbols=${encodeURIComponent(symbols)}`);
      const j = await r.json();
      const map = new Map((j.quotes||[]).map(q=>[q.symbol, q]));
      for (const p of gl){
        const q = map.get(p.code);
        if(q){
          p.name = q.name || p.name;
          p.price = q.price;
        }
      }
    }

    // è®¡ç®—ï¼šå¸‚å€¼/ç›ˆäºï¼ˆç”¨é‡‘é¢ä¼°ç®—ä»½é¢ï¼‰
    for (const p of window.positions){
      if (typeof p.price === "number" && p.price > 0){
        const baseCost = (typeof p.cost === "number" && p.cost > 0) ? p.cost : p.price;
        const shares = p.amount / baseCost;
        p.mv = shares * p.price;
        p.pnl = p.mv - p.amount;
        p.pnlPct = (p.pnl / p.amount) * 100;
      } else {
        p.mv = p.pnl = p.pnlPct = null;
      }
    }

    persist(); render();
  }

  function saveAI(){
    const cfg = {
      baseUrl:$("aiBase").value.trim(),
      apiKey:$("aiKey").value.trim(),
      model:$("aiModel").value.trim()
    };
    localStorage.setItem(LS.ai, JSON.stringify(cfg));
    $("aiOut").value = "âœ… AI é…ç½®å·²ä¿å­˜ï¼ˆä»…æœ¬æœºï¼‰ã€‚";
  }

  async function runAI(){
    const base = localStorage.getItem(LS.backend) || $("backend").value.trim();
    if(!base) return alert("å…ˆå¡«åç«¯åœ°å€");
    const api = base.replace(/\/+$/,"");

    const cfg = JSON.parse(localStorage.getItem(LS.ai) || "{}");
    if(!cfg.baseUrl || !cfg.apiKey || !cfg.model) return alert("å…ˆå¡«å†™ AI BaseUrl / Key / Model å¹¶ä¿å­˜");

    const payload = window.positions.map(p=>({
      type:p.type, code:p.code, name:p.name, amount:p.amount, cost:p.cost,
      price:p.price, mv:p.mv, pnl:p.pnl, pnlPct:p.pnlPct,
      nav:p._nav, navDate:p._navDate, estNav:p._estNav, estPct:p._estPct, time:p._time
    }));

    const messages = [
      { role:"system", content:"ä½ æ˜¯ä¸¥æ ¼çš„ç»„åˆé£æ§ä¸æ“ä½œå»ºè®®åŠ©æ‰‹ã€‚ä¸è¦ç¼–é€ æ•°æ®ã€‚å¿…é¡»è¾“å‡ºï¼šæ¯åªæ ‡çš„ ä»Šæ—¥åŠ¨ä½œï¼ˆä¹°/å–/ä¸åŠ¨ï¼‰+ä¸€å¥ç†ç”±ï¼›ç»„åˆé£é™©ç­‰çº§ï¼ˆä½/ä¸­/é«˜ï¼‰+æ€»ä»“ä½å»ºè®®ï¼›æœªæ¥3-6ä¸ªæœˆæœ€çœ‹å¥½æ¿å—Top1 + æ¨èåŸºé‡‘/ETFä»£ç  + åŸå› ã€‚"},
      { role:"user", content:`æˆ‘çš„æŒä»“ä¸ä»·æ ¼/ç›ˆäºï¼ˆJSONï¼‰ï¼š\n${JSON.stringify(payload, null, 2)}\n\næŒ‰è¦æ±‚è¾“å‡ºï¼Œæ ¼å¼æ¸…æ™°ã€‚` }
    ];

    $("aiOut").value = "ç”Ÿæˆä¸­â€¦";

    const r = await fetch(`${api}/api/ai/chat`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ baseUrl: cfg.baseUrl, apiKey: cfg.apiKey, model: cfg.model, messages })
    });

    const text = await r.text();
    try{
      const j = JSON.parse(text);
      $("aiOut").value = j?.choices?.[0]?.message?.content || text;
    }catch{
      $("aiOut").value = text;
    }
  }

  load();
</script>
</body>
</html>
