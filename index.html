<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NEON QUANT // éœ“è™¹æŠ•ç ”èˆ± v1</title>
  <style>
    :root{--bg:#0b1220;--card:#0f1a33;--line:#1f2a44;--txt:#e6edf7;--mut:#9fb0d0;--ok:#30d158;--bad:#ff453a;--btn:#2f6bff;}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
    header{padding:14px 16px;background:#061027;border-bottom:1px solid var(--line);font-weight:700}
    .wrap{padding:14px;max-width:1100px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
    h3{margin:0 0 10px;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,textarea{background:#07122b;color:var(--txt);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:15px;flex:1;min-width:140px}
    textarea{min-height:110px}
    button{background:var(--btn);border:none;color:#fff;border-radius:10px;padding:10px 12px;font-weight:700;font-size:14px;cursor:pointer}
    button.secondary{background:#13224a;border:1px solid var(--line);color:var(--txt)}
    button.danger{background:#3a1020;border:1px solid #6a2233}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:center;vertical-align:top}
    .mut{color:var(--mut)}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--mut);font-size:12px}
    .small{font-size:12px;line-height:1.25}
    .split{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:300px}
    .box{border:1px solid var(--line);border-radius:12px;background:#0a1430;padding:10px}
    .list{margin-top:10px}
    .li{padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:8px;background:#0a1430}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);margin-right:6px}
    .tagUp{color:var(--ok);border-color:rgba(48,209,88,.35)}
    .tagDown{color:var(--bad);border-color:rgba(255,69,58,.35)}
    .tagNeu{color:var(--mut)}
    .tagBull{color:var(--ok);border-color:rgba(48,209,88,.35)}
    .tagBear{color:var(--bad);border-color:rgba(255,69,58,.35)}
    .tagTheme{color:#c7dfff;border-color:rgba(199,215,255,.25)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    details summary{cursor:pointer;color:#c7dfff}
    .scroll{max-height:420px;overflow:auto;padding-right:6px}
    .sep{height:1px;background:var(--line);margin:10px 0}
    a{color:#bcd1ff;text-decoration:none}
    a:hover{text-decoration:underline}

    /* Modal */
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:99}
    .modal{width:min(820px,100%);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .modal h4{margin:0 0 10px}
    .modal .row{margin-top:10px}
    .modal .footer{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
  </style>
</head>
<body>
<header>ğŸ“ˆ NEON QUANT // éœ“è™¹æŠ•ç ”èˆ± v1</header>
<div class="wrap">

  <div class="card">
    <h3>â‘  åç«¯åœ°å€ï¼ˆå·²é»˜è®¤å¡«å¥½ï¼‰</h3>
    <div class="row">
      <input id="backend" placeholder="ä¾‹å¦‚ï¼šhttps://xxx.onrender.com" />
      <button class="secondary" onclick="saveBackend()">ä¿å­˜</button>
      <button class="secondary" onclick="ping()">æµ‹è¯•</button>
    </div>
    <div class="mut" id="pingResult" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <h3>â‘¡ æ·»åŠ æŒä»“</h3>
    <div class="row">
      <select id="type">
        <option value="CN_FUND">å›½å†…åŸºé‡‘ï¼ˆ6ä½ï¼‰</option>
        <option value="US_TICKER">æµ·å¤–æ ‡çš„ï¼ˆTickerï¼‰</option>
      </select>
      <input id="code" placeholder="åŸºé‡‘ä»£ç /Tickerï¼š025167 / SPY" />
      <input id="amount" type="number" placeholder="æŒæœ‰é‡‘é¢ï¼ˆå…ƒæˆ–ç¾å…ƒï¼‰" />
      <input id="cost" type="number" placeholder="æˆæœ¬å‡€å€¼/æˆæœ¬ä»·ï¼ˆå¯é€‰ï¼‰" />
      <button onclick="add()">æ·»åŠ </button>
    </div>

    <div class="row" style="margin-top:10px;">
      <button onclick="refreshAll()">ğŸ”„ åˆ·æ–°çœŸå®ä»·æ ¼å¹¶è®¡ç®—ç›ˆäº</button>
      <button class="secondary" onclick="clearAll()">æ¸…ç©º</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ç±»å‹</th><th>ä»£ç </th><th>åç§°</th><th>ç°ä»·</th><th>å¸‚å€¼</th><th>ç›ˆäº</th><th>ç›ˆäºç‡</th><th>ä»“ä½</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>

    <div class="mut" id="sum" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3>â‘¢ æ–°é—»ä¸æ”¿ç­–ï¼ˆè‡ªåŠ¨éšæŒä»“å˜åŒ–ï¼‰</h3>
    <div class="split">
      <div class="col">
        <div class="row">
          <button class="secondary" onclick="buildNewsPlan()">ğŸ§  è‡ªåŠ¨ç”Ÿæˆå…³é”®è¯</button>
          <button onclick="fetchNews()">ğŸ— æŠ“å–æ–°é—»</button>
        </div>
        <div class="mut small" style="margin-top:8px;">
          å·²å¯ç”¨ï¼šæŒ‰æƒé‡åˆ†é…é…é¢ + ç›¸å…³åº¦è¯„åˆ†è¿‡æ»¤ï¼ˆminScore=2ï¼‰ã€‚
        </div>

        <div style="margin-top:10px;">
          <div class="mut">å½“å‰ä¸»é¢˜ï¼ˆè‡ªåŠ¨ï¼‰ï¼š</div>
          <div id="themes" class="small"></div>
        </div>

        <div style="margin-top:10px;">
          <div class="mut">å…³é”®è¯æ± ï¼ˆå¯æ‰‹åŠ¨å¢åˆ ï¼Œç”¨é€—å·åˆ†éš”ï¼‰ï¼š</div>
          <input id="newsKeywords" placeholder="ä¾‹å¦‚ï¼šç¾è”å‚¨,é™æ¯,æ’ç”Ÿç§‘æŠ€,ç§‘åˆ›50,è¶Šå—è‚¡å¸‚..." />
          <div class="row" style="margin-top:8px;">
            <button class="secondary" onclick="saveNewsKeywords()">ä¿å­˜å…³é”®è¯</button>
            <button class="secondary" onclick="resetNewsKeywords()">é‡ç½®ä¸ºè‡ªåŠ¨å…³é”®è¯</button>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="mut">æ–°é—»åˆ—è¡¨ï¼ˆæœ€è¿‘ï¼‰ï¼š</div>
        <details open style="margin-top:8px;">
          <summary>ç‚¹å‡»æŠ˜å /å±•å¼€ï¼ˆåˆ—è¡¨å¯æ»šåŠ¨ï¼‰</summary>
          <div id="newsList" class="scroll" style="margin-top:8px;"></div>
        </details>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>â‘£ AI å†³ç­–ï¼ˆOpenAI-compatible æ–¹å¼ï¼‰</h3>
    <div class="row">
      <input id="aiBase" placeholder="AI BaseUrlï¼Œä¾‹å¦‚ï¼šhttps://api.openai.com/v1 æˆ–ä½ çš„ç½‘å…³" />
      <input id="aiKey" placeholder="API Keyï¼ˆä»…ä¿å­˜åœ¨æœ¬æœºï¼‰" />
      <input id="aiModel" placeholder="æ¨¡å‹åï¼Œä¾‹å¦‚ï¼šgpt-5-mini / grok-3 / gemini-xxx" />
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="secondary" onclick="saveAI()">ä¿å­˜AIé…ç½®</button>
      <button onclick="runAI()">ğŸ¤– ä»Šæ—¥åŠ¨ä½œ + 3-6ä¸ªæœˆæ¿å—å»ºè®®ï¼ˆå«æŠ€æœ¯/é£æ§/æ–°é—»ï¼‰</button>
    </div>
    <textarea id="aiOut" placeholder="AI è¾“å‡ºä¼šåœ¨è¿™é‡Œ..."></textarea>
    <div class="mut small">æç¤ºï¼šAI Key ä¸å†™è¿›ä»£ç ï¼›åªå­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ã€‚</div>
  </div>

  <div class="card">
    <h3>â‘¤ é£æ§æ£€æŸ¥ï¼ˆç»„åˆçº¢é»„ç¯ï¼‰</h3>
    <div class="row">
      <button onclick="refreshRisk()">ğŸ›¡ åˆ·æ–°é£æ§æ£€æŸ¥</button>
    </div>

    <div class="split" style="margin-top:10px;">
      <div class="col box">
        <div class="mut small">é£é™©ç­‰çº§</div>
        <div id="riskLevel" style="font-size:22px;font-weight:800;margin-top:6px;">-</div>
      </div>
      <div class="col box">
        <div class="mut small">å»ºè®®æ€»ä»“ä½</div>
        <div id="riskSuggest" style="font-size:22px;font-weight:800;margin-top:6px;">-</div>
      </div>
      <div class="col box">
        <div class="mut small">ä¸»é¢˜é›†ä¸­åº¦ Top1</div>
        <div id="riskTheme" style="font-size:22px;font-weight:800;margin-top:6px;">-</div>
      </div>
      <div class="col box">
        <div class="mut small">åç«¯æ—¶åŒº</div>
        <div id="riskTz" style="font-size:22px;font-weight:800;margin-top:6px;">-</div>
      </div>
    </div>

    <div class="list" id="riskIssues"></div>
    <details style="margin-top:10px;">
      <summary>ä¸»é¢˜åˆ†å¸ƒï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
      <div id="riskBreakdown" class="list"></div>
    </details>
  </div>

  <div class="card">
    <h3>â‘¥ æŠ€æœ¯æŒ‡æ ‡ / è¶‹åŠ¿ï¼ˆæ¯åªæŒä»“ï¼‰</h3>
    <div class="row">
      <button onclick="refreshTech()">ğŸ“Š åˆ·æ–°æŠ€æœ¯æŒ‡æ ‡</button>
      <button class="secondary" onclick="clearTechCache()">æ¸…ç©ºæŠ€æœ¯ç¼“å­˜</button>
    </div>
    <div class="mut small" style="margin-top:8px;">
      å›½å†…åŸºé‡‘ï¼šç”¨ä¸œè´¢å†å²å‡€å€¼åºåˆ—è®¡ç®—ï¼›æµ·å¤–Tickerï¼šç”¨ stooq å†å²æ—¥çº¿ï¼ˆè‡ªåŠ¨è¡¥ .usï¼‰ã€‚
      æ³¨æ„ï¼šæŠ€æœ¯æŒ‡æ ‡åªæ˜¯æ•°å­¦è®¡ç®—ç»“æœï¼Œä¸ç­‰äºæ”¶ç›Šä¿è¯ã€‚
    </div>
    <div id="techList" class="list"></div>
  </div>

  <div class="card">
    <h3>â‘¦ æ¿å—åŠ¨å‘ï¼ˆå…¨æ¿å—ï¼šè¶‹åŠ¿ + åŠ¨é‡ + RSIï¼Œä¸€çœ¼çœ‹æ‡‚ï¼‰</h3>
    <div class="row">
      <button onclick="refreshSectors()">ğŸ§­ åˆ·æ–°æ¿å—åŠ¨å‘</button>
      <button class="secondary" onclick="clearSectorCache()">æ¸…ç©ºæ¿å—ç¼“å­˜</button>
      <input id="sectorSearch" placeholder="æœç´¢æ¿å—/ETFï¼Œä¾‹å¦‚ï¼šé»„é‡‘ / åŒ»ç–— / åŠå¯¼ä½“ / å°åº¦..." oninput="renderSectors()" />
    </div>
    <div class="mut small" id="sectorStatus" style="margin-top:8px;"></div>
    <div class="mut small" style="margin-top:8px;">
      è¯´æ˜ï¼šè¿™é‡Œä¸æ˜¯é¢„æµ‹ï¼Œåªæ˜¯æŠŠä»£è¡¨æ€§ETFçš„è¶‹åŠ¿/åŠ¨é‡/RSIç®—å‡ºæ¥ï¼Œå¸®ä½ å¿«é€Ÿå‘ç°â€œçƒ­/å†·/ä¸Šè¡Œ/ä¸‹è¡Œâ€ã€‚
    </div>

    <details open style="margin-top:10px;">
      <summary>Topï¼ˆå»ºè®®ä½ ä¼˜å…ˆå…³æ³¨çš„æ¿å—ï¼‰</summary>
      <div id="sectorTop" class="list"></div>
    </details>

    <details style="margin-top:10px;">
      <summary>å…¨éƒ¨æ¿å—åˆ—è¡¨ï¼ˆç‚¹å‡»å±•å¼€ï¼›é‡Œé¢å¯æ»šåŠ¨ï¼‰</summary>
      <div id="sectorAll" class="scroll" style="margin-top:8px;"></div>
    </details>
  </div>

</div>

<!-- Modal -->
<div id="mask" class="modalMask" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h4>ç¼–è¾‘æŒä»“</h4>
    <div class="row">
      <select id="mType">
        <option value="CN_FUND">å›½å†…åŸºé‡‘ï¼ˆ6ä½ï¼‰</option>
        <option value="US_TICKER">æµ·å¤–æ ‡çš„ï¼ˆTickerï¼‰</option>
      </select>
      <input id="mCode" placeholder="ä»£ç " />
    </div>
    <div class="row">
      <input id="mAmount" type="number" placeholder="æŒæœ‰é‡‘é¢" />
      <input id="mCost" type="number" placeholder="æˆæœ¬å‡€å€¼/æˆæœ¬ä»·ï¼ˆå¯é€‰ï¼‰" />
    </div>
    <div class="mut small" id="mHint" style="margin-top:8px;"></div>
    <div class="footer">
      <button class="secondary" onclick="closeModal()">å–æ¶ˆ</button>
      <button onclick="saveModal()">ä¿å­˜ä¿®æ”¹</button>
    </div>
  </div>
</div>

<script>
  const LS = {
    backend:"ic_backend",
    pos:"ic_positions",
    ai:"ic_ai",
    newsKeywords:"ic_news_keywords",
    newsPlan:"ic_news_plan",
    newsCache:"ic_news_cache",
    techCache:"ic_tech_cache",
    riskCache:"ic_risk_cache",
    sectorCache:"ic_sector_cache",
  };
  const $ = (id)=>document.getElementById(id);

  // âœ… ä½ åç«¯åŸŸåï¼šå·²é»˜è®¤å†™æ­»
  const DEFAULT_BACKEND = "https://invest-copilot-backend.onrender.com";
  // âœ… UI æœ¬åœ°ç¼“å­˜ TTLï¼ˆ6å°æ—¶ï¼‰
  const UI_CACHE_TTL_MS = 6 * 60 * 60 * 1000;

  // ---------- æ ‡ç­¾æ¨å¯¼ï¼ˆé¿å…å‡ºç° undefinedï¼‰ ----------
  function deriveTrend(obj){
    const sma20 = obj?.sma20, sma60 = obj?.sma60, last = obj?.last;
    if (typeof sma20 === "number" && typeof sma60 === "number") {
      if (sma20 > sma60 * 1.001) return "ä¸Šè¡Œ";
      if (sma20 < sma60 * 0.999) return "ä¸‹è¡Œ";
      return "éœ‡è¡";
    }
    // å…œåº•ï¼šç”¨ last vs sma20
    if (typeof last === "number" && typeof sma20 === "number") {
      if (last > sma20 * 1.002) return "ä¸Šè¡Œ";
      if (last < sma20 * 0.998) return "ä¸‹è¡Œ";
      return "éœ‡è¡";
    }
    return null;
  }
  function deriveRsiTag(obj){
    const rsi = obj?.rsi14;
    if (typeof rsi !== "number") return null;
    if (rsi >= 70) return "RSIåçƒ­";
    if (rsi <= 30) return "RSIåå†·";
    return "RSIä¸­æ€§";
  }
  function tagHtml(text, cls){
    if (!text) return "";
    return `<span class="tag ${cls}">${text}</span>`;
  }


  // âœ… æ¿å—åˆ—è¡¨ï¼šä½ è¦åŠ â€œç…¤ç‚­/å†›å·¥/AI/æœºå™¨äºº/ä¸­å›½äº’è”ç½‘/å°åº¦â€ç­‰ï¼Œç›´æ¥å¾€è¿™é‡ŒåŠ 
  // ä½ è¯´ä½ è‡ªå·±ä¼šå¡« ETF symbolï¼Œæˆ‘å°±ç»™ä½ ç»“æ„ï¼Œåˆ«è®©æˆ‘å»æœ tickerã€‚
  const SECTOR_ETFS = [
    { theme:"å…¨çƒæˆé•¿&ç¾è‚¡", symbol:"QQQ", name:"çº³æŒ‡100" },
    { theme:"å…¨çƒæˆé•¿&ç¾è‚¡", symbol:"SPY", name:"æ ‡æ™®500" },
    { theme:"ç§‘æŠ€", symbol:"XLK", name:"ç¾è‚¡ç§‘æŠ€" },
    { theme:"åŠå¯¼ä½“", symbol:"SMH", name:"åŠå¯¼ä½“" },
    { theme:"é‡‘è/é“¶è¡Œ", symbol:"XLF", name:"é‡‘è" },
    { theme:"åŒ»ç–—", symbol:"XLV", name:"åŒ»ç–—" },
    { theme:"èƒ½æº/çŸ³æ²¹", symbol:"XLE", name:"èƒ½æº" },
    { theme:"å·¥ä¸š", symbol:"XLI", name:"å·¥ä¸š" },
    { theme:"å…¬ç”¨äº‹ä¸š", symbol:"XLU", name:"å…¬ç”¨äº‹ä¸š" },
    { theme:"ææ–™", symbol:"XLB", name:"ææ–™" },
    { theme:"æ¶ˆè´¹(å¯é€‰)", symbol:"XLY", name:"å¯é€‰æ¶ˆè´¹" },
    { theme:"æ¶ˆè´¹(å¿…é€‰)", symbol:"XLP", name:"å¿…é€‰æ¶ˆè´¹" },
    { theme:"åœ°äº§", symbol:"XLRE", name:"æˆ¿åœ°äº§" },
    { theme:"é»„é‡‘", symbol:"GLD", name:"é»„é‡‘" },
    { theme:"ç™½é“¶", symbol:"SLV", name:"ç™½é“¶" },
    { theme:"é‡‘çŸ¿", symbol:"GDX", name:"é‡‘çŸ¿" },
    { theme:"æ–°èƒ½æº(ç¾è‚¡)", symbol:"ICLN", name:"æ¸…æ´èƒ½æº" },
    { theme:"å…‰ä¼(ç¾è‚¡)", symbol:"TAN", name:"å…‰ä¼" },

    // ğŸ‘‡ ä½ æƒ³è¦çš„ï¼šç…¤ç‚­/å†›å·¥/AI/æœºå™¨äºº/ä¸­å›½äº’è”ç½‘/å°åº¦
    // ä½ è‡ªå·±å¡« symbol å³å¯ï¼ˆæˆ‘å…ˆæ”¾å ä½ï¼‰
    { theme:"å†›å·¥", symbol:"ITA", name:"èˆªç©ºèˆªå¤©/å†›å·¥ï¼ˆç¤ºä¾‹ï¼‰" },
    { theme:"èˆªå¤©/å«æ˜Ÿ", symbol:"UFO", name:"èˆªå¤©/å«æ˜Ÿï¼ˆç¤ºä¾‹ï¼‰" },
    // { theme:"ç…¤ç‚­", symbol:"XXXX", name:"ç…¤ç‚­" },
    // { theme:"AI", symbol:"XXXX", name:"AI" },
    // { theme:"æœºå™¨äºº", symbol:"XXXX", name:"æœºå™¨äºº" },
    // { theme:"ä¸­å›½äº’è”ç½‘", symbol:"XXXX", name:"ä¸­å›½äº’è”ç½‘" },
    // { theme:"å°åº¦", symbol:"XXXX", name:"å°åº¦" },

    { theme:"æ–°å…´å¸‚åœº", symbol:"EEM", name:"æ–°å…´å¸‚åœº" },
    { theme:"è¶Šå—", symbol:"VNM", name:"è¶Šå—" },
  ];

  let editingIndex = -1;
  let sectorData = null;

  function load() {
    const b = localStorage.getItem(LS.backend) || DEFAULT_BACKEND;
    $("backend").value = b;
    localStorage.setItem(LS.backend, b);

    window.positions = JSON.parse(localStorage.getItem(LS.pos) || "[]");

    const ai = JSON.parse(localStorage.getItem(LS.ai) || "{}");
    $("aiBase").value = ai.baseUrl || "";
    $("aiKey").value  = ai.apiKey || "";
    $("aiModel").value= ai.model || "";

    const kw = localStorage.getItem(LS.newsKeywords) || "";
    if (kw) $("newsKeywords").value = kw;

    const plan = JSON.parse(localStorage.getItem(LS.newsPlan) || "null");
    if (plan) renderThemes(plan.themes || []);
    const cache = JSON.parse(localStorage.getItem(LS.newsCache) || "null");
    if (cache) renderNews(cache.items || []);

    const risk = JSON.parse(localStorage.getItem(LS.riskCache) || "null");
    if (risk) renderRisk(risk);

    const tech = JSON.parse(localStorage.getItem(LS.techCache) || "null");
    if (tech) renderTech(tech);

    const sec = JSON.parse(localStorage.getItem(LS.sectorCache) || "null");
    if (sec) { sectorData = sec; renderSectors(); }

    render();
  }

  function persist(){ localStorage.setItem(LS.pos, JSON.stringify(window.positions)); }

  function saveBackend(){
    localStorage.setItem(LS.backend, $("backend").value.trim());
    $("pingResult").textContent = "å·²ä¿å­˜ã€‚";
  }

  async function ping(){
    const base = $("backend").value.trim();
    if(!base) return alert("å…ˆå¡«å†™åç«¯åœ°å€");
    try{
      const r = await fetch(base.replace(/\/+$/,"") + "/health");
      const j = await r.json();
      $("pingResult").textContent = j.ok ? "âœ… åç«¯æœåŠ¡æ­£å¸¸" : "âš ï¸ åç«¯å¼‚å¸¸";
    }catch(e){
      $("pingResult").textContent = "âŒ è¿æ¥å¤±è´¥ï¼š" + e.message;
    }
  }

  function add(){
    const type = $("type").value;
    const code = $("code").value.trim();
    const amount = Number($("amount").value);
    const cost = $("cost").value ? Number($("cost").value) : null;
    if(!code || !amount) return alert("è¯·å¡«ä»£ç  + é‡‘é¢");

    window.positions.push({
      type, code, amount, cost,
      name:"",
      price:null, mv:null, pnl:null, pnlPct:null,
      _nav:null, _navDate:null, _estNav:null, _estPct:null, _time:null
    });
    persist(); render();
  }

  function clearAll(){
    if(!confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æŒä»“ï¼Ÿ")) return;
    window.positions = [];
    persist(); render();
  }

  function openEdit(i){
    editingIndex = i;
    const p = window.positions[i];
    $("mType").value = p.type;
    $("mCode").value = p.code;
    $("mAmount").value = p.amount ?? "";
    $("mCost").value = p.cost ?? "";
    $("mHint").textContent = `å½“å‰åç§°ï¼š${p.name || "æœªæ‹‰å–"}ï½œå½“å‰ç°ä»·ï¼š${p.price ?? "æœªæ‹‰å–"}ï½œç›ˆäºç‡ï¼š${p.pnlPct!=null ? p.pnlPct.toFixed(2)+"%" : "æœªè®¡ç®—"}`;
    $("mask").style.display = "flex";
  }

  function closeModal(e){
    if (e && e.target && e.target.id !== "mask") return;
    $("mask").style.display = "none";
    editingIndex = -1;
  }

  function saveModal(){
    if (editingIndex < 0) return;
    const p = window.positions[editingIndex];

    const type = $("mType").value;
    const code = $("mCode").value.trim();
    const amount = Number($("mAmount").value);
    const cost = $("mCost").value ? Number($("mCost").value) : null;
    if(!code || !amount) return alert("è¯·å¡«ä»£ç  + é‡‘é¢");

    p.type = type;
    p.code = code;
    p.amount = amount;
    p.cost = cost;

    p.name = "";
    p.price = p.mv = p.pnl = p.pnlPct = null;
    p._nav = p._navDate = p._estNav = p._estPct = p._time = null;

    persist(); render();
    closeModal();
  }

  function deleteOne(i){
    const p = window.positions[i];
    if(!confirm(`ç¡®å®šåˆ é™¤ï¼š${p.code} ${p.name || ""} ?`)) return;
    window.positions.splice(i,1);
    persist(); render();
  }

  function render(){
    const tb = $("tb"); tb.innerHTML = "";
    const totalAmount = window.positions.reduce((s,p)=>s + (p.amount||0), 0);
    const totalMV = window.positions.reduce((s,p)=>s + (p.mv||0), 0);
    const totalPNL = window.positions.reduce((s,p)=>s + (p.pnl||0), 0);

    window.positions.forEach((p,i)=>{
      const tr = document.createElement("tr");
      const pnlCls = (p.pnlPct ?? 0) >= 0 ? "ok" : "bad";
      const w = totalMV ? (p.mv||0)/totalMV*100 : 0;

      const priceCell = (p.type === "CN_FUND")
        ? `
          ${p.price ?? "-"}
          <div class="mut small" style="margin-top:2px;">
            å‡€å€¼: ${(typeof p._nav === "number" ? p._nav : "-")}ï¼ˆ${p._navDate || "-"}ï¼‰
            <br/>
            ä¼°å€¼: ${(typeof p._estNav === "number" ? p._estNav : "-")}ï¼ˆ${(typeof p._estPct === "number" ? p._estPct : "-")}%ï¼‰${p._time ? " " + p._time : ""}
          </div>
        `
        : `${p.price ?? "-"}`;

      tr.innerHTML = `
        <td><span class="pill">${p.type}</span></td>
        <td>${p.code}</td>
        <td class="mut">${p.name || "-"}</td>
        <td>${priceCell}</td>
        <td>${p.mv!=null ? p.mv.toFixed(2) : "-"}</td>
        <td class="${pnlCls}">${p.pnl!=null ? p.pnl.toFixed(2) : "-"}</td>
        <td class="${pnlCls}">${p.pnlPct!=null ? p.pnlPct.toFixed(2)+"%" : "-"}</td>
        <td>${(w||0).toFixed(1)}%</td>
        <td>
          <button class="secondary" onclick="openEdit(${i})">ç¼–è¾‘</button>
          <button class="danger" onclick="deleteOne(${i})">åˆ é™¤</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    $("sum").textContent =
      `æŠ•å…¥åˆè®¡ï¼š${totalAmount.toFixed(2)} ï½œ å¸‚å€¼åˆè®¡ï¼š${totalMV.toFixed(2)} ï½œ æ€»ç›ˆäºï¼š${totalPNL.toFixed(2)}`;
  }

  async function refreshAll(){
    const base = localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND;
    const api = base.replace(/\/+$/,"");

    // å›½å†…åŸºé‡‘
    for (const p of window.positions){
      if (p.type === "CN_FUND"){
        const r = await fetch(`${api}/api/cn/fund/${encodeURIComponent(p.code)}`);
        const j = await r.json();
        p.name = j.name || p.name;
        p.price = (typeof j.nav === "number" && j.nav > 0) ? j.nav : j.estNav;
        p._nav = (typeof j.nav === "number") ? j.nav : null;
        p._navDate = j.navDate || null;
        p._estNav = (typeof j.estNav === "number") ? j.estNav : null;
        p._estPct = (typeof j.estPct === "number") ? j.estPct : null;
        p._time = j.time || null;
      }
    }

    // æµ·å¤–ï¼šæ‰¹é‡æ‹‰
    const gl = window.positions.filter(p=>p.type==="US_TICKER");
    if (gl.length){
      const symbols = gl.map(p=>p.code).join(",");
      const r = await fetch(`${api}/api/gl/quote?symbols=${encodeURIComponent(symbols)}`);
      const j = await r.json();
      const map = new Map((j.quotes||[]).map(q=>[q.symbol, q]));
      for (const p of gl){
        const q = map.get(p.code.toUpperCase());
        if(q){
          p.name = q.name || p.name;
          p.price = q.price;
        }
      }
    }

    // è®¡ç®—å¸‚å€¼/ç›ˆäº
    for (const p of window.positions){
      if (typeof p.price === "number" && p.price > 0){
        const baseCost = (typeof p.cost === "number" && p.cost > 0) ? p.cost : p.price;
        const shares = p.amount / baseCost;
        p.mv = shares * p.price;
        p.pnl = p.mv - p.amount;
        p.pnlPct = (p.pnl / p.amount) * 100;
      } else {
        p.mv = p.pnl = p.pnlPct = null;
      }
    }

    persist(); render();
  }

  // ---------- NEWS ----------
  function renderThemes(themes){
    $("themes").textContent = themes && themes.length ? themes.join(" / ") : "ï¼ˆå°šæœªç”Ÿæˆï¼‰";
  }

  async function buildNewsPlan(){
    const base = localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND;
    const api = base.replace(/\/+$/,"");

    const payload = window.positions.map(p=>({
      type:p.type, code:p.code, name:p.name, amount:p.amount, mv:p.mv
    }));

    const r = await fetch(`${api}/api/news/plan`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ positions: payload })
    });
    const j = await r.json();
    if (!j.ok) return alert("ç”Ÿæˆå…³é”®è¯å¤±è´¥ï¼š" + (j.error || ""));

    localStorage.setItem(LS.newsPlan, JSON.stringify(j));
    renderThemes(j.themes || []);

    const kw = (j.keywords || []).join(",");
    $("newsKeywords").value = kw;
    localStorage.setItem(LS.newsKeywords, kw);
    alert("âœ… å·²ç”Ÿæˆè‡ªåŠ¨å…³é”®è¯ï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹åå†æŠ“æ–°é—»ï¼‰");
  }

  function saveNewsKeywords(){
    const kw = $("newsKeywords").value.trim();
    localStorage.setItem(LS.newsKeywords, kw);
    alert("âœ… å…³é”®è¯å·²ä¿å­˜");
  }

  function resetNewsKeywords(){
    const plan = JSON.parse(localStorage.getItem(LS.newsPlan) || "null");
    if (!plan) return alert("å…ˆç‚¹â€œè‡ªåŠ¨ç”Ÿæˆå…³é”®è¯â€");
    const kw = (plan.keywords || []).join(",");
    $("newsKeywords").value = kw;
    localStorage.setItem(LS.newsKeywords, kw);
  }

  function renderNews(items){
    const box = $("newsList");
    box.innerHTML = "";
    if (!items || !items.length) {
      box.innerHTML = `<div class="mut small">æš‚æ— æ–°é—»ã€‚å…ˆç”Ÿæˆå…³é”®è¯ï¼Œå†æŠ“å–æ–°é—»ã€‚</div>`;
      return;
    }
    for (const it of items) {
      const div = document.createElement("div");
      div.className = "li";
      const sentiCls = it.sentiment==="bullish" ? "tagBull" : it.sentiment==="bearish" ? "tagBear" : "tagNeu";
      const themeTags = (it.themes||[]).slice(0,3).map(t=>`<span class="tag tagTheme">${t}</span>`).join("");
      div.innerHTML = `
        <div class="small">
          <span class="tag ${sentiCls}">${it.sentiment||"neutral"}</span>
          ${themeTags}
          <span class="tag mono">score:${it.score ?? "-"}</span>
          <span class="mut">${it.pubDate || ""}</span>
        </div>
        <div style="margin-top:6px;"><a href="${it.link}" target="_blank" rel="noreferrer">${it.title}</a></div>
        <div class="mut small" style="margin-top:6px;">${(it.description || "").slice(0, 180)}</div>
        <div class="mut small" style="margin-top:6px;">å…³é”®è¯ï¼š${it.keyword||"-"}</div>
      `;
      box.appendChild(div);
    }
  }

  async function fetchNews(){
    const base = localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND;
    const api = base.replace(/\/+$/,"");

    const kw = (localStorage.getItem(LS.newsKeywords) || $("newsKeywords").value || "").trim();
    if (!kw) return alert("å…ˆç”Ÿæˆæˆ–å¡«å†™å…³é”®è¯");

    $("newsList").innerHTML = `<div class="mut small">æŠ“å–ä¸­â€¦</div>`;

    const plan = JSON.parse(localStorage.getItem(LS.newsPlan) || "null");
    const weights = plan && plan.weights ? JSON.stringify(plan.weights) : "";
    const url = `${api}/api/news/rss?keywords=${encodeURIComponent(kw)}&limit=18&minScore=2${weights?`&weights=${encodeURIComponent(weights)}`:""}`;

    const r = await fetch(url);
    const j = await r.json();
    if (!j.ok) return alert("æŠ“å–æ–°é—»å¤±è´¥ï¼š" + (j.error || ""));

    localStorage.setItem(LS.newsCache, JSON.stringify(j));
    renderNews(j.items || []);
  }

  // ---------- RISK ----------
  async function refreshRisk(){
    const base = localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND;
    const api = base.replace(/\/+$/,"");

    const payload = window.positions.map(p=>({
      type:p.type, code:p.code, name:p.name, amount:p.amount, mv:p.mv
    }));
    const r = await fetch(`${api}/api/risk/check`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ positions: payload })
    });
    const j = await r.json();
    if (!j.ok) return alert("é£æ§æ£€æŸ¥å¤±è´¥ï¼š" + (j.error||""));

    localStorage.setItem(LS.riskCache, JSON.stringify(j));
    renderRisk(j);
  }

  function renderRisk(j){
    $("riskLevel").textContent = j.riskLevel || "-";
    $("riskSuggest").textContent = (j.suggestTotalPct!=null ? j.suggestTotalPct+"%" : "-");
    $("riskTheme").textContent = (j.topTheme?.theme ? `${j.topTheme.theme} ${j.topTheme.pct}%` : "-");
    $("riskTz").textContent = j.tz || "-";

    const issues = $("riskIssues");
    issues.innerHTML = "";
    (j.issues||[]).forEach(x=>{
      const div = document.createElement("div");
      div.className = "li";
      const lvl = x.level==="é«˜" ? "tagBear" : x.level==="ä¸­" ? "tagNeu" : "tagBull";
      div.innerHTML = `<span class="tag ${lvl}">é£æ§ ${x.level}</span> <span class="small">${x.text}</span>`;
      issues.appendChild(div);
    });

    const bk = $("riskBreakdown");
    bk.innerHTML = "";
    (j.themeBreakdown||[]).forEach(x=>{
      const div = document.createElement("div");
      div.className = "li";
      div.innerHTML = `<span class="tag tagTheme">${x.theme}</span> <span class="small">å æ¯” ${x.pct}%</span>`;
      bk.appendChild(div);
    });
  }

  // ---------- TECH ----------
  function clearTechCache(){
    localStorage.removeItem(LS.techCache);
    $("techList").innerHTML = `<div class="mut small">å·²æ¸…ç©ºæŠ€æœ¯ç¼“å­˜ã€‚</div>`;
  }

  function clearSectorCache(){
    localStorage.removeItem(LS.sectorCache);
    sectorData = null;
    $("sectorStatus").textContent = "å·²æ¸…ç©ºæ¿å—ç¼“å­˜ã€‚";
    $("sectorTop").innerHTML = "";
    $("sectorAll").innerHTML = "";
  }

  async function refreshTech(){
    const base = localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND;
    const api = base.replace(/\/+$/,"");

    const payload = window.positions.map(p=>({
      type:p.type, code:p.code, name:p.name, amount:p.amount, mv:p.mv
    }));

    $("techList").innerHTML = `<div class="mut small">è®¡ç®—ä¸­â€¦ï¼ˆé¦–æ¬¡å¯èƒ½ç¨æ…¢ï¼‰</div>`;

    const r = await fetch(`${api}/api/tech/batch`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ positions: payload })
    });
    const j = await r.json();
    if (!j.ok) return alert("æŠ€æœ¯æŒ‡æ ‡å¤±è´¥ï¼š" + (j.error||""));

    localStorage.setItem(LS.techCache, JSON.stringify(j));
    renderTech(j);
  }

  function renderTech(j){
    const box = $("techList");
    box.innerHTML = "";
    const items = j.items || [];
    if (!items.length) {
      box.innerHTML = `<div class="mut small">æš‚æ— æŠ€æœ¯æŒ‡æ ‡æ•°æ®ã€‚</div>`;
      return;
    }

    for (const it of items) {
      const div = document.createElement("div");
      div.className = "li";

      if (!it.ok) {
        div.innerHTML = `
          <div><b>${it.code || it.symbol || "-"}</b> <span class="mut">${it.name || ""}</span> <span class="pill">${it.type||""}</span></div>
          <div class="mut small">æš‚æ— æ•°æ®ï¼ˆ${it.reason || "unknown"}ï¼Œcount=${it.count ?? 0}ï¼‰</div>
        `;
        box.appendChild(div);
        continue;
      }
      const trend = it.trend || deriveTrend(it);
      const rsiTag = it.rsiTag || deriveRsiTag(it);

      const trendCls = trend==="ä¸Šè¡Œ" ? "tagBull" : trend==="ä¸‹è¡Œ" ? "tagBear" : "tagNeu";
      const rsiCls   = rsiTag==="RSIåçƒ­" ? "tagBear" : rsiTag==="RSIåå†·" ? "tagBull" : "tagNeu";

      div.innerHTML = `
        <div>
          <b>${it.code || it.symbol}</b>
          <span class="mut">${it.name || ""}</span>
          <span class="pill">${it.type || ""}</span>
          ${tagHtml(trend, trendCls)}
          ${tagHtml(rsiTag, rsiCls)}
        </div>
        <div class="mut small mono" style="margin-top:6px;">
          last=${fmt(it.last)} |
          SMA20=${fmt(it.sma20)} |
          SMA60=${fmt(it.sma60)} |
          RSI14=${fmt(it.rsi14)} |
          MACD=${fmt(it.macd)} |
          Hist=${fmt(it.hist)} |
          ret20=${fmt(it.ret20)}%
        </div>
      `;
      box.appendChild(div);
    }
  }

  function fmt(x){
    if (typeof x !== "number") return "-";
    return (Math.abs(x) >= 10 ? x.toFixed(2) : x.toFixed(4));
  }

// ---------- HTTP helper (å¸¦è¶…æ—¶ï¼Œé¿å…ä¸€ç›´ pending) ----------
async function fetchJsonTimeout(url, opts={}, timeoutMs=90000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);

  // å¦‚æœå¤–éƒ¨ä¹Ÿä¼ äº† signalï¼ˆç”¨äºâ€œåœæ­¢æ‰«æâ€ï¼‰ï¼Œå°±è”åŠ¨ä¸­æ­¢
  const ext = opts && opts.signal;
  let extAbortHandler = null;
  if (ext) {
    extAbortHandler = () => ctrl.abort();
    try { ext.addEventListener("abort", extAbortHandler, { once:true }); } catch {}
  }

  try{
    const r = await fetch(url, { ...opts, signal: ctrl.signal });
    const text = await r.text();
    let j = null;
    try{ j = JSON.parse(text); }catch{ j = { ok:false, error:"non-json", head: text.slice(0,200) }; }
    if (!r.ok && j && j.ok !== false) j = { ok:false, error:`HTTP ${r.status}`, detail:j };
    return j;
  }catch(e){
    throw new Error(e && e.name==="AbortError" ? `è¯·æ±‚è¶…æ—¶/å·²ä¸­æ­¢ï¼ˆ>${Math.round(timeoutMs/1000)}sï¼‰` : String(e));
  }finally{
    clearTimeout(t);
    if (ext && extAbortHandler) {
      try { ext.removeEventListener("abort", extAbortHandler); } catch {}
    }
  }
}

  // ---------- SECTOR ----------
  // ---------- SECTORï¼ˆåˆ†æ‰¹æ‰«æï¼šæ¯æ‰¹ 5 ä¸ªï¼Œæ¯ 70 ç§’ç»§ç»­ï¼Œé¿å… AlphaVantage å…è´¹é™æµï¼‰ ----------
let sectorScanCtrl = null;

async function refreshSectors(){
  const statusEl = $("sectorStatus");

  // å†ç‚¹ä¸€æ¬¡ï¼šåœæ­¢æ‰«æ
  if (sectorScanCtrl) {
    sectorScanCtrl.abort();
    sectorScanCtrl = null;
    statusEl.textContent = "å·²åœæ­¢æ‰«æã€‚";
    return;
  }

  const base = localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND;
  const api = base.replace(/\/+$/,"");

  // â€”â€” å…ˆå±•ç¤ºç¼“å­˜ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œä½†ä¸â€œé™é»˜ç»“æŸâ€ï¼Œä¼šæ˜ç¡®æç¤ºç”¨æˆ·ä¸‹ä¸€æ­¥æ€ä¹ˆåš â€”â€” 
  const cached = JSON.parse(localStorage.getItem(LS.sectorCache) || "null");
  const fresh = cached && cached._savedAt && (Date.now() - cached._savedAt) < UI_CACHE_TTL_MS && !cached._hasFailures;

  // ç¬¬ä¸€æ¬¡ç‚¹ï¼šå¦‚æœæœ‰æ–°é²œç¼“å­˜ï¼Œå…ˆç›´æ¥ç”¨ç¼“å­˜ï¼Œæç¤ºâ€œå†ç‚¹ä¸€æ¬¡å¼ºåˆ¶é‡æ–°æ‰«æâ€
  if (fresh && !window.__sectorForceRefresh) {
    sectorData = cached;
    renderSectors();
    const mins = Math.round((Date.now() - cached._savedAt)/60000);
    statusEl.textContent = `å·²ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆ${mins} åˆ†é’Ÿå‰ï¼‰ã€‚å¦‚éœ€å¼ºåˆ¶é‡æ–°æ‰«æï¼šå†ç‚¹ä¸€æ¬¡â€œåˆ·æ–°æ¿å—åŠ¨å‘â€ã€‚`;
    window.__sectorForceRefresh = true;
    return;
  }
  window.__sectorForceRefresh = false;

  // å¼€å§‹åˆ†æ‰¹æ‰«æ
  sectorScanCtrl = new AbortController();
  const batchSize = 1; // æ¯æ‰¹1ä¸ªï¼Œé¿å…è§¦å‘å…è´¹é™æµ
  const intervalMs = 15000; // 15ç§’/åªï¼ˆå…è´¹é¢åº¦æ›´ç¨³ï¼‰
  const total = SECTOR_ETFS.length;

  // å¦‚æœå·²æœ‰æ—§ç»“æœï¼Œå…ˆæ¸²æŸ“å‡ºæ¥ï¼ˆè®©ä½ çœ‹åˆ°â€œå®ƒåœ¨å·¥ä½œâ€ï¼‰
  if (cached && cached.items) {
    sectorData = cached;
    renderSectors();
  }

  statusEl.textContent = `å¼€å§‹åˆ†æ‰¹æ‰«æâ€¦ 0/${total}ï¼ˆæ¯æ¬¡æ‰«1åªï¼›çº¦${Math.ceil(total*intervalMs/1000/60)}åˆ†é’Ÿå®Œæˆï¼›å†æ¬¡ç‚¹å‡»å¯åœæ­¢ï¼‰`;

  const merged = new Map();
  // å…ˆæŠŠå·²æœ‰ç¼“å­˜å¡è¿› mergedï¼ˆç»­æ‰«ï¼‰
  if (cached && Array.isArray(cached.items)) {
    for (const it of cached.items) {
      if (it && it.symbol) merged.set(it.symbol, it);
    }
  }

  async function waitWithCountdown(ms){
    const start = Date.now();
    while (Date.now() - start < ms) {
      if (sectorScanCtrl?.signal?.aborted) throw new Error("aborted");
      const left = Math.max(0, ms - (Date.now() - start));
      statusEl.textContent = `å·²å®Œæˆ ${Math.min(merged.size,total)}/${total}ï¼Œç­‰å¾… ${Math.ceil(left/1000)} ç§’åç»§ç»­â€¦ï¼ˆå†æ¬¡ç‚¹å‡»å¯åœæ­¢ï¼‰`;
      await new Promise(r=>setTimeout(r, 1000));
    }
  }

  try{
    let done = 0;

    for (let i=0; i<total; i+=batchSize){
      if (sectorScanCtrl.signal.aborted) throw new Error("aborted");

      const batch = SECTOR_ETFS.slice(i, i+batchSize);
      statusEl.textContent = `æ‰«æä¸­â€¦ ${done}/${total}ï¼ˆæœ¬æ‰¹ ${i+1}-${Math.min(i+batchSize,total)}ï¼‰`;

      const j = await fetchJsonTimeout(`${api}/api/sector/scan`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ items: batch }),
        signal: sectorScanCtrl.signal,
      }, 20000);

      if (j && j.ok === true) {
        (j.items || []).forEach(it => {
          if (it && it.symbol) merged.set(it.symbol, it);
        });

        const all = Array.from(merged.values());
        const okOnes = all.filter(x => x && x.ok);
        okOnes.sort((a,b)=>(b.score??-999)-(a.score??-999));
        const top = okOnes.slice(0, 3);

        sectorData = { ok:true, build: j.build, tz: j.tz, top, items: all };
        renderSectors();
        const failCnt2 = all.filter(x => x && x.ok===false).length;
        localStorage.setItem(LS.sectorCache, JSON.stringify({ ...sectorData, _savedAt: Date.now(), _hasFailures: failCnt2>0 }));
      } else {
        const msg = j?.error || j?.reason || "unknown";
        statusEl.textContent = `æœ¬æ‰¹å¤±è´¥ï¼š${msg}ï¼ˆå°†ç»§ç»­ä¸‹ä¸€æ‰¹ï¼‰`;
      }

      done = Math.min(total, i + batch.length);

      if (done >= total) break;

      // æé†’ï¼šå¦‚æœä½ åˆšåˆ·æ–°è¿‡æŠ€æœ¯æŒ‡æ ‡ï¼Œå»ºè®®ç­‰ 1 åˆ†é’Ÿå†æ‰«æ¿å—ï¼ˆå‡å°‘é™æµï¼‰
      await waitWithCountdown(intervalMs);
    }

        // è‡ªåŠ¨é‡è¯•ï¼šå¦‚æœæœ‰å¤±è´¥é¡¹ï¼ˆå¤šä¸º AlphaVantage é™æµï¼‰ï¼Œå†·å´åå†è¡¥æ‰« 1-2 è½®
    const maxRetryPasses = 2;
    const retryBatchSize = 3;
    const retryIntervalMs = 70000;

    for (let pass = 1; pass <= maxRetryPasses; pass++) {
      const todoSyms = SECTOR_ETFS
        .map(x => x.symbol)
        .filter(sym => {
          const r = merged.get(sym);
          return !r || r.ok !== true;
        });

      if (!todoSyms.length) break;

      statusEl.textContent = `å‘ç° ${todoSyms.length} ä¸ªå¤±è´¥é¡¹ï¼Œå†·å´åè‡ªåŠ¨é‡è¯•ï¼ˆç¬¬ ${pass}/${maxRetryPasses} è½®ï¼‰â€¦`;
      await waitWithCountdown(retryIntervalMs);

      for (let k = 0; k < todoSyms.length; k += retryBatchSize) {
        if (sectorScanCtrl.signal.aborted) throw new Error("aborted");
        const chunkSyms = todoSyms.slice(k, k + retryBatchSize);
        const batch = SECTOR_ETFS.filter(x => chunkSyms.includes(x.symbol));

        statusEl.textContent = `é‡è¯•ä¸­ï¼ˆç¬¬ ${pass} è½®ï¼‰â€¦ ${k + 1}-${Math.min(k + retryBatchSize, todoSyms.length)}/${todoSyms.length}`;

        const j = await fetchJsonTimeout(`${api}/api/sector/scan`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items: batch }),
          signal: sectorScanCtrl.signal,
        }, 20000);

        if (j && j.ok === true) {
          (j.items || []).forEach(it => {
            if (it && it.symbol) merged.set(it.symbol, it);
          });

          const all = Array.from(merged.values());
          const okOnes = all.filter(x => x && x.ok);
          okOnes.sort((a, b) => (b.score ?? -999) - (a.score ?? -999));
          const top = okOnes.slice(0, 3);

          sectorData = { ok: true, build: j.build, tz: j.tz, top, items: all };
          renderSectors();
          const failCnt2 = all.filter(x => x && x.ok===false).length;
          localStorage.setItem(LS.sectorCache, JSON.stringify({ ...sectorData, _savedAt: Date.now(), _hasFailures: failCnt2>0 }));
        }

        // é‡è¯•é—´éš”ï¼ˆé¿å…å†æ¬¡è§¦å‘é™æµï¼‰
        if (k + retryBatchSize < todoSyms.length) {
          await waitWithCountdown(retryIntervalMs);
        }
      }
    }

    const allFinal = Array.from(merged.values());
    const failCnt = allFinal.filter(x => x && x.ok === false).length;
    statusEl.textContent = failCnt
      ? `æ‰«æå®Œæˆ âœ… ${Math.min(merged.size, total)}/${total}ï¼ˆä»æœ‰ ${failCnt} ä¸ªå¤±è´¥ï¼šå¤šä¸ºæ•°æ®æºé™æµï¼Œå¯ç¨åå†ç‚¹â€œåˆ·æ–°æ¿å—åŠ¨å‘â€é‡è¯•ï¼‰`
      : `æ‰«æå®Œæˆ âœ… ${Math.min(merged.size, total)}/${total}ï¼ˆç»“æœå·²ç¼“å­˜ 6 å°æ—¶ï¼‰`;
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    statusEl.textContent = (msg==="aborted") ? "å·²åœæ­¢æ‰«æã€‚" : `æ‰«æä¸­æ–­/å¤±è´¥ï¼š${msg}`;
  }finally{
    sectorScanCtrl = null;
  }
}

  function renderSectors(){
    const data = sectorData;
    if (!data) return;

    // top
    const topBox = $("sectorTop");
    topBox.innerHTML = "";
    const top = data.top || [];
    if (!top.length) {
      topBox.innerHTML = `<div class="mut small">æš‚æ— å¯ç”¨ç»“æœï¼ˆå¯èƒ½ä¸Šæ¸¸å†å²æ•°æ®ä¸ºç©ºï¼‰ã€‚</div>`;
    } else {
      top.forEach(it => topBox.appendChild(sectorItemDiv(it)));
    }

    // all (search filter)
    const key = ($("sectorSearch").value || "").trim().toLowerCase();
    const allBox = $("sectorAll");
    allBox.innerHTML = "";

    const items = (data.items || []).slice();
    const filtered = key
      ? items.filter(x =>
          (x.theme||"").toLowerCase().includes(key) ||
          (x.symbol||"").toLowerCase().includes(key) ||
          (x.name||"").toLowerCase().includes(key)
        )
      : items;

    if (!filtered.length) {
      allBox.innerHTML = `<div class="mut small">æ— åŒ¹é…ç»“æœã€‚</div>`;
      return;
    }

    filtered.forEach(it => allBox.appendChild(sectorItemDiv(it)));
  }

  function sectorItemDiv(it){
    const div = document.createElement("div");
    div.className = "li";

    if (!it.ok) {
      div.innerHTML = `
        <div>
          <span class="tag tagTheme">${it.theme||"æœªåˆ†ç±»"}</span>
          <b class="mono">${it.symbol||"-"}</b>
          <span class="mut">${it.name||""}</span>
        </div>
        <div class="mut small">æš‚æ— æ•°æ®ï¼ˆ${it.reason||"unknown"}ï¼Œcount=${it.count ?? 0}ï¼‰</div>
      `;
      return div;
    }
    const trend = it.trend || deriveTrend(it);
    const rsiTag = it.rsiTag || deriveRsiTag(it);

    const trendCls = trend==="ä¸Šè¡Œ" ? "tagUp" : trend==="ä¸‹è¡Œ" ? "tagDown" : "tagNeu";
    const rsiCls   = rsiTag==="RSIåçƒ­" ? "tagBear" : rsiTag==="RSIåå†·" ? "tagBull" : "tagNeu";
    const momoCls  = (typeof it.ret20==="number" && it.ret20>=2) ? "tagUp"
                    : (typeof it.ret20==="number" && it.ret20<=-2) ? "tagDown" : "tagNeu";

    div.innerHTML = `
      <div>
        <span class="tag tagTheme">${it.theme}</span>
        <b class="mono">${it.symbol}</b>
        <span class="mut">${it.name||""}</span>
        ${tagHtml(trend, trendCls)}
        <span class="tag ${momoCls}">åŠ¨é‡${(typeof it.ret20==="number"?it.ret20.toFixed(2):"-")}%</span>
        ${tagHtml(rsiTag, rsiCls)}
        <span class="tag mono">scoreâ‰ˆ${it.score ?? "-"}</span>
      </div>
      <div class="mut small mono" style="margin-top:6px;">
        last=${fmt(it.last)} | RSI14=${fmt(it.rsi14)} | ret20=${fmt(it.ret20)}%
      </div>
    `;
    return div;
  }

  // ---------- AI ----------
  function saveAI(){
    const cfg = { baseUrl:$("aiBase").value.trim(), apiKey:$("aiKey").value.trim(), model:$("aiModel").value.trim() };
    localStorage.setItem(LS.ai, JSON.stringify(cfg));
    $("aiOut").value = "âœ… AI é…ç½®å·²ä¿å­˜ï¼ˆä»…æœ¬æœºï¼‰ã€‚";
  }

  async function runAI(){
    const base = localStorage.getItem(LS.backend) || $("backend").value.trim() || DEFAULT_BACKEND;
    const api = base.replace(/\/+$/,"");

    const cfg = JSON.parse(localStorage.getItem(LS.ai) || "{}");
    if(!cfg.baseUrl || !cfg.apiKey || !cfg.model) return alert("å…ˆå¡«å†™ AI BaseUrl / Key / Model å¹¶ä¿å­˜");

    // å…ˆç¡®ä¿ï¼šä»·æ ¼/ç›ˆäºæœ€æ–°
    await refreshAll();

    // å–æŒä»“
    const holdings = window.positions.map(p=>({
      type:p.type, code:p.code, name:p.name, amount:p.amount, cost:p.cost,
      price:p.price, mv:p.mv, pnl:p.pnl, pnlPct:p.pnlPct,
      nav:p._nav, navDate:p._navDate, estNav:p._estNav, estPct:p._estPct, time:p._time
    }));

    // æ–°é—»ç¼“å­˜
    const newsCache = JSON.parse(localStorage.getItem(LS.newsCache) || "null");
    const newsItems = (newsCache && newsCache.items) ? newsCache.items : [];

    // é£æ§ç¼“å­˜
    const risk = JSON.parse(localStorage.getItem(LS.riskCache) || "null");

    // æŠ€æœ¯ç¼“å­˜
    const tech = JSON.parse(localStorage.getItem(LS.techCache) || "null");

    // æ¿å—ç¼“å­˜
    const sectors = JSON.parse(localStorage.getItem(LS.sectorCache) || "null");

    const messages = [
      { role:"system", content:
`ä½ æ˜¯ä¸¥æ ¼çš„ç»„åˆé£æ§ä¸æ“ä½œå»ºè®®åŠ©æ‰‹ã€‚ä¸è¦ç¼–é€ æ•°æ®ã€‚
ä½ å¿…é¡»ä¼˜å…ˆä½¿ç”¨æˆ‘æä¾›çš„ï¼šæŒä»“/æ–°é—»/é£æ§/æŠ€æœ¯æŒ‡æ ‡/æ¿å—åŠ¨å‘æ•°æ®ã€‚
å¿…é¡»è¾“å‡ºå››éƒ¨åˆ†ï¼š
1) ç»„åˆé£é™©ç­‰çº§ï¼ˆä½/ä¸­/é«˜ï¼‰+ æ€»ä»“ä½å»ºè®®ï¼ˆä¾‹å¦‚70%ï¼‰
2) æ¯åªæŒä»“ï¼šä»Šæ—¥åŠ¨ä½œï¼ˆä¹°/å–/ä¸åŠ¨ï¼‰+ä¸€å¥ç†ç”±ï¼ˆå¼•ç”¨é£æ§/æŠ€æœ¯/æ–°é—»ï¼‰
3) æ–°é—»/æ”¿ç­–å½±å“ï¼šä»æä¾›çš„æ–°é—»ä¸­æç‚¼3-5æ¡è¦ç‚¹ï¼Œå¹¶æŒ‡å‡ºå¯¹æ¯ä¸ªä¸»é¢˜/æŒä»“çš„æ½œåœ¨å½±å“ï¼ˆåˆ©å¥½/åˆ©ç©º/ä¸ç¡®å®šï¼‰
4) æœªæ¥3-6ä¸ªæœˆï¼šæœ€çœ‹å¥½æ¿å—Top1 + æ¨èåŸºé‡‘/ETFä»£ç  + åŸå› ï¼ˆç»“åˆæ¿å—åŠ¨å‘ä¸æ–°é—»ï¼‰
æ³¨æ„ï¼šä¸è¦ç»™å‡ºç»å¯¹åŒ–æ‰¿è¯ºï¼Œå¼ºè°ƒé£é™©ä¸æ¡ä»¶ã€‚`
      },
      { role:"user", content:
`ã€æŒä»“ä¸ç›ˆäºï¼ˆJSONï¼‰ã€‘\n${JSON.stringify(holdings, null, 2)}\n\nã€é£æ§æ£€æŸ¥ï¼ˆJSONï¼‰ã€‘\n${JSON.stringify(risk, null, 2)}\n\nã€æŠ€æœ¯æŒ‡æ ‡ï¼ˆJSONï¼‰ã€‘\n${JSON.stringify(tech, null, 2)}\n\nã€æ¿å—åŠ¨å‘ï¼ˆJSONï¼‰ã€‘\n${JSON.stringify(sectors, null, 2)}\n\nã€æ–°é—»ï¼ˆJSONï¼Œæœ€å¤š18æ¡ï¼‰ã€‘\n${JSON.stringify(newsItems, null, 2)}\n\nè¯·æŒ‰è¦æ±‚è¾“å‡ºï¼Œæ ¼å¼æ¸…æ™°ã€‚`
      }
    ];

    $("aiOut").value = "ç”Ÿæˆä¸­â€¦";

    const r = await fetch(`${api}/api/ai/chat`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ baseUrl: cfg.baseUrl, apiKey: cfg.apiKey, model: cfg.model, messages })
    });

    const text = await r.text();
    try{
      const j = JSON.parse(text);
      $("aiOut").value = j?.choices?.[0]?.message?.content || text;
    }catch{
      $("aiOut").value = text;
    }
  }

  load();
</script>
</body>
</html>
